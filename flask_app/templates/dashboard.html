{% extends "base.html" %}

{% block title %}raqibtech.com Customer Support - How can we help you?{% endblock %}

{% block content %}

<!-- Enhanced Floating Modal Chat System with Microsoft-style Design -->
<style>
/* ===== FLOATING CHAT MODAL SYSTEM ===== */
/* Floating Chat Button - Now Draggable */
.floating-chat-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-dark));
    border-radius: 50%;
    box-shadow: 0 8px 32px rgba(46, 204, 113, 0.3);
    border: none;
    cursor: grab;
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: scale(1);
    pointer-events: auto;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    outline: none;
}

.floating-chat-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 40px rgba(46, 204, 113, 0.4);
    background: linear-gradient(135deg, var(--brand-primary-dark), var(--brand-primary));
}

.floating-chat-btn:active,
.floating-chat-btn.dragging {
    transform: scale(0.95);
    cursor: grabbing;
    box-shadow: 0 20px 60px rgba(46, 204, 113, 0.5);
}

.floating-chat-btn.active {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    transform: rotate(45deg) scale(1.1);
}

/* Chat Modal Overlay */
.chat-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 9999;
    display: none;
    opacity: 0;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
}

.chat-modal-overlay.active {
    display: flex;
    opacity: 1;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
}

/* Main Chat Modal Container */
.chat-modal {
    width: 400px;
    height: 600px;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: scale(0.9) translateY(50px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    pointer-events: auto;
}

.chat-modal-overlay.active .chat-modal {
    transform: scale(1) translateY(0);
}

/* Modal Header - Updated with Brand Colors */
.chat-modal-header {
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-dark));
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 10px rgba(46, 204, 113, 0.2);
}

.chat-modal-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.chat-modal-title .brand-logo {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.chat-modal-title .brand-logo img {
    width: 22px;
    height: 22px;
}

.chat-modal-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.chat-modal-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.chat-modal-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
}

/* Conversation Sidebar */
.conversation-sidebar {
    position: absolute;
    left: -300px;
    top: 0;
    width: 300px;
    height: 100%;
    background: #f8f9fa;
    border-right: 1px solid #e9ecef;
    z-index: 10;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.conversation-sidebar.active {
    transform: translateX(300px);
}

.conversation-sidebar-header {
    padding: 16px;
    background: #ffffff;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.conversation-sidebar-title {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

/* Sidebar overlay effect when open */
.chat-modal.sidebar-open::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 5;
    pointer-events: none;
}

.conversation-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

/* Chat Messages Area */
/* .chat-modal-messages {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 100%;
} */

.chat-modal-messages {
    flex: 1;
    padding: 24px 0 0 0; /* Add top padding to prevent messages from touching navbar */
    overflow-y: auto;
    background: #f8f9fa; /* White background like ChatGPT */
    display: flex;
    flex-direction: column;
    gap: 0; /* No gaps - messages touch each other */
    max-width: 100%;
}

/* ===== WELCOME PAGE STYLES ===== */
.welcome-page {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    height: 100%;
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.welcome-page .brand-logo-large {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: white;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(24, 188, 156, 0.3);
}

.welcome-page h2 {
    font-size: 22px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.welcome-page p {
    font-size: 14px;
    color: #576574;
    margin-bottom: 24px;
    line-height: 1.6;
    max-width: 300px;
}

.welcome-quick-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 280px;
}

.welcome-quick-actions .quick-action-btn {
    background: #ffffff;
    color: #2c3e50;
    border: 1px solid #e0e0e0;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.welcome-quick-actions .quick-action-btn:hover {
    background: #f8f9fa;
    border-color: #ced4da;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.welcome-quick-actions .quick-action-btn i {
    color: #18bc9c;
    font-size: 16px;
}

/* Message Bubbles - Microsoft Fluent Style */
/* .message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
} */

 .message {
    display: flex;
    flex-direction: column;
    animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    margin-bottom: 24px; /* More spacing between messages like ChatGPT */
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.customer {
    align-items: flex-end; /* Align the entire message to the right */
    margin-left: auto; /* Push message container to the right */
    max-width: 80%; /* Limit width like ChatGPT */
}

/* .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
} */

/* .message.ai .message-avatar {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    margin-right: 10px;
    margin-top: 8px;
    padding: 10px;
}

.message.customer .message-avatar {
    background: linear-gradient(135deg, #18bc9c, #16a085);
    color: white;
    margin-left: 10px;
    margin-top: 8px;
} */

/* .message.customer .message-content {
    display: flex;
    flex-direction: row-reverse;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
} */

/* .message-content {
    max-width: calc(100% - 60px);
    flex: 1;
} */

.message-content {
    max-width: 100%;
    width: 100%;
    flex: 1;
}

.message-bubble {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 16px;
    padding: 16px 20px; /* More padding like ChatGPT */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    font-size: 13.5x; /* Slightly larger font */
    line-height: 1.6; /* Better line height */
    word-wrap: break-word;
    position: relative;
    white-space: pre-wrap; /* Preserve whitespace formatting */
    width: 100%; /* Full width within container */
    box-sizing: border-box;
}

/* Enhanced AI Message Formatting */
.message.ai .message-bubble {
    background: #f8f9fa;
    /* border: 1px solid #dee2e6;
    line-height: 1.6;
    white-space: normal; */

    border: none;
    border-radius: 0; /* Remove border radius for full width */
    padding: 24px; /* ChatGPT-style padding */
    margin: 0; /* No margins for full width */
    width: 100%;
    box-sizing: border-box;
    box-shadow: none;
    line-height: 1.6;
    white-space: normal;
}

.message.ai .message-bubble br {
    line-height: 1.8; /* Extra space between lines */
}

/* Better spacing for structured AI responses */
.message.ai .message-bubble p {
    margin: 8px 0;
}

/* ðŸ†• Ensure tables flow inline with text */
.message.ai .message-bubble .ai-table-container {
    margin: 6px 0; /* Tighter integration with text content */
}

.message.ai .message-bubble ul,
.message.ai .message-bubble ol {
    margin: 4px 0 4px 16px;
    padding-left: 0;
}

.message.ai .message-bubble li {
    margin: 1px 0;
    line-height: 1.4;
}

/* ðŸ†• AI Response Table Styles */
.ai-table-container {
    margin: 8px 0; /* Reduced margin for inline appearance */
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
}

.ai-response-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    line-height: 1.4;
    margin: 0;
}

.ai-response-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.ai-response-table th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none;
    white-space: nowrap;
}

.ai-response-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f3f4;
    vertical-align: top;
    color: #2c3e50;
}

.ai-response-table tbody tr:hover {
    background: #f8f9fa;
    transition: background-color 0.2s ease;
}

.ai-response-table tbody tr:last-child td {
    border-bottom: none;
}

/* Nigerian Naira (â‚¦) symbol styling in tables */
.ai-response-table td:contains('â‚¦') {
    font-weight: 500;
    color: var(--brand-primary);
}

/* Status indicators in tables */
.ai-response-table td {
    position: relative;
}

/* ðŸ†• Enhanced Table Cell Formatting */
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.status-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-info {
    background: #cce7ff;
    color: #004085;
    border: 1px solid #abd7ff;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.amount-highlight {
    font-weight: 600;
    color: var(--brand-primary);
    background: rgba(46, 204, 113, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
}

.payment-method {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-weight: 500;
    color: #495057;
}

/* Responsive table for mobile */
@media (max-width: 768px) {
    .ai-table-container {
        margin: 6px -24px; /* Reduced margin, extend to edges on mobile */
        border-radius: 0;
        border-left: none;
        border-right: none;
    }

    .ai-response-table th,
    .ai-response-table td {
        padding: 8px 12px;
        font-size: 12px;
    }

    .ai-response-table th {
        font-size: 11px;
    }

    .status-badge {
        padding: 2px 6px;
        font-size: 10px;
    }

    .amount-highlight {
        padding: 1px 4px;
        font-size: 11px;
    }
}

/* Customer message bubble adjustments */
.message.customer .message-bubble {
    max-width: fit-content; /* Adjust to content width */
    margin-left: auto; /* Push bubble to the right */
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-dark));
    color: white;
    border-color: var(--brand-primary);
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2);
}
.message.customer .message-bubble {
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-dark));
    color: white;
    border-color: var(--brand-primary);
}

.message:last-child .message-bubble {
    border-bottom: none;
}

/* Hide customer message timestamp */
.message.customer .message-meta {
    display: none;
}

/* .message-meta {
    margin-top: 4px;
    font-size: 11px;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
} */
.message-meta {
    margin-top: 8px;
    font-size: 11px;
    color: #6c757d;
    display: flex;
    justify-content: flex-start; /* Always align left */
    align-items: center;
    padding: 0 24px; /* Match bubble padding */
}

.response-time {
    font-size: 10px;
    color: var(--brand-primary);
    background: rgba(46, 204, 113, 0.1);
    padding: 2px 6px;
    border-radius: 8px;
    white-space: nowrap;
}

/* Welcome Message - Enhanced */
/* .message.welcome .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    color: white;
    border: none;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
} */
.message.welcome .message-bubble {
    background: #f7f7f8; /* Match AI message background */
    color: #000000; /* Black text */
    border: none;
    box-shadow: none;
    border-radius: 0;
    padding: 24px;
    margin: 0;
    width: 100%;
    border-bottom: 1px solid #ececf1;
    position: relative;
    overflow: visible;
}

.message.welcome .message-bubble::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(46, 204, 113, 0.1) 0%, transparent 70%);
    pointer-events: none;
    animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0.5; transform: rotate(0deg) scale(1); }
    50% { opacity: 1; transform: rotate(180deg) scale(1.05); }
}

.welcome-content {
    position: relative;
    z-index: 1;
}

.welcome-content h6 {
    font-size: 16px;
    font-weight: 700;
    color: #2C3E50;
    margin-bottom: 12px;
}

.welcome-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
}

.welcome-quick-action-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #2C3E50;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.welcome-quick-action-btn:hover {
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
    text-decoration: none;
    transform: translateY(-2px);
    border-color: #ffd700;
}

/* Smart Quick Actions */
.smart-quick-actions-container {
    margin: 12px 0;
}

.smart-quick-actions {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.quick-actions-header {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    text-align: center;
}

.quick-actions-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}

.smart-quick-action-btn {
    background: transparent; /* Removed background color */
    color: #007bff; /* Changed to blue text color */
    border: 1px solid #007bff; /* Added border for visibility */
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: none; /* Removed box shadow */
}

.smart-quick-action-btn:hover {
    background: linear-gradient(45deg, #0056b3, #004085);
    color: #fff;
    transform: translateY(-1px);
}

/* Chat Input Area */
.chat-modal-input {
    padding: 16px;
    background: #ffffff;
    border-top: 1px solid #e9ecef;
}

.chat-input-container {
    display: flex;
    gap: 8px;
    align-items: center;
}

.chat-input-container input {
    flex: 1;
    border: 1px solid #e9ecef;
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 14px;
    outline: none;
    transition: all 0.2s ease;
}

.chat-input-container input:focus {
    border-color: #18bc9c;
    box-shadow: 0 0 0 3px rgba(24, 188, 156, 0.1);
}

.chat-send-btn {
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(24, 188, 156, 0.2);
}

.chat-send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(24, 188, 156, 0.3);
}

.chat-send-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Typing Indicator */
/* .typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
} */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 24px; /* Match message padding */
    background: #f7f7f8; /* Match AI background */
    border-bottom: 1px solid #ececf1;
    width: 100%;
    box-sizing: border-box;
}

.typing-indicator span {
    color: var(--brand-primary);
    font-size: 13px;
    font-weight: 500;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--brand-primary);
    animation: typingPulse 1.4s ease-in-out infinite both;
    opacity: 0.6;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes typingPulse {
    0%, 80%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
    }
    40% {
        opacity: 1;
        transform: scale(1.2);
    }
}

/* Conversation List Items */
.conversation-item {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.conversation-item:hover {
    background: #f8f9fa;
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.conversation-item.active {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
}

.conversation-info h6 {
    font-size: 13px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0 0 4px 0;
}

.conversation-info small {
    font-size: 11px;
    color: #6c757d;
}

.conversation-actions {
    display: flex;
    align-items: center;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.conversation-item:hover .conversation-actions {
    opacity: 1;
}

.conversation-actions .btn-sm {
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 4px;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .message.ai .message-bubble,
    .message.customer .message-bubble,
    .message.welcome .message-bubble {
        padding: 16px; /* Slightly less padding on mobile */
    }

    .message-meta {
        padding: 0 16px;
    }

    .typing-indicator {
        padding: 16px;
    }

    .chat-modal {
        width: 100%;
        height: 100%;
        border-radius: 0;
        transform: translateY(100%);
    }

    .chat-modal-overlay.active .chat-modal {
        transform: translateY(0);
    }

    .conversation-sidebar {
        width: 280px;
        left: -280px;
    }

    .conversation-sidebar.active {
        transform: translateX(280px);
    }

    .floating-chat-btn {
        bottom: 16px;
        right: 16px;
        width: 56px;
        height: 56px;
        font-size: 20px;
    }
}

/* Loading States */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #18bc9c;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Hide original chat tab content */
.original-chat-content {
    display: none;
}

/* ===== ENHANCED WELCOME MESSAGE STYLES ===== */

/* AI Avatar Enhancement */
/* .ai-avatar-icon {
    font-size: 18px;
    animation: pulse 2s ease-in-out infinite;
} */

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Welcome Header */
.welcome-header {
    margin-bottom: 20px;
}

.welcome-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
    margin-bottom: 16px;
}

.brand-icon {
    font-size: 24px;
    animation: rotate 3s linear infinite;
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.brand-text .brand-title {
    font-size: 18px;
    font-weight: 700;
    margin: 0;
    color: #ffffff;
}

.brand-text .domain {
    color: #ffd700;
}

.brand-text .brand-subtitle {
    font-size: 12px;
    margin: 0;
    opacity: 0.9;
    color: #e3f2fd;
}

/* Welcome Greeting */
.welcome-greeting {
    margin-bottom: 20px;
    text-align: center;
}

.greeting-text {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.greeting-subtitle {
    font-size: 13px;
    color: #6c757d;
    line-height: 1.5;
    margin: 0;
}

/* Capabilities Grid */
.capabilities-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-bottom: 20px;
}

.capability-card {
    padding: 10px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    border: 1px solid;
}

.capability-card.primary {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-color: #2196f3;
}

.capability-card.secondary {
    background: linear-gradient(135deg, #f3e5f5, #e1bee7);
    border-color: #9c27b0;
}

.capability-card.accent {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border-color: #ff9800;
}

.capability-card.success {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    border-color: #4caf50;
}

.capability-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
}

.capability-icon {
    font-size: 18px;
    flex-shrink: 0;
    line-height: 1;
}

.capability-content h6 {
    font-size: 11px;
    font-weight: 600;
    margin: 0 0 3px 0;
    color: #2c3e50;
    line-height: 1.2;
}

.capability-content p {
    font-size: 9px;
    margin: 0;
    color: #6c757d;
    line-height: 1.3;
    word-wrap: break-word;
}

/* Platform Showcase (for guests) */
.platform-showcase {
    margin-bottom: 20px;
}

.showcase-card {
        padding: 16px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    border: 1px solid #dee2e6;
    margin-bottom: 12px;
}

.showcase-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.showcase-icon {
    font-size: 20px;
}

.showcase-header h6 {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    color: #2c3e50;
}

.showcase-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.tag {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    border: 1px solid;
}

.tag.electronics {
    background: #e3f2fd;
    color: #1976d2;
    border-color: #2196f3;
}

.tag.fashion {
    background: #fce4ec;
    color: #c2185b;
    border-color: #e91e63;
}

.tag.beauty {
    background: #f3e5f5;
    color: #7b1fa2;
    border-color: #9c27b0;
}

.tag.computing {
    background: #e8f5e8;
    color: #388e3c;
    border-color: #4caf50;
}

.tag.automotive {
    background: #fff3e0;
    color: #f57c00;
    border-color: #ff9800;
}

.tag.books {
    background: #efebe9;
    color: #5d4037;
    border-color: #795548;
}

.showcase-features {
    display: grid;
    grid-template-columns: 1fr;
    gap: 6px;
    margin-top: 12px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 8px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.feature-icon {
    font-size: 12px;
    flex-shrink: 0;
}

.feature-text {
    font-size: 9px;
    font-weight: 500;
    color: #2c3e50;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Quick Actions Section */
.quick-actions-section {
    margin-bottom: 20px;
}

.section-title {
    font-size: 13px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 12px;
    text-align: center;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.action-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 6px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border: 1px solid;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    width: 100%;
    box-sizing: border-box;
}

.action-btn.primary {
    color: #1976d2;
    border-color: #2196f3;
}

.action-btn.primary:hover {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(33, 150, 243, 0.2);
}

.action-btn.secondary {
    color: #7b1fa2;
    border-color: #9c27b0;
}

.action-btn.secondary:hover {
    background: linear-gradient(135deg, #f3e5f5, #e1bee7);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(156, 39, 176, 0.2);
}

.action-btn.accent {
    color: #f57c00;
    border-color: #ff9800;
}

.action-btn.accent:hover {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(255, 152, 0, 0.2);
}

.action-btn.success {
    color: #388e3c;
    border-color: #4caf50;
}

.action-btn.success:hover {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(76, 175, 80, 0.2);
}

.action-btn.warning {
    color: #f57c00;
    border-color: #ff9800;
}

.action-btn.warning:hover {
    background: linear-gradient(135deg, #fff8e1, #ffecb3);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(255, 152, 0, 0.2);
}

.action-btn.info {
    color: #0288d1;
    border-color: #03a9f4;
}

.action-btn.info:hover {
    background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(3, 169, 244, 0.2);
}

.action-icon {
    font-size: 12px;
    flex-shrink: 0;
}

.action-text {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Welcome Footer */
.welcome-footer {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.footer-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 12px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    text-align: center;
}

.stat-icon {
    font-size: 16px;
}

.stat-text {
    font-size: 9px;
    font-weight: 500;
    color: #6c757d;
}

.cta-section {
    margin-bottom: 12px;
}

.cta-highlight {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border: 1px solid #ff9800;
    border-radius: 8px;
}

.cta-icon {
    font-size: 16px;
}

.cta-text {
    font-size: 11px;
    font-weight: 500;
    color: #e65100;
}

.footer-cta {
    font-size: 11px;
    text-align: center;
    color: #6c757d;
    margin: 0;
}

/* Welcome Message Responsive */
@media (max-width: 480px) {
    .capabilities-grid,
    .action-grid {
        grid-template-columns: 1fr;
    }

    .showcase-features {
        grid-template-columns: 1fr;
    }

    .footer-stats {
        flex-direction: column;
        gap: 8px;
    }

    .footer-stats .stat-item {
        flex-direction: row;
        gap: 6px;
    }
}

/* Fix: Make close button visible in sidebar header */
.conversation-sidebar-header .chat-modal-btn {
    background: rgba(44, 62, 80, 0.1);
    color: #2c3e50;
    border: 1px solid rgba(44, 62, 80, 0.2);
}

.conversation-sidebar-header .chat-modal-btn:hover {
    background: rgba(44, 62, 80, 0.2);
    color: #2c3e50;
}

    .btn:disabled {
        opacity: 0.6;
    }

    .alert {
        border: none;
        border-radius: 8px;
    }

    /* Enhanced Order Tracking Timeline Styles */
    .tracking-timeline {
        padding: 20px 0;
    }

    .timeline-item {
        display: flex;
        margin-bottom: 20px;
        position: relative;
    }

    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 20px;
        top: 40px;
        width: 2px;
        height: calc(100% + 10px);
        background-color: #e3e6f0;
        z-index: 1;
    }

    .timeline-item.completed:not(:last-child)::after {
        background-color: #1cc88a;
    }

    .timeline-marker {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e3e6f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        position: relative;
        z-index: 2;
        flex-shrink: 0;
    }

    .timeline-item.completed .timeline-marker {
        background-color: #1cc88a;
        color: white;
    }

    .timeline-item.current .timeline-marker {
        background-color: #4e73df;
        color: white;
        animation: pulse 2s infinite;
    }

    .timeline-icon {
        font-size: 16px;
    }

    .timeline-content {
        flex: 1;
        padding-top: 5px;
    }

    .timeline-title {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 600;
        color: #5a5c69;
    }

    .timeline-item.completed .timeline-title {
        color: #1cc88a;
    }

    .timeline-item.current .timeline-title {
        color: #4e73df;
    }

    .timeline-description {
        margin: 0;
        color: #858796;
        font-size: 14px;
        line-height: 1.4;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(78, 115, 223, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0);
        }
    }

    /* Enhanced order modal styles */
    .modal-lg {
        max-width: 900px;
    }

    .order-details-card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border-radius: 12px;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }

    .delivery-info-card {
        background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
        border: 1px solid #e3e6f0;
        border-radius: 12px;
    }
</style>

<!-- Session and User Info Header -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="session-info">
                {% if session.get('user_authenticated') %}
                    <span class="badge bg-success">
                        <i class="bi bi-person-check-fill me-1"></i>
                        Logged in as {{ session.get('user_email', 'User') }}
                    </span>
                {% else %}
                    <span class="badge bg-secondary">
                        <i class="bi bi-person me-1"></i>
                        Guest Session
                    </span>
                {% endif %}
            </div>
            <div class="session-actions">
                {% if session.get('user_authenticated') %}
                    <a href="/logout" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </a>
                {% else %}
                    <a href="/signup" class="btn btn-success btn-sm me-2">
                        <i class="bi bi-person-plus me-1"></i>Sign Up
                    </a>
                    <a href="/login" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Simplified Dashboard without Chat Tab -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <!-- Support Navigation Tabs (without chat) -->
            <ul class="nav nav-tabs nav-fill" id="supportTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                        <i class="bi bi-box-seam me-2"></i>
                        ðŸ“¦ Track My Orders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                        <i class="bi bi-person-gear me-2"></i>
                        ðŸ‘¤ My Account
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                        <i class="bi bi-telephone-fill me-2"></i>
                        ðŸ“ž Contact Support
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="supportTabContent">
                <!-- Track My Orders Tab -->
                <div class="tab-pane fade show active" id="orders" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-box-seam text-primary me-2"></i>
                                Track Your Orders
                            </h4>
                            <p class="text-muted">
                                {% if session.get('user_authenticated') %}
                                    Your recent orders will appear here. You can also ask our AI assistant for help.
                                    <br><small class="text-info">
                                        <i class="bi bi-person-check me-1"></i>
                                        Logged in as: {{ session.get('username', 'User') }}
                                        (Customer ID: {{ session.get('customer_id', 'Unknown') }})
                                    </small>
                                {% else %}
                                    <a href="/login" class="text-decoration-none">Login</a> to see your order history, or ask our AI assistant for help.
                                {% endif %}
                            </p>
                        </div>

                        {% if session.get('user_authenticated') %}
                        <!-- Authenticated User: Order History Display -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-clock-history text-info me-2"></i>
                                            My Order History
                                        </h6>
                                        <div class="btn-group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="loadMyOrders()" id="refreshOrdersBtn">
                                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- Order Loading State -->
                                        <div id="orderLoadingState" class="text-center py-4" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading orders...</span>
                                            </div>
                                            <p class="mt-2 text-muted">Loading your orders...</p>
                                        </div>

                                        <!-- Orders List Container -->
                                        <div id="ordersListContainer">
                                            <div class="text-center py-4 text-muted">
                                                <i class="bi bi-box-seam" style="font-size: 2rem;"></i>
                                                <p class="mt-2">Click "Refresh" to load your recent orders</p>
                                            </div>
                                        </div>

                                        <!-- No Orders State -->
                                        <div id="noOrdersState" class="text-center py-4" style="display: none;">
                                            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                            <p class="mt-2 text-muted">No orders found</p>
                                            <p class="small text-muted">Start shopping to see your orders here!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Integrated Shopping & Order Management -->
                        <div class="row mb-4">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-cart-plus text-success me-2"></i>
                                            Quick Shopping & Reorder
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">What would you like to order?</label>
                                                <input type="text" class="form-control" id="quickShopInput"
                                                       placeholder="e.g., iPhone 14, Samsung TV, Laptop">
                                                <small class="text-muted">Describe the product you want to buy</small>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Quantity</label>
                                                <input type="number" class="form-control" id="quickShopQuantity"
                                                       value="1" min="1" max="10">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Delivery State</label>
                                                <select class="form-select" id="quickShopState">
                                                    <option value="{{ session.get('customer_state', 'Lagos') }}">{{ session.get('customer_state', 'Lagos') }}</option>
                                                    <option value="Lagos">Lagos</option>
                                                    <option value="Abuja">Abuja</option>
                                                    <option value="Kano">Kano</option>
                                                    <option value="Rivers">Rivers</option>
                                                    <option value="Oyo">Oyo</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="d-grid gap-2 d-md-flex">
                                            <button class="btn btn-primary" onclick="quickOrderProduct()">
                                                <i class="bi bi-cart-check me-1"></i>Order Now
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="askAIForProduct()">
                                                <i class="bi bi-robot me-1"></i>Ask AI Assistant
                                            </button>
                                            <button class="btn btn-outline-info" onclick="browsePopularProducts()">
                                                <i class="bi bi-stars me-1"></i>Popular Items
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-info-circle text-info me-1"></i>
                                            Order Status Guide
                                        </h6>
                                        <ul class="list-unstyled small">
                                            <li class="mb-1">
                                                <span class="badge bg-warning me-2">Pending</span>
                                                Order received, being prepared
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-info me-2">Processing</span>
                                                Order being processed for delivery
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-success me-2">Delivered</span>
                                                Order delivered successfully
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-secondary me-2">Returned</span>
                                                Order was returned
                                            </li>
                                        </ul>

                                        <div class="mt-3 pt-3 border-top">
                                            <h6 class="small text-muted mb-2">Quick Actions</h6>
                                            <div class="d-grid gap-1">
                                                <button class="btn btn-outline-primary btn-sm" onclick="reorderPreviousItem()">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>Reorder Last Item
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="trackOrderViaChat()">
                                                    <i class="bi bi-search me-1"></i>Track Specific Order
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% else %}
                        <!-- Non-Authenticated User: Login Prompt and Basic Lookup -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Login Required for Full Order Tracking & Shopping
                                    </h6>
                                    <p class="mb-2">To view your complete order history, place new orders, and access personalized features, please log in to your account.</p>
                                    <div class="d-flex gap-2">
                                        <a href="/login" class="btn btn-primary btn-sm">
                                            <i class="bi bi-box-arrow-in-right me-1"></i>Login
                                        </a>
                                        <a href="/signup" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-person-plus me-1"></i>Create Account
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Order Tracking for Non-Authenticated Users -->
                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-search text-primary me-2"></i>
                                            Track Your Order
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Order ID</label>
                                            <input type="text" class="form-control" id="guestOrderIdInput"
                                                   placeholder="Enter your order ID (e.g., 34301)">
                                        </div>
                                        <button class="btn btn-primary w-100" onclick="trackGuestOrder()">
                                            <i class="bi bi-search me-1"></i>Track My Order
                                        </button>
                                        <p class="small text-muted mt-2">
                                            <i class="bi bi-info-circle me-1"></i>
                                            This will open our AI assistant to help you track your order
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-info-circle text-info me-1"></i>
                                            Order Status Guide
                                        </h6>
                                        <ul class="list-unstyled small">
                                            <li class="mb-1">
                                                <span class="badge bg-warning me-2">Pending</span>
                                                Order received, being prepared
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-info me-2">Processing</span>
                                                Order being processed for delivery
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-success me-2">Delivered</span>
                                                Order delivered successfully
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-secondary me-2">Returned</span>
                                                Order was returned
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- My Account Tab -->
                <div class="tab-pane fade" id="account" role="tabpanel">
                    <div class="account-container">
                        <!-- Glassmorphism Brand Header Only -->
                        <div class="account-hero-glass">
                            <div class="hero-content-glass">
                                <div class="brand-logo-glass">
                                    <img src="/static/logo.svg" alt="raqibtech.com" width="48" height="48">
                                </div>
                                <h3 class="account-brand-title-glass">raqibtech.com</h3>
                                <p class="account-brand-subtitle-glass">Your Trusted Nigerian E-commerce Partner</p>
                                <div class="account-brand-stats-glass">
                                    <div class="stat-glass">
                                        <i class="bi bi-geo-alt-fill"></i>
                                        <span>36 States + FCT</span>
                                    </div>
                                    <div class="stat-glass">
                                        <span>ðŸ“¦</span>
                                        <span>1M+ Deliveries</span>
                                    </div>
                                    <div class="stat-glass">
                                        <span>â­</span>
                                        <span>4.8/5 Rating</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Welcome Section -->
                        <div class="welcome-section">
                            {% if session.get('user_authenticated') %}
                                <div class="welcome-card authenticated">
                                    <div class="welcome-icon">
                                        <i class="bi bi-person-check-fill"></i>
                                    </div>
                                    <div class="welcome-content">
                                        <h4>Welcome back!</h4>
                                        <p>Manage your account information and explore personalized features.</p>
                                    </div>
                                    <div class="account-tier-display">
                                        <span class="tier-badge gold">
                                            <i class="bi bi-star-fill me-1"></i>Gold Member
                                        </span>
                                    </div>
                                </div>
                            {% else %}
                                <div class="welcome-card guest">
                                    <div class="welcome-icon">
                                        <i class="bi bi-person-plus-fill"></i>
                                    </div>
                                    <div class="welcome-content">
                                        <h4>Join raqibtech.com</h4>
                                        <p>Create an account to unlock exclusive benefits and personalized shopping experience.</p>
                                    </div>
                                    <div class="auth-actions">
                                        <a href="/login" class="btn btn-primary">
                                            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                                        </a>
                                        <a href="/signup" class="btn btn-outline-primary">
                                            <i class="bi bi-person-plus me-2"></i>Sign Up
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        {% if session.get('user_authenticated') %}
                        <!-- Quick Actions Dashboard -->
                        <div class="dashboard-section">
                            <h5 class="section-title">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Account Dashboard
                            </h5>
                            <div class="dashboard-grid">
                                <div class="dashboard-card" onclick="sendQuickMessage('Show my recent orders')">
                                    <div class="card-icon orders">
                                        <i class="bi bi-box-seam"></i>
                                    </div>
                                    <div class="card-content">
                                        <h6>Recent Orders</h6>
                                        <p>Track & manage your purchases</p>
                                        <span class="card-badge">5 Active</span>
                                    </div>
                                </div>

                                <div class="dashboard-card" onclick="sendQuickMessage('What are my account benefits?')">
                                    <div class="card-icon benefits">
                                        <i class="bi bi-award"></i>
                                    </div>
                                    <div class="card-content">
                                        <h6>Account Benefits</h6>
                                        <p>Tier privileges & rewards</p>
                                        <span class="card-badge">Gold Tier</span>
                                    </div>
                                </div>

                                <div class="dashboard-card" onclick="sendQuickMessage('Recommend products for me')">
                                    <div class="card-icon recommendations">
                                        <i class="bi bi-heart"></i>
                                    </div>
                                    <div class="card-content">
                                        <h6>For You</h6>
                                        <p>Personalized recommendations</p>
                                        <span class="card-badge">12 New</span>
                                    </div>
                                </div>

                                <div class="dashboard-card" onclick="sendQuickMessage('Help with payments')">
                                    <div class="card-icon payments">
                                        <i class="bi bi-credit-card"></i>
                                    </div>
                                    <div class="card-content">
                                        <h6>Payment Methods</h6>
                                        <p>Manage billing & cards</p>
                                        <span class="card-badge">2 Saved</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Account Services -->
                        <div class="services-section">
                            <div class="row">
                                <div class="col-lg-6 mb-4">
                                    <div class="service-card">
                                        <div class="service-header">
                                            <i class="bi bi-gear-fill me-2"></i>
                                            <h6>Account Management</h6>
                                        </div>
                                        <div class="service-actions">
                                            <button class="service-btn" onclick="sendQuickMessage('Update my profile information')">
                                                <i class="bi bi-person-fill-gear"></i>
                                                <span>Update Profile</span>
                                                <i class="bi bi-chevron-right ms-auto"></i>
                                            </button>
                                            <button class="service-btn" onclick="sendQuickMessage('Change my delivery address')">
                                                <i class="bi bi-geo-alt-fill"></i>
                                                <span>Delivery Address</span>
                                                <i class="bi bi-chevron-right ms-auto"></i>
                                            </button>
                                            <button class="service-btn" onclick="sendQuickMessage('Update my payment methods')">
                                                <i class="bi bi-credit-card-fill"></i>
                                                <span>Payment Methods</span>
                                                <i class="bi bi-chevron-right ms-auto"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-6 mb-4">
                                    <div class="service-card tier-card">
                                        <div class="service-header">
                                            <i class="bi bi-trophy-fill me-2"></i>
                                            <h6>Membership Tiers</h6>
                                        </div>
                                        <div class="tier-progression">
                                            <div class="tier-item bronze">
                                                <span class="tier-dot"></span>
                                                <div class="tier-info">
                                                    <strong>Bronze</strong>
                                                    <small>Standard benefits</small>
                                                </div>
                                            </div>
                                            <div class="tier-item silver">
                                                <span class="tier-dot"></span>
                                                <div class="tier-info">
                                                    <strong>Silver</strong>
                                                    <small>5% discount + priority support</small>
                                                </div>
                                            </div>
                                            <div class="tier-item gold active">
                                                <span class="tier-dot"></span>
                                                <div class="tier-info">
                                                    <strong>Gold</strong>
                                                    <small>10% discount + free delivery</small>
                                                </div>
                                                <span class="current-badge">Current</span>
                                            </div>
                                            <div class="tier-item platinum">
                                                <span class="tier-dot"></span>
                                                <div class="tier-info">
                                                    <strong>Platinum</strong>
                                                    <small>15% discount + premium perks</small>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-primary w-100 mt-3" onclick="sendQuickMessage('How to upgrade to platinum tier?')">
                                            <i class="bi bi-arrow-up-circle me-2"></i>Upgrade to Platinum
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Support Tab -->
                <div class="tab-pane fade" id="contact" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-telephone-fill text-danger me-2"></i>
                                Contact raqibtech.com Support
                            </h4>
                            <p class="text-muted">
                                Multiple ways to reach our support team across Nigeria.
                            </p>
                        </div>

                        <div class="row">
                            <!-- Contact Methods -->
                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-telephone-fill text-success display-4 mb-3"></i>
                                        <h6>Phone Support</h6>
                                        <p class="text-muted small">Speak with our support team</p>
                                        <strong class="text-success">+234 (702) 5965-922</strong>
                                        <p class="small mt-2">Daily 8AM - 8PM (WAT)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-envelope-fill text-primary display-4 mb-3"></i>
                                        <h6>Email Support</h6>
                                        <p class="text-muted small">Send us your questions</p>
                                        <strong class="text-primary">support@raqibtech.com</strong>
                                        <p class="small mt-2">Response within 24 hours</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-chat-heart-fill text-danger display-4 mb-3"></i>
                                        <h6>Live AI Chat</h6>
                                        <p class="text-muted small">Instant help available</p>
                                        <strong class="text-danger">Available 24/7</strong>
                                        <p class="small mt-2">
                                            <button class="btn btn-sm btn-outline-danger" onclick="openChatModal()">
                                                Start Chat Now
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nigerian Coverage -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-geo-alt-fill me-2"></i>
                                              Nationwide Coverage in Nigeria
                                        </h6>
                                        <p class="mb-0">
                                            We deliver to all 36 Nigerian states + FCT with dedicated support for your region.
                                            Payment options include Pay on Delivery, Bank Transfer, Card, and RaqibTechPay.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Chat Button -->
<button class="floating-chat-btn" id="floatingChatBtn">
    <i class="bi bi-chat-heart-fill"></i>
</button>

<!-- ðŸ”§ DEBUG: Temporary test button to verify modal functionality -->
<!-- <div style="position: fixed; top: 10px; right: 10px; z-index: 10000;">
    <button class="btn btn-warning btn-sm" onclick="debugTestModal()" id="debugTestBtn">
        ðŸ”§ Test Modal
    </button>
</div> -->

<!-- Chat Modal -->
<div class="chat-modal-overlay" id="chatModalOverlay" onclick="closeChatModal(event)">
    <div class="chat-modal" onclick="handleModalClick(event)">
        <!-- Modal Header -->
        <div class="chat-modal-header">
            <h6 class="chat-modal-title">
                <div class="brand-logo">
                    <img src="/static/logo.svg" alt="raqibtech.com">
                </div>
                <span>raqibtech.com <br> AI Assistant</span>
            </h6>
            <div class="chat-modal-actions">
                <button class="chat-modal-btn" onclick="toggleConversationSidebar()" title="Chat History">
                    <i class="bi bi-clock-history"></i>
                </button>
                <button class="chat-modal-btn" onclick="createNewChat()" title="New Chat">
                    <i class="bi bi-plus-circle"></i>
                </button>
                <button class="chat-modal-btn" onclick="closeChatModal()" title="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- Conversation Sidebar -->
        <div class="conversation-sidebar" id="conversationSidebar">
            <div class="conversation-sidebar-header">
                <h6 class="conversation-sidebar-title">Chat History</h6>
                <button class="chat-modal-btn" onclick="toggleConversationSidebar()" title="Close History">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="conversation-list" id="chatHistoryList">
                {% for conv in conversations %}
                <div class="conversation-item" data-conversation-id="{{ conv.conversation_id }}"
                     onclick="switchToConversation('{{ conv.conversation_id }}')">
                    <div class="conversation-info">
                        <h6>{{ conv.conversation_title }}</h6>
                        <small>{{ conv.message_count }} messages</small>
                    </div>
                    <div class="conversation-actions">
                        <small class="text-muted">{{ conv.updated_at.strftime('%m/%d') }}</small>
                        <button class="btn btn-outline-danger btn-sm" onclick="customerPortal.deleteConversation('{{ conv.conversation_id }}', event)"
                                title="Delete conversation">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}

                {% if not conversations %}
                <div class="text-center text-muted p-3">
                    <i class="bi bi-chat-dots display-6 mb-2"></i>
                    <p class="mb-0 small">No chat history yet</p>
                    <small>Start a conversation!</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Messages Area -->
        <div class="chat-modal-messages" id="chatMessages">
            <div id="loadingIndicator" class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted small">Loading conversation...</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-modal-input">
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask me anything..."
                       onkeypress="handleChatKeyPress(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced raqibtech.com Branding Styles for Account Dashboard -->
<style>
.raqibtech-branding {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.brand-title {
    font-size: 28px;
    font-weight: 800;
    margin: 0;
}

.brand-logo {
    font-size: 32px;
    margin-right: 8px;
}

.brand-text {
    color: #ffd700;
    letter-spacing: 1px;
}

.brand-domain {
    color: #ffffff;
    font-weight: 600;
}

.brand-subtitle {
    font-size: 16px;
    margin-bottom: 16px;
    opacity: 0.9;
    font-weight: 500;
}

.brand-stats .badge {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
}

/* Account Dashboard Styles */
.account-dashboard {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid #dee2e6;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.dashboard-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.dashboard-action-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.dashboard-action-btn:hover {
    border-color: #18bc9c;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(24, 188, 156, 0.2);
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
}

.action-icon {
    font-size: 24px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 12px;
    flex-shrink: 0;
}

.action-text strong {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.action-text small {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

/* Responsive dashboard */
@media (max-width: 768px) {
    .dashboard-actions {
        grid-template-columns: 1fr;
    }

    .dashboard-action-btn {
        padding: 16px;
    }

    .action-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
}
</style>

<!-- Hidden data for JavaScript -->
<script>
window.currentConversationId = {% if current_conversation_id %}'{{ current_conversation_id }}'{% else %}null{% endif %};
window.userAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
</script>

<!-- Enhanced Customer Support JavaScript with Floating Modal Chat -->
<script>
// ðŸ”§ DEBUG: Check for JavaScript errors and conflicts
console.log('ðŸ” Modal Debug: Starting initialization...');

// Check for required dependencies
if (typeof bootstrap === 'undefined') {
    console.error('âŒ Bootstrap JavaScript not loaded! Modal will not work.');
}

// Enhanced Customer-focused support system with floating modal interface
class CustomerSupportPortal {
    constructor() {
        console.log('ðŸš€ CustomerPortal: Initializing...');

        // Required DOM elements
        this.requiredElements = [
            'chatModalOverlay',
            'conversationSidebar',
            'floatingChatBtn',
        ];

        // Verify all required elements exist
        this.verifyRequiredElements();

        // Initialize properties
        this.currentConversationId = window.currentConversationId;
        this.conversationLoaded = false;
        this.isTyping = false;
        this.conversationLocked = false;
        this.modalOpen = false;
        this.sidebarOpen = false;
        this.activeMessageRequest = null;

        // Get DOM elements
        this.chatModal = document.getElementById('chatModalOverlay');
        this.conversationSidebar = document.getElementById('conversationSidebar');
        this.chatBtn = document.getElementById('floatingChatBtn');

        // Verify critical elements
        if (!this.chatModal || !this.chatBtn) {
            console.error('âŒ Critical elements missing');
            this.showError('Chat system failed to initialize - missing elements');
            return;
        }

        // Set up event listeners
        this.setupEventListeners();
        this.setupKeyboardShortcuts();
        this.setupModalEventListeners();

        // Initialize drag functionality for floating button
        this.initializeDragFunctionality();

        console.log('âœ… CustomerPortal initialized successfully');
    }

    verifyRequiredElements() {
        this.requiredElements.forEach(id => {
            if (!document.getElementById(id)) {
                console.error(`âŒ Missing element: ${id}`);
            }
        });
    }

    setupEventListeners() {
        // Add event listeners for chat modal
        this.chatModal.addEventListener('hidden.bs.modal', () => {
            this.closeChatModal();
        });

        // Add event listeners for conversation sidebar
        this.conversationSidebar.addEventListener('hidden.bs.modal', () => {
            this.closeConversationSidebar();
        });

        console.log('âœ… Base event listeners configured');
    }

    setupKeyboardShortcuts() {
        // ESC to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.modalOpen) {
                console.log('âŒ¨ï¸ ESC key pressed, closing modal');
                this.closeChatModal();
            }
        });
        console.log('âœ… Keyboard shortcuts configured');
    }

    setupModalEventListeners() {
        if (!this.chatModal) return;

        // Auto-focus input when modal opens
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class' && this.chatModal.classList.contains('active')) {
        setTimeout(() => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.focus();
                            console.log('âœ… Chat input focused');
                        }
                    }, 400); // Wait for animation
                }
            });
        });
        observer.observe(this.chatModal, { attributes: true });
        console.log('âœ… Modal event listeners configured');
    }

    initializeDragFunctionality() {
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let initialPosition = { x: 0, y: 0 };
        let hasMoved = false;

        const onMouseDown = (e) => {
            e.preventDefault();
            isDragging = false;
            hasMoved = false;

            const rect = this.chatBtn.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            initialPosition.x = e.clientX;
            initialPosition.y = e.clientY;

            this.chatBtn.classList.add('dragging');

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };

        const onMouseMove = (e) => {
            const distance = Math.sqrt(
                Math.pow(e.clientX - initialPosition.x, 2) +
                Math.pow(e.clientY - initialPosition.y, 2)
            );

            if (distance > 5) {
                isDragging = true;
                hasMoved = true;
            }

            if (isDragging) {
                const newX = e.clientX - dragOffset.x;
                const newY = e.clientY - dragOffset.y;

                const maxX = window.innerWidth - this.chatBtn.offsetWidth;
                const maxY = window.innerHeight - this.chatBtn.offsetHeight;

                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));

                this.chatBtn.style.left = constrainedX + 'px';
                this.chatBtn.style.top = constrainedY + 'px';
                this.chatBtn.style.right = 'auto';
                this.chatBtn.style.bottom = 'auto';
            }
        };

        const onMouseUp = (e) => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);

            this.chatBtn.classList.remove('dragging');

            // If the button wasn't dragged, treat it as a click
            if (!hasMoved) {
                this.toggleChatModal();
            }

            isDragging = false;
        };

        // Touch events for mobile
        const onTouchStart = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            isDragging = false;
            hasMoved = false;

            const rect = this.chatBtn.getBoundingClientRect();
            dragOffset.x = touch.clientX - rect.left;
            dragOffset.y = touch.clientY - rect.top;

            initialPosition.x = touch.clientX;
            initialPosition.y = touch.clientY;

            this.chatBtn.classList.add('dragging');

            document.addEventListener('touchmove', onTouchMove, { passive: false });
            document.addEventListener('touchend', onTouchEnd);
        };

        const onTouchMove = (e) => {
            e.preventDefault();
            const touch = e.touches[0];

            const distance = Math.sqrt(
                Math.pow(touch.clientX - initialPosition.x, 2) +
                Math.pow(touch.clientY - initialPosition.y, 2)
            );

            if (distance > 5) {
                isDragging = true;
                hasMoved = true;
            }

            if (isDragging) {
                const newX = touch.clientX - dragOffset.x;
                const newY = touch.clientY - dragOffset.y;

                const maxX = window.innerWidth - this.chatBtn.offsetWidth;
                const maxY = window.innerHeight - this.chatBtn.offsetHeight;

                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));

                this.chatBtn.style.left = constrainedX + 'px';
                this.chatBtn.style.top = constrainedY + 'px';
                this.chatBtn.style.right = 'auto';
                this.chatBtn.style.bottom = 'auto';
            }
        };

        const onTouchEnd = (e) => {
            document.removeEventListener('touchmove', onTouchMove);
            document.removeEventListener('touchend', onTouchEnd);

            this.chatBtn.classList.remove('dragging');

            // If the button wasn't dragged, treat it as a tap
            if (!hasMoved) {
                this.toggleChatModal();
            }

            isDragging = false;
        };

        // Disable default click handling when dragging
        this.chatBtn.addEventListener('click', (e) => {
            if (hasMoved) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        this.chatBtn.addEventListener('mousedown', onMouseDown);
        this.chatBtn.addEventListener('touchstart', onTouchStart, { passive: false });

        console.log('âœ… Drag functionality initialized for floating chat button');
    }

    toggleChatModal() {
        console.log(`ðŸ”„ Toggle modal - Current state: ${this.modalOpen ? 'open' : 'closed'}`);
        if (this.modalOpen) {
            this.closeChatModal();
        } else {
            this.openChatModal();
        }
    }

    openChatModal() {
        console.log('ðŸ“‚ Opening chat modal...');

        if (!this.chatModal || !this.chatBtn) {
            console.error('âŒ Cannot open modal - elements missing');
            return;
        }

        this.modalOpen = true;
        this.chatModal.classList.add('active');
        this.chatBtn.classList.add('active');
        this.chatBtn.innerHTML = '<i class="bi bi-x-lg"></i>';

        // Load current conversation if not already loaded
        if (!this.conversationLoaded) {
            this.loadCurrentConversation();
            this.conversationLoaded = true;
        }

        // Disable body scroll (fix from Frozen Modal guide)
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';

        console.log('âœ… Modal opened successfully');
    }

    closeChatModal(event) {
        // Don't close if clicking inside modal
        if (event && event.target.closest('.chat-modal')) {
            console.log('ðŸ–±ï¸ Click inside modal, not closing');
            return;
        }

        console.log('ðŸ“ Closing chat modal...');

        if (!this.chatModal || !this.chatBtn) {
            console.error('âŒ Cannot close modal - elements missing');
            return;
        }

        this.modalOpen = false;
        this.chatModal.classList.remove('active');
        this.chatBtn.classList.remove('active');
        this.chatBtn.innerHTML = '<i class="bi bi-chat-heart-fill"></i>';

        // Close sidebar if open and reset modal state
        if (this.sidebarOpen) {
            this.sidebarOpen = false;
            this.conversationSidebar.classList.remove('active');
            const chatModal = document.querySelector('.chat-modal');
            if (chatModal) {
                chatModal.classList.remove('sidebar-open');
            }
        }

        // Re-enable body scroll (fix from WeWeb community)
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';

        // Force layout recalculation (fix from WeWeb community)
        document.body.offsetHeight;

        console.log('âœ… Modal closed successfully');
    }

    toggleConversationSidebar() {
        if (!this.conversationSidebar) {
            console.error('âŒ Conversation sidebar not found');
            return;
        }

        this.sidebarOpen = !this.sidebarOpen;
        this.conversationSidebar.classList.toggle('active', this.sidebarOpen);

        // Add overlay effect to main modal when sidebar is open
        const chatModal = document.querySelector('.chat-modal');
        if (chatModal) {
            chatModal.classList.toggle('sidebar-open', this.sidebarOpen);
        }

        console.log(`ðŸ”„ Sidebar ${this.sidebarOpen ? 'opened' : 'closed'}`);

        // Refresh conversation list when opening
        if (this.sidebarOpen) {
            this.refreshConversationList();
        }

        // Focus the close button when sidebar opens for better accessibility
        if (this.sidebarOpen) {
            setTimeout(() => {
                const closeBtn = this.conversationSidebar.querySelector('.chat-modal-btn');
                if (closeBtn) {
                    closeBtn.focus();
                }
            }, 300);
        }
    }

    async loadCurrentConversation() {
        if (!this.currentConversationId) {
            console.log('ðŸ’¬ No current conversation, showing welcome message');
            this.displayWelcomeMessage();
            return;
        }

        console.log(`ðŸ”„ Loading conversation: ${this.currentConversationId}`);

        try {
            const response = await fetch(`/api/conversations/${this.currentConversationId}/messages`);
            const data = await response.json();

            if (this.currentConversationId !== window.currentConversationId) {
                console.warn('âš ï¸ Conversation changed during loading, aborting');
                return;
            }

            if (data.success && data.messages.length > 0) {
                this.displayConversationHistory(data.messages);
            } else {
                this.showWelcomeMessage();
            }
        } catch (error) {
            console.error('âŒ Error loading conversation:', error);
            this.showWelcomeMessage();
        }
    }

    displayConversationHistory(messages) {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (!chatMessages) {
            console.error('âŒ Chat messages container not found');
            return;
        }

        chatMessages.innerHTML = '';

        messages.forEach(message => {
            const senderType = message.sender_type === 'user' ? 'customer' : 'ai';
            this.addMessageToChatDisplay(message.content, senderType, false, message.metadata || {});
        });

        this.smoothScrollToBottom();
        console.log(`âœ… Loaded ${messages.length} messages for conversation ${this.currentConversationId}`);
    }

    showWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (!chatMessages) {
            console.error('âŒ Chat messages container not found');
            return;
        }

        const welcomeMessage = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeMessage;
        this.smoothScrollToBottom();

        console.log('âœ… Welcome message displayed in modal');
    }

    createWelcomeMessage() {
        // ChatGPT-style simple welcome message
        return `
            <div class="message ai">
                <div class="message-content">
                    <div class="message-bubble">
                        <p>ðŸ¤— Hello! I'm your AI Support assistant. How can I help you today?</p>
                    </div>
                </div>
            </div>
        `;
    }

    async sendCustomerMessage(message = null) {
        if (this.isTyping || this.conversationLocked) {
            console.warn('âš ï¸ Message blocked: System is busy');
            return;
        }

        const chatInput = document.getElementById('chatInput');
        if (!chatInput) {
            console.error('âŒ Chat input not found');
            return;
        }

        const userMessage = message || chatInput.value.trim();
        if (!userMessage) {
            console.warn('âš ï¸ Empty message, not sending');
            return;
        }

        console.log(`ðŸ“¤ Sending message: ${userMessage.substring(0, 50)}...`);

        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
            this.removeTypingIndicator();
        }

        if (!message) chatInput.value = '';

        const requestConversationId = this.currentConversationId;
        this.addMessageToChatDisplay(userMessage, 'customer');
        this.isTyping = true;
        this.showTypingIndicator();

        try {
            const controller = new AbortController();
            this.activeMessageRequest = controller;

            const response = await fetch('/api/enhanced-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: userMessage
                }),
                signal: controller.signal
            });

            if (requestConversationId !== this.currentConversationId) {
                console.warn('âš ï¸ Conversation changed during request, ignoring response');
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (requestConversationId !== this.currentConversationId) {
                console.warn('âš ï¸ Conversation changed before response processing, ignoring');
                return;
            }

            this.isTyping = false;
            this.activeMessageRequest = null;
            this.removeTypingIndicator();

            if (data.success) {
                console.log('âœ… Message sent successfully');
                this.addCustomerResponseToChat(data);
                this.refreshConversationList();
            } else {
                this.addMessageToChatDisplay(data.message || 'Sorry, I encountered an issue. Please try again.', 'ai', true);
            }

        } catch (error) {
            if (error.name !== 'AbortError') {
                this.isTyping = false;
                this.activeMessageRequest = null;
                this.removeTypingIndicator();
                console.error('âŒ Customer chat error:', error);

                if (requestConversationId === this.currentConversationId) {
                    this.addMessageToChatDisplay('I apologize, but I\'m experiencing technical difficulties. Please try again or contact our phone support at +234 (702) 5965-922.', 'ai', true);
                }
            }
        }
    }

    renderMarkdown(text) {
        // Simple markdown renderer for basic formatting
        if (!text) return text;

        // ðŸ†• ENHANCED: Convert markdown tables to HTML tables
        text = this.renderMarkdownTables(text);

        // Convert **bold** to <strong>
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Convert *italic* to <em> (but avoid double asterisks)
        text = text.replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>');

        // Convert ### headers to h3
        text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');

        // Convert ## headers to h2
        text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');

        // Convert # headers to h1
        text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');

        // Convert bullet points (â€¢ or -)
        text = text.replace(/^[â€¢-] (.+)$/gm, '<li>$1</li>');

        // Wrap consecutive <li> elements in <ul> - improved regex
        text = text.replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gm, '<ul>$1</ul>');
        text = text.replace(/<\/ul>\s*<ul>/g, ''); // merge consecutive lists

        return text;
    }

    renderMarkdownTables(text) {
        // ðŸ†• Enhanced markdown table parser for AI responses
        const lines = text.split('\n');
        const result = [];
        let i = 0;

        while (i < lines.length) {
            const line = lines[i].trim();

            // Check if this line looks like a table header (contains |)
            if (line.includes('|') && line.length > 3) {
                // Look ahead to see if next line is a separator (contains | and -)
                const nextLine = i + 1 < lines.length ? lines[i + 1].trim() : '';

                if (nextLine.includes('|') && nextLine.includes('-')) {
                    // Found a markdown table!
                    const tableLines = [line]; // Header
                    i++; // Skip separator line
                    i++; // Move to first data row

                    // Collect all subsequent table rows
                    while (i < lines.length) {
                        const tableLine = lines[i].trim();
                        if (tableLine.includes('|') && tableLine.length > 3) {
                            tableLines.push(tableLine);
                            i++;
                        } else {
                            break; // End of table
                        }
                    }

                    // Convert to HTML table
                    result.push(this.convertToHtmlTable(tableLines));
                    continue;
                }
            }

            // Not a table line, add as-is
            result.push(line);
            i++;
        }

        return result.join('\n');
    }

        convertToHtmlTable(tableLines) {
        if (tableLines.length === 0) return '';

        let html = '<div class="ai-table-container"><table class="ai-response-table">';

        // Process header (first line)
        const headerCells = tableLines[0].split('|')
            .map(cell => cell.trim())
            .filter(cell => cell.length > 0);

        html += '<thead><tr>';
        headerCells.forEach(cell => {
            html += `<th>${cell}</th>`;
        });
        html += '</tr></thead>';

        // Process data rows (remaining lines)
        if (tableLines.length > 1) {
            html += '<tbody>';
            for (let i = 1; i < tableLines.length; i++) {
                const cells = tableLines[i].split('|')
                    .map(cell => cell.trim())
                    .filter(cell => cell.length > 0);

                html += '<tr>';
                cells.forEach(cell => {
                    // Apply basic markdown formatting to table cells
                    let formattedCell = cell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    formattedCell = formattedCell.replace(/\*(.*?)\*/g, '<em>$1</em>');

                    // ðŸ†• Enhanced formatting for specific data types
                    formattedCell = this.enhanceTableCellFormatting(formattedCell);

                    html += `<td>${formattedCell}</td>`;
                });
                html += '</tr>';
            }
            html += '</tbody>';
        }

        html += '</table></div>';
        return html;
    }

    enhanceTableCellFormatting(cell) {
        // Format order status with colored badges
        if (/^(delivered|processing|pending|cancelled|returned|shipped)$/i.test(cell.trim())) {
            const status = cell.trim().toLowerCase();
            let badgeClass = 'status-badge';

            switch (status) {
                case 'delivered':
                    badgeClass += ' status-success';
                    break;
                case 'processing':
                case 'shipped':
                    badgeClass += ' status-info';
                    break;
                case 'pending':
                    badgeClass += ' status-warning';
                    break;
                case 'cancelled':
                case 'returned':
                    badgeClass += ' status-danger';
                    break;
            }

            return `<span class="${badgeClass}">${cell}</span>`;
        }

        // Format Nigerian Naira amounts with highlighting
        if (cell.includes('â‚¦') || /\d+,\d+\.\d+/.test(cell)) {
            return `<span class="amount-highlight">${cell}</span>`;
        }

        // Format payment methods with icons
        if (/^(bank transfer|card|pay on delivery|raqibtechpay)$/i.test(cell.trim())) {
            const method = cell.trim().toLowerCase();
            let icon = '';

            switch (method) {
                case 'bank transfer':
                    icon = 'ðŸ¦';
                    break;
                case 'card':
                    icon = 'ðŸ’³';
                    break;
                case 'pay on delivery':
                    icon = 'ðŸ“¦';
                    break;
                case 'raqibtechpay':
                    icon = 'ðŸ’°';
                    break;
            }

            return `<span class="payment-method">${icon} ${cell}</span>`;
        }

        return cell;
    }

    addMessageToChatDisplay(message, sender, isError = false, metadata = {}) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) {
            console.error('âŒ Chat messages container not found');
            return;
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender === 'customer' ? 'customer' : 'ai'}`;

        if (isError) {
            messageDiv.classList.add('error');
        }

        const timestamp = new Date().toLocaleTimeString();
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = ''; // Removed 'U' and 'AI' text

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';

        // ðŸ”§ FIX: Properly format AI responses with markdown rendering and line breaks
        if (sender === 'ai') {
            // Process markdown first, then handle line breaks carefully to preserve lists
            let processedMessage = this.renderMarkdown(message);

            // Handle line breaks but preserve list structure
            processedMessage = processedMessage
                .replace(/\n(?!<li>)/g, '<br>')  // Don't add <br> before <li> elements
                .replace(/\r\n(?!<li>)/g, '<br>')
                .replace(/\r(?!<li>)/g, '<br>');

            messageBubble.innerHTML = processedMessage;
        } else {
            // For customer messages, use as-is (user input should be escaped)
            messageBubble.textContent = message;
        }

        const messageMeta = document.createElement('div');
        messageMeta.className = 'message-meta';

        if (sender === 'customer') {
            messageMeta.innerHTML = `<span>${timestamp}</span>`;
        } else {
            const responseTime = metadata.execution_time || '';
            messageMeta.innerHTML = `
                <span>${timestamp}</span>
                ${responseTime ? `<span class="response-time">âš¡ ${responseTime}</span>` : ''}
            `;
        }

        messageContent.appendChild(messageBubble);
        messageContent.appendChild(messageMeta);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        chatMessages.appendChild(messageDiv);
        this.smoothScrollToBottom();
    }

    addCustomerResponseToChat(data) {
        this.addMessageToChatDisplay(data.response, 'ai', false, data);
        this.addSmartQuickActions(data);
    }

    addSmartQuickActions(data) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const quickActionDiv = document.createElement('div');
        quickActionDiv.className = 'smart-quick-actions-container';

        const quickActions = this.generateSmartQuickActions(data);

        quickActionDiv.innerHTML = `
            <div class="smart-quick-actions">
                <div class="quick-actions-header">
                    <span>ðŸ’¡ Quick Actions</span>
                </div>
                <div class="quick-actions-buttons">
                    ${quickActions.map(action => `
                        <button class="smart-quick-action-btn" onclick="${action.onclick}">
                            ${action.icon} ${action.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;

        chatMessages.appendChild(quickActionDiv);
        this.smoothScrollToBottom();
    }

    generateSmartQuickActions(data) {
        const actions = [];
        const queryType = data.query_type || 'general';

        if (this.userAuthenticated) {
            switch (queryType) {
                case 'order_analytics':
                    actions.push(
                        { icon: 'ðŸ“¦', text: 'Track Another Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: 'ðŸ“‹', text: 'View Order History', onclick: `customerPortal.sendCustomerMessage('Show my order history')` },
                        { icon: 'ðŸšš', text: 'Update Delivery Address', onclick: `customerPortal.sendCustomerMessage('Update my delivery address')` },
                        { icon: 'ðŸ’³', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` }
                    );
                    break;
                case 'customer_analysis':
                    actions.push(
                        { icon: 'ðŸ‘¤', text: 'Update Profile', onclick: `customerPortal.sendCustomerMessage('Update my profile')` },
                        { icon: 'ðŸ”’', text: 'Account Security', onclick: `customerPortal.sendCustomerMessage('Account security settings')` },
                        { icon: 'â­', text: 'Upgrade Account', onclick: `customerPortal.sendCustomerMessage('How to upgrade my account tier')` },
                        { icon: 'ðŸ’¼', text: 'Account Benefits', onclick: `customerPortal.sendCustomerMessage('What are my account benefits')` }
                    );
                    break;
                case 'product_performance':
                    actions.push(
                        { icon: 'ðŸª', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: 'ðŸ“±', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: 'ðŸ‘—', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: 'ðŸ’„', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` }
                    );
                    break;
                case 'revenue_insights':
                    actions.push(
                        { icon: 'ðŸ’³', text: 'Payment Methods', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept')` },
                        { icon: 'ðŸ”„', text: 'Refund Request', onclick: `customerPortal.sendCustomerMessage('How to request a refund')` },
                        { icon: 'ðŸ“Š', text: 'Spending History', onclick: `customerPortal.sendCustomerMessage('Show my spending history')` },
                        { icon: 'ðŸ’°', text: 'Payment Issues', onclick: `customerPortal.sendCustomerMessage('Help with payment issues')` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: 'ðŸ›ï¸', text: 'Browse Products', onclick: `customerPortal.sendCustomerMessage('What products do you recommend')` },
                        { icon: 'ðŸ“¦', text: 'Track Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: 'ðŸ’³', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` },
                        { icon: 'ðŸ“ž', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('Contact customer support')` }
                    );
            }
        } else {
            switch (queryType) {
                case 'product_performance':
                    actions.push(
                        { icon: 'ðŸª', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: 'ðŸ“±', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: 'ðŸ‘—', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: 'ðŸ’„', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` },
                        { icon: 'ðŸ”', text: 'Login for Personal Shop', onclick: `window.location.href='/login'` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: 'ðŸ”', text: 'Login', onclick: `window.location.href='/login'` },
                        { icon: 'ðŸ“', text: 'Create Account', onclick: `customerPortal.sendCustomerMessage('How do I create an account?')` },
                        { icon: 'ðŸ›ï¸', text: 'Explore Products', onclick: `customerPortal.sendCustomerMessage('What products do you offer?')` },
                        { icon: 'ðŸ“', text: 'Delivery Areas', onclick: `customerPortal.sendCustomerMessage('What areas do you deliver to?')` },
                        { icon: 'ðŸ’³', text: 'Payment Options', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept?')` },
                        { icon: 'ðŸ“ž', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('How to contact customer support')` }
                    );
            }
        }

        return actions;
    }

    showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        this.removeTypingIndicator();

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-avatar"></div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span style="color: #6c757d; font-size: 12px;">raqibtech.com Assistant is typing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        `;

        chatMessages.appendChild(typingDiv);
        this.smoothScrollToBottom();
    }

    removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    smoothScrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }
    }

    async refreshConversationList() {
        try {
            const response = await fetch('/api/conversations');
            const data = await response.json();

            if (data.success) {
                this.updateConversationList(data.conversations);
            }
        } catch (error) {
            console.error('âŒ Error refreshing conversation list:', error);
        }
    }

    updateConversationList(conversations) {
        const listContainer = document.getElementById('chatHistoryList');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (conversations.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center text-muted p-3">
                    <i class="bi bi-chat-dots display-6 mb-2"></i>
                    <p class="mb-0 small">No chat history yet</p>
                    <small>Start a conversation!</small>
                </div>
            `;
            return;
        }

        conversations.forEach(conv => {
            const convElement = document.createElement('div');
            convElement.className = 'conversation-item';
            convElement.setAttribute('data-conversation-id', conv.conversation_id);

            convElement.innerHTML = `
                <div class="conversation-info" onclick="customerPortal.switchToConversation('${conv.conversation_id}')" style="flex: 1; cursor: pointer;">
                    <h6>${conv.title}</h6>
                    <small>${conv.message_count} messages</small>
                </div>
                <div class="conversation-actions">
                    <small class="text-muted">${new Date(conv.updated_at).toLocaleDateString()}</small>
                    <button class="btn btn-outline-danger btn-sm" onclick="customerPortal.deleteConversation('${conv.conversation_id}', event)"
                            title="Delete conversation">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;

            listContainer.appendChild(convElement);
        });
    }

    async deleteConversation(conversationId, event) {
        event.stopPropagation();

        if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/conversations/${conversationId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                console.log(`âœ… Deleted conversation ${conversationId}`);

                if (conversationId === this.currentConversationId) {
                    this.currentConversationId = null;
                    window.currentConversationId = null;
                    this.displayWelcomeMessage();
                }

                this.refreshConversationList();
            } else {
                alert('Failed to delete conversation. Please try again.');
            }
        } catch (error) {
            console.error('âŒ Error deleting conversation:', error);
            alert('Error deleting conversation. Please try again.');
        }
    }

    async switchToConversation(conversationId) {
        if (this.conversationLocked || conversationId === this.currentConversationId) {
            return;
        }

        this.conversationLocked = true;

        try {
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.isTyping = false;
            this.removeTypingIndicator();

            console.log(`ðŸ”„ Switching from conversation ${this.currentConversationId} to ${conversationId}`);

            this.currentConversationId = conversationId;
            window.currentConversationId = conversationId;

            const response = await fetch(`/api/conversations/${conversationId}/switch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                await this.loadConversationMessages(conversationId);

                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }

                console.log(`âœ… Successfully switched to conversation ${conversationId}`);
            }
        } catch (error) {
            console.error('âŒ Error switching conversation:', error);
        } finally {
            setTimeout(() => {
                this.conversationLocked = false;
            }, 500);
        }
    }

    async loadConversationMessages(conversationId) {
        try {
            this.isTyping = false;
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.removeTypingIndicator();

            const response = await fetch(`/api/conversations/${conversationId}/messages`);
            const data = await response.json();

            if (conversationId !== this.currentConversationId) {
                console.warn('âš ï¸ Conversation changed during message loading');
                return;
            }

            if (data.success && data.messages) {
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                }

                if (data.messages.length === 0) {
                    // Show welcome message for new chats (ChatGPT style)
                    const welcomeHtml = this.createWelcomeMessage();
                    chatMessages.innerHTML = welcomeHtml;
                    console.log('âœ… Welcome message displayed for new chat');
                } else {
                    // Load existing messages
                    data.messages.forEach(msg => {
                        const senderType = msg.sender_type === 'user' ? 'customer' : 'ai';
                        const metadata = msg.metadata || {};
                        this.addMessageToChatDisplay(msg.content, senderType, false, metadata);
                    });
                    console.log(`âœ… Loaded ${data.messages.length} messages for conversation ${conversationId}`);
                }
            }
        } catch (error) {
            console.error('âŒ Error loading conversation messages:', error);
        }
    }

    displayWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        this.isTyping = false;
        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
        }
        this.removeTypingIndicator();

        chatMessages.innerHTML = '';
        const welcomeHtml = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeHtml;
        this.smoothScrollToBottom();

        console.log('âœ… Welcome message displayed in modal');
    }
}

// Global functions for compatibility and modal control
function toggleChatModal() {
    console.log('ðŸ–±ï¸ Global toggleChatModal called');
    if (window.customerPortal) {
        window.customerPortal.toggleChatModal();
    } else {
        console.error('âŒ CustomerPortal not initialized');
    }
}

function openChatModal() {
    console.log('ðŸ–±ï¸ Global openChatModal called');
    if (window.customerPortal) {
        window.customerPortal.openChatModal();
    } else {
        console.error('âŒ CustomerPortal not initialized');
    }
}

function closeChatModal(event) {
    console.log('ðŸ–±ï¸ Global closeChatModal called');
    if (window.customerPortal) {
        window.customerPortal.closeChatModal(event);
    } else {
        console.error('âŒ CustomerPortal not initialized');
    }
}

function toggleConversationSidebar() {
    console.log('ðŸ–±ï¸ Global toggleConversationSidebar called');
    if (window.customerPortal) {
        window.customerPortal.toggleConversationSidebar();
    } else {
        console.error('âŒ CustomerPortal not initialized');
    }
}

function sendChatMessage() {
    console.log('ðŸ–±ï¸ Global sendChatMessage called');
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage();
    } else {
        console.error('âŒ CustomerPortal not initialized');
    }
}

function sendQuickMessage(message) {
    console.log(`ðŸ–±ï¸ Global sendQuickMessage called: ${message}`);
    if (window.customerPortal) {
        // Open modal if not already open
        if (!window.customerPortal.modalOpen) {
            window.customerPortal.openChatModal();
        }
        // Wait for modal to open before sending message
        setTimeout(() => {
        window.customerPortal.sendCustomerMessage(message);
        }, 400);
    } else {
        console.error('âŒ CustomerPortal not initialized');
    }
}

function trackOrderViaChat() {
    const orderIdInput = document.getElementById('orderIdInput');
    const orderId = orderIdInput?.value.trim();

    if (orderId) {
        sendQuickMessage(`Track my order ${orderId}`);
    } else {
        sendQuickMessage('Help me track my order');
    }
}

// ðŸ“¦ Enhanced Order Tracking Functions for Authenticated Users
async function loadMyOrders() {
    console.log('ðŸ”„ Loading orders...');

    // Get authentication status from multiple sources with fallback
    const sessionAuth = {{ 'true' if session.get('user_authenticated') else 'false' }};
    const sessionCustomerId = {{ session.get('customer_id') or 'null' }};
    const sessionUsername = '{{ session.get('username', '') }}';

    // Check for existing JavaScript variables with different names to avoid conflicts
    const existingAuth = typeof window.isAuthenticated !== 'undefined' ? window.isAuthenticated : false;
    const existingCustomerId = typeof window.customerId !== 'undefined' ? window.customerId : null;
    const existingUsername = typeof window.username !== 'undefined' ? window.username : '';

    // Use session data as primary source with fallbacks
    const isAuthenticated = sessionAuth;
    const customerId = sessionCustomerId || existingCustomerId;
    const username = sessionUsername || existingUsername;

    console.log('ðŸ” Enhanced Session Debug Info:', {
        sessionAuth: sessionAuth,
        sessionCustomerId: sessionCustomerId,
        sessionUsername: sessionUsername,
        existingAuth: existingAuth,
        existingCustomerId: existingCustomerId,
        existingUsername: existingUsername,
        finalAuth: isAuthenticated,
        finalCustomerId: customerId,
        finalUsername: username
    });

    // Get DOM elements first
    const loadingState = document.getElementById('orderLoadingState');
    const ordersContainer = document.getElementById('ordersListContainer');
    const noOrdersState = document.getElementById('noOrdersState');
    const refreshBtn = document.getElementById('refreshOrdersBtn');

    // Ensure refresh button is enabled and reset, regardless of authentication
    if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
        console.log('âœ… Refresh button reset to enabled state');
    } else {
        console.warn('âš ï¸ Refresh button not found in DOM');
    }

    // Check authentication
    if (!isAuthenticated) {
        console.error('âŒ User not authenticated');
        showAlert('Please log in to view your orders. <a href="/login" class="alert-link">Click here to login</a>', 'warning');

        // Show login prompt instead of orders
        if (ordersContainer) {
            ordersContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">Authentication Required</h5>
                    <p class="text-muted">Please log in to view your order history</p>
                    <a href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Login to View Orders
                    </a>
                </div>
            `;
            ordersContainer.style.display = 'block';
        }
        if (loadingState) loadingState.style.display = 'none';
        if (noOrdersState) noOrdersState.style.display = 'none';
        return;
    }

    if (!customerId) {
        console.error('âŒ Customer ID not found in session');
        showAlert('Session error: Customer ID missing. Please try logging in again. <a href="/login" class="alert-link">Login</a>', 'error');

        if (ordersContainer) {
            ordersContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">Session Issue</h5>
                    <p class="text-muted">Your session appears to be incomplete. Please log in again.</p>
                    <a href="/login" class="btn btn-warning">
                        <i class="bi bi-arrow-clockwise me-2"></i>Login Again
                    </a>
                </div>
            `;
            ordersContainer.style.display = 'block';
        }
        if (loadingState) loadingState.style.display = 'none';
        if (noOrdersState) noOrdersState.style.display = 'none';
        return;
    }

    // Show loading state and disable refresh button
    if (loadingState) {
        loadingState.style.display = 'block';
        console.log('âœ… Loading state shown');
    } else {
        console.warn('âš ï¸ Loading state element not found');
    }

    if (ordersContainer) {
        ordersContainer.style.display = 'none';
        console.log('âœ… Orders container hidden');
    } else {
        console.warn('âš ï¸ Orders container element not found');
    }

    if (noOrdersState) {
        noOrdersState.style.display = 'none';
        console.log('âœ… No orders state hidden');
    } else {
        console.warn('âš ï¸ No orders state element not found');
    }

    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Loading...';
    }

    try {
        console.log('ðŸŒ Making API call to fetch orders...');
        const response = await fetch('/api/orders/my-orders?limit=10', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        console.log('ðŸ“¡ API Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('ðŸ“Š API Response data:', data);

        if (data.success && data.orders && data.orders.length > 0) {
            console.log(`âœ… Found ${data.orders.length} orders, displaying...`);
            displayOrdersList(data.orders);
        } else if (data.success && (!data.orders || data.orders.length === 0)) {
            console.log('â„¹ï¸ No orders found for user');
            // Show no orders state
            if (loadingState) loadingState.style.display = 'none';
            if (noOrdersState) {
                noOrdersState.style.display = 'block';
                noOrdersState.innerHTML = `
                    <div class="empty-state text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No Orders Found</h5>
                        <p class="text-muted">You haven't placed any orders yet. Start shopping to see your orders here!</p>
                        <button class="btn btn-primary" onclick="sendQuickMessage('Show me your product catalog')">
                            <i class="bi bi-shop me-2"></i>Browse Products
                        </button>
                    </div>
                `;
            }
            if (ordersContainer) ordersContainer.style.display = 'none';
        } else {
            throw new Error(data.message || data.error || 'Failed to load orders');
        }

    } catch (error) {
        console.error('âŒ Error loading orders:', error);

        // Show detailed error in orders container
        if (ordersContainer) {
            ordersContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Error loading orders:</strong> ${error.message}
                    <br><small class="text-muted">Check browser console for more details</small>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-danger" onclick="loadMyOrders()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Retry Loading
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="window.location.reload()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Page
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-2" onclick="console.log('Debug info:', {isAuthenticated: ${isAuthenticated}, customerId: ${customerId}, currentURL: window.location.href, timestamp: new Date().toISOString(), error: '${error.message}'})">
                            <i class="bi bi-bug me-1"></i>Debug Info
                        </button>
                    </div>
                </div>
            `;
            ordersContainer.style.display = 'block';
        }

        if (loadingState) loadingState.style.display = 'none';
        if (noOrdersState) noOrdersState.style.display = 'none';

        // Show user-friendly error message
        showAlert(`Unable to load orders: ${error.message}`, 'error');
    } finally {
        // Always ensure refresh button is re-enabled
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
            console.log('âœ… Refresh button re-enabled in finally block');
        }
        console.log('ðŸ”„ Order loading process completed');
    }
}

function displayOrdersList(orders) {
    console.log('ðŸ“‹ Displaying orders list:', orders);

    const ordersContainer = document.getElementById('ordersListContainer');
    const loadingState = document.getElementById('orderLoadingState');
    const noOrdersState = document.getElementById('noOrdersState');

    if (!ordersContainer) {
        console.error('âŒ Orders container not found!');
        return;
    }

    console.log('âœ… Orders container found:', ordersContainer);

    // Hide loading and no orders states
    if (loadingState) {
        loadingState.style.display = 'none';
        console.log('âœ… Loading state hidden');
    }
    if (noOrdersState) {
        noOrdersState.style.display = 'none';
        console.log('âœ… No orders state hidden');
    }

    // Generate orders HTML
    const ordersHtml = orders.map(order => {
        console.log('ðŸ” Processing order:', order);

        const statusBadgeClass = getOrderStatusBadgeClass(order.status);

        // Handle order date properly - fix date parsing
        let orderPlacedDate = 'Unknown Date';
        let expectedDeliveryDate = 'Not specified';

        // ðŸ”§ FIX: Use created_at for order placement date
        if (order.created_at) {
            try {
                const date = new Date(order.created_at);
                if (!isNaN(date.getTime())) {
                    orderPlacedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (e) {
                console.warn('Created date parsing error:', e);
                orderPlacedDate = order.created_at ? order.created_at.toString() : 'Unknown Date';
            }
        }

        // ðŸ”§ FIX: Use order_date (delivery_date) for expected delivery
        if (order.order_date) {
            try {
                const date = new Date(order.order_date);
                if (!isNaN(date.getTime())) {
                    expectedDeliveryDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            } catch (e) {
                console.warn('Delivery date parsing error:', e);
                expectedDeliveryDate = order.order_date ? order.order_date.toString() : 'Not specified';
            }
        }

        // Format products list with better handling
        let productsText = 'No products found';
        let productCount = 0;

        if (order.products && Array.isArray(order.products) && order.products.length > 0) {
            productCount = order.products.length;
            const firstProduct = order.products[0];

            if (productCount === 1) {
                productsText = firstProduct.product_name || 'Unknown Product';
            } else {
                productsText = `${firstProduct.product_name || 'Unknown Product'} +${productCount - 1} more`;
            }
        } else if (order.items_count && order.items_count > 0) {
            productsText = `${order.items_count} item${order.items_count > 1 ? 's' : ''}`;
            productCount = order.items_count;
        }

        return `
            <div class="order-card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1">ðŸ“¦ Order #${order.order_id}</h6>
                            <small class="text-muted">${orderPlacedDate}</small>
                        </div>
                        <div class="col-md-3">
                            <span class="badge ${statusBadgeClass}">${order.status || 'Pending'}</span>
                            <div class="mt-1">
                                <small class="text-muted">${productCount} item${productCount !== 1 ? 's' : ''}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="products-section">
                                <small class="text-muted d-block">Products:</small>
                                <span class="fw-medium">${productsText}</span>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <strong class="text-success">â‚¦${parseFloat(order.total_amount || 0).toLocaleString()}</strong>
                        </div>
                        <div class="col-md-1">
                            <div class="btn-group-vertical" role="group">
                                <button class="btn btn-sm btn-primary"
                                        onclick="viewOrderDetails('${order.order_id}')"
                                        title="View complete order details and tracking information">
                                    <i class="bi bi-eye me-1"></i>Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    console.log('ðŸ“ Generated orders HTML length:', ordersHtml.length);

    // Display orders or empty state
    if (orders.length === 0) {
        console.log('ðŸ“‹ No orders to display, showing empty state');
        ordersContainer.innerHTML = `
            <div class="empty-state text-center py-5">
                <i class="bi bi-inbox text-muted"></i>
                <h5 class="mt-3 text-muted">No Orders Found</h5>
                <p class="text-muted">You haven't placed any orders yet. Start shopping to see your orders here!</p>
                <button class="btn btn-primary" onclick="sendQuickMessage('Show me your product catalog')">
                    <i class="bi bi-shop me-2"></i>Browse Products
                </button>
            </div>
        `;
    } else {
        console.log(`ðŸ“‹ Setting orders HTML for ${orders.length} orders`);
        ordersContainer.innerHTML = ordersHtml;
    }

    // **CRITICAL**: Ensure the orders container is visible
    ordersContainer.style.display = 'block';
    console.log('âœ… Orders container made visible:', ordersContainer.style.display);

    // Additional debugging
    console.log('ðŸ“‹ Orders container final state:', {
        innerHTML: ordersContainer.innerHTML.length + ' characters',
        display: ordersContainer.style.display,
        visible: ordersContainer.offsetHeight > 0,
        childCount: ordersContainer.children.length
    });
}

function getOrderStatusBadgeClass(status) {
    switch (status?.toLowerCase()) {
        case 'pending': return 'bg-warning text-dark';
        case 'processing': return 'bg-info';
        case 'delivered': return 'bg-success';
        case 'returned': return 'bg-secondary';
        case 'cancelled': return 'bg-danger';
        default: return 'bg-light text-dark';
    }
}

function trackSpecificOrder() {
    const orderIdInput = document.getElementById('orderIdInput');
    const orderId = orderIdInput?.value.trim();

    if (!orderId) {
        showAlert('Please enter an order ID', 'warning');
        return;
    }

    // Use the consolidated viewOrderDetails function instead
    viewOrderDetails(orderId);
}

async function viewOrderDetails(orderId) {
    console.log(`ðŸ‘ï¸ Viewing details for order: ${orderId}`);

    try {
        // Get or create modal instance (prevent duplicate instances)
        const modalElement = document.getElementById('orderTrackingModal');
        if (!modalElement) {
            console.error('âŒ Modal element not found');
            showAlert('Modal not found. Please refresh the page.', 'error');
            return;
        }

        // Clean up any existing modal instance to prevent conflicts
        const existingModalInstance = bootstrap.Modal.getInstance(modalElement);
        if (existingModalInstance) {
            console.log('ðŸ§¹ Cleaning up existing modal instance');
            existingModalInstance.dispose();
        }

        // Create fresh modal instance
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });

        const modalBody = document.querySelector('#orderTrackingModal .modal-body');

        if (!modalBody) {
            console.error('âŒ Modal body not found');
            showAlert('Modal structure incomplete. Please refresh the page.', 'error');
            return;
        }

        // Add cleanup listener to prevent memory leaks
        modalElement.addEventListener('hidden.bs.modal', function cleanupModalHandler(event) {
            console.log('ðŸ§¹ Modal closed - performing cleanup');

            // Remove this event listener to prevent accumulation
            modalElement.removeEventListener('hidden.bs.modal', cleanupModalHandler);

            // Clear any pending timeouts or intervals
            if (window.modalRefreshTimeout) {
                clearTimeout(window.modalRefreshTimeout);
                window.modalRefreshTimeout = null;
            }

            // Reset modal content to prevent stale data
            if (modalBody) {
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">Modal closed. Click Details to reopen.</p>
                    </div>
                `;
            }

            console.log('âœ… Modal cleanup complete');
        }, { once: true }); // Ensure it only runs once

        modalBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading order details...</span>
                </div>
                <p class="mt-2 text-muted">Loading comprehensive order details...</p>
            </div>
        `;

        modal.show();

        // Fetch order details with timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

        try {
            const response = await fetch(`/api/orders/status/${orderId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`Failed to fetch order details (${response.status})`);
            }

            const data = await response.json();

            if (data.success && data.order) {
                console.log('âœ… Order details loaded successfully');
                displayEnhancedOrderModal(data.order);
            } else {
                throw new Error(data.message || data.error || 'Order details not available');
            }

        } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
                throw new Error('Request timed out. Please try again.');
            }
            throw fetchError;
        }

    } catch (error) {
        console.error('âŒ Error loading order details:', error);

        // Show user-friendly error without exposing SQL details
        const errorMessage = error.message.includes('SQL') || error.message.includes('database')
            ? 'Unable to load order details. Please try again or contact support.'
            : error.message;

        showOrderErrorModal(orderId, errorMessage);
    }
}

function displayEnhancedOrderModal(order) {
    console.log('ðŸ“‹ Displaying enhanced order modal:', order);

    const modalBody = document.querySelector('#orderTrackingModal .modal-body');
    const modalTitle = document.querySelector('#orderTrackingModal .modal-title');

    // Set modal title
    modalTitle.innerHTML = `
        <i class="bi bi-box-seam me-2"></i>
        Order #${order.order_id} - Complete Details
    `;

    // ðŸ”§ FIX: Use created_at for order placement date
    let orderPlacedDate = 'Unknown Date';
    let expectedDeliveryDate = 'Not specified';

    if (order.created_at) {
        try {
            const date = new Date(order.created_at);
            if (!isNaN(date.getTime())) {
                orderPlacedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        } catch (e) {
            console.warn('Created date parsing error:', e);
            orderPlacedDate = 'Unknown Date';
        }
    }

    // ðŸ”§ FIX: Use delivery_date for expected delivery
    if (order.delivery_date || order.order_date) {
        try {
            const date = new Date(order.delivery_date || order.order_date);
            if (!isNaN(date.getTime())) {
                expectedDeliveryDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        } catch (e) {
            console.warn('Delivery date parsing error:', e);
        }
    }

    // Generate status badge
    const statusBadgeClass = getOrderStatusBadgeClass(order.status);
    const statusIcon = getOrderStatusIcon(order.status);

    // Generate products list
    let productsHtml = '';
    if (order.products && order.products.length > 0) {
        productsHtml = `
            <div class="mb-4">
                <h6><i class="bi bi-box me-2"></i>Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Brand</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.products.map(product => `
                                <tr>
                                    <td class="fw-medium">${product.product_name || 'Unknown Product'}</td>
                                    <td><span class="badge bg-secondary">${product.category || 'N/A'}</span></td>
                                    <td>${product.brand || 'N/A'}</td>
                                    <td class="text-success fw-bold">â‚¦${parseFloat(product.price || 0).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else {
        productsHtml = `
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                Product details not available for this order.
            </div>
        `;
    }

    // Generate tracking timeline
    const trackingTimeline = generateTrackingTimeline(order.status, orderPlacedDate);

    // Generate delivery information
    const deliveryInfo = generateDeliveryInfo(order);

    modalBody.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-info-circle text-primary me-2"></i>Order Status
                        </h6>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge ${statusBadgeClass} me-2">${statusIcon} ${order.status || 'Pending'}</span>
                        </div>
                        <small class="text-muted">Order placed on ${orderPlacedDate}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-currency-exchange text-success me-2"></i>Payment & Total
                        </h6>
                        ${order.pricing_breakdown ? `
                        <!-- Detailed Pricing Breakdown -->
                        <div class="pricing-breakdown mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Subtotal:</span>
                                <span class="fw-medium">â‚¦${parseFloat(order.pricing_breakdown.subtotal || 0).toLocaleString()}</span>
                            </div>
                            ${order.pricing_breakdown.tier_discount > 0 ? `
                            <div class="d-flex justify-content-between mb-1 text-success">
                                <span>Tier Discount (${order.pricing_breakdown.tier_discount_rate.toFixed(0)}%):</span>
                                <span>-â‚¦${parseFloat(order.pricing_breakdown.tier_discount || 0).toLocaleString()}</span>
                            </div>
                            ` : ''}
                            <div class="d-flex justify-content-between mb-1">
                                <span>Delivery Fee${order.pricing_breakdown.tier_delivery_benefit ? ' (FREE for ' + order.pricing_breakdown.account_tier + ' tier)' : ' (' + (order.pricing_breakdown.delivery_zone || 'Standard') + ')'}:</span>
                                <span class="fw-medium">${order.pricing_breakdown.delivery_fee > 0 ? 'â‚¦' + parseFloat(order.pricing_breakdown.delivery_fee).toLocaleString() : 'FREE'}</span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Total Amount:</span>
                                <span class="text-success">â‚¦${parseFloat(order.pricing_breakdown.calculated_total || 0).toLocaleString()}</span>
                            </div>
                        </div>
                        ` : `
                        <!-- Fallback for orders without detailed breakdown -->
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-success">â‚¦${parseFloat(order.total_amount || 0).toLocaleString()}</span>
                            <span class="badge bg-info">${order.payment_method || 'Not specified'}</span>
                        </div>
                        `}
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            <span class="badge bg-info">${order.payment_method || 'Not specified'}</span>
                            ${order.pricing_breakdown && order.pricing_breakdown.tier_discount > 0 ? `
                            <small class="text-success">
                                <i class="bi bi-star-fill me-1"></i>Tier discount applied
                            </small>
                            ` : ''}
                        </div>
                        ${expectedDeliveryDate !== 'Not specified' ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-truck me-1"></i>Expected delivery: ${expectedDeliveryDate}
                                ${order.pricing_breakdown ? ` (${order.pricing_breakdown.delivery_days} days)` : ''}
                            </small>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>

        ${productsHtml}

        <div class="mb-4">
            <h6><i class="bi bi-truck me-2"></i>Order Tracking Timeline</h6>
            ${generateTrackingTimeline(order.status, orderPlacedDate)}
        </div>

        ${deliveryInfo}

        <div class="d-flex gap-2 mt-4">
            <button class="btn btn-outline-primary btn-sm" onclick="refreshOrderDetails('${order.order_id}')">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh Status
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="contactSupportAboutOrder('${order.order_id}')">
                <i class="bi bi-headset me-1"></i>Contact Support
            </button>
            ${order.status === 'Pending' ? `
                <button class="btn btn-outline-danger btn-sm" onclick="requestOrderCancellation('${order.order_id}')">
                    <i class="bi bi-x-circle me-1"></i>Request Cancellation
                </button>
            ` : ''}
        </div>
    `;
}

function getOrderStatusIcon(status) {
    switch (status?.toLowerCase()) {
        case 'pending': return 'â³';
        case 'processing': return 'ðŸ”„';
        case 'shipped': return 'ðŸšš';
        case 'delivered': return 'âœ…';
        case 'returned': return 'â†©ï¸';
        case 'cancelled': return 'âŒ';
        default: return 'ðŸ“¦';
    }
}

function generateTrackingTimeline(currentStatus, orderDate) {
    const statuses = [
        { status: 'Pending', icon: 'â³', description: 'Order received and being prepared' },
        { status: 'Processing', icon: 'ðŸ”„', description: 'Order is being processed for shipment' },
        { status: 'Shipped', icon: 'ðŸšš', description: 'Order has been shipped and is on the way' },
        { status: 'Delivered', icon: 'âœ…', description: 'Order has been delivered successfully' }
    ];

    const currentIndex = statuses.findIndex(s => s.status.toLowerCase() === currentStatus?.toLowerCase());

    return `
        <div class="tracking-timeline">
            ${statuses.map((statusInfo, index) => {
                const isCompleted = index <= currentIndex;
                const isCurrent = index === currentIndex;

                return `
                    <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
                        <div class="timeline-marker">
                            <span class="timeline-icon">${statusInfo.icon}</span>
                        </div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">${statusInfo.status}</h6>
                            <p class="timeline-description">${statusInfo.description}</p>
                            ${isCurrent ? `<small class="text-muted">Current status as of ${orderDate}</small>` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function generateDeliveryInfo(order) {
    if (!order.delivery_address && !order.state) {
        return '';
    }

    return `
        <div class="mb-4">
            <h6><i class="bi bi-geo-alt me-2"></i>Delivery Information</h6>
            <div class="card border-0 bg-light">
                <div class="card-body">
                    ${order.delivery_address ? `
                        <p class="mb-2">
                            <strong>Address:</strong><br>
                            ${order.delivery_address}
                        </p>
                    ` : ''}
                    ${order.state ? `
                        <p class="mb-2">
                            <strong>State:</strong> ${order.state}
                            ${order.lga ? ` - ${order.lga}` : ''}
                        </p>
                    ` : ''}
                    ${order.order_date ? `
                        <p class="mb-0">
                            <strong>Expected Delivery:</strong>
                            <span class="text-primary">${order.order_date}</span>
                        </p>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function showOrderErrorModal(orderId, errorMessage) {
    const modalBody = document.querySelector('#orderTrackingModal .modal-body');
    const modalTitle = document.querySelector('#orderTrackingModal .modal-title');

    if (!modalBody || !modalTitle) {
        console.error('âŒ Modal elements not found for error display');
        showAlert(`Error loading order #${orderId}: ${errorMessage}`, 'error');
        return;
    }

    modalTitle.innerHTML = `
        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
        Order #${orderId} - Unable to Load
    `;

    modalBody.innerHTML = `
        <div class="text-center py-5">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <h5 class="mt-3 text-muted">Unable to Load Order Details</h5>
            <p class="text-muted">${errorMessage}</p>

            <div class="mt-4">
                <button class="btn btn-primary me-2" onclick="viewOrderDetails('${orderId}')">
                    <i class="bi bi-arrow-clockwise me-1"></i>Try Again
                </button>
                <button class="btn btn-outline-secondary" onclick="contactSupportAboutOrder('${orderId}')">
                    <i class="bi bi-headset me-1"></i>Contact Support
                </button>
            </div>
        </div>
    `;
}

// Helper functions for order actions
async function refreshOrderDetails(orderId) {
    console.log(`ðŸ”„ Refreshing order details for: ${orderId}`);

    try {
        // Clear any existing timeout to prevent conflicts
        if (window.modalRefreshTimeout) {
            clearTimeout(window.modalRefreshTimeout);
            window.modalRefreshTimeout = null;
        }

        // Show loading state in the modal body
        const modalBody = document.querySelector('#orderTrackingModal .modal-body');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Refreshing order details...</span>
                    </div>
                    <p class="mt-2 text-muted">Refreshing order information...</p>
                </div>
            `;

            // Set timeout to refresh
            window.modalRefreshTimeout = setTimeout(async () => {
                const controller = new AbortController();
                const fetchTimeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout

                try {
                    const response = await fetch(`/api/orders/status/${orderId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });

                    clearTimeout(fetchTimeoutId);

                    if (!response.ok) {
                        throw new Error(`Failed to refresh order details (${response.status})`);
                    }

                    const data = await response.json();

                    if (data.success && data.order) {
                        console.log('âœ… Order details refreshed successfully');
                        displayEnhancedOrderModal(data.order);
                    } else {
                        throw new Error(data.message || data.error || 'Order details not available');
                    }

                } catch (fetchError) {
                    clearTimeout(fetchTimeoutId);
                    clearTimeout(window.modalRefreshTimeout);
                    window.modalRefreshTimeout = null;

                    if (fetchError.name === 'AbortError') {
                        throw new Error('Refresh timed out. Please try again.');
                    }
                    throw fetchError;
                }

            }, 1500); // 1.5 second delay for UX

        } else {
            // Fallback: Just refresh normally if modal body not found
            await viewOrderDetails(orderId);
        }
    } catch (error) {
        console.error('âŒ Error refreshing order details:', error);

        // Clear any pending timeouts
        if (window.modalRefreshTimeout) {
            clearTimeout(window.modalRefreshTimeout);
            window.modalRefreshTimeout = null;
        }

        const errorMessage = error.message.includes('SQL') || error.message.includes('database')
            ? 'Unable to refresh order details. Please contact support.'
            : error.message;

        showAlert(`Refresh failed: ${errorMessage}`, 'error');

        // Show error in modal
        const modalBody = document.querySelector('#orderTrackingModal .modal-body');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <h6 class="mt-3">Refresh Failed</h6>
                    <p class="text-muted">${errorMessage}</p>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm me-2" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-arrow-clockwise me-1"></i>Try Again
                        </button>
                        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                            <i class="bi bi-x me-1"></i>Close
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

// ðŸ”§ NEW: Demo function to show proper pricing breakdown
function showSampleOrderModal() {
    console.log('ðŸ“‹ Displaying sample order with proper pricing breakdown');

    // Sample order data with detailed pricing breakdown (Car Battery example)
    const sampleOrder = {
        order_id: 'RQB202501011',
        customer_name: 'Sample Customer',
        status: 'Processing',
        payment_method: 'Bank Transfer',
        created_at: '2025-05-26T10:00:00Z',
        delivery_address: 'Lagos, Nigeria',
        state: 'Lagos',
        products: [{
            product_name: 'Car Battery 12V 75Ah',
            category: 'Automotive',
            brand: 'Exide',
            price: 85000.00,
            quantity: 1
        }],
        pricing_breakdown: {
            subtotal: 85000.00,
            delivery_fee: 2500.00,
            tier_discount: 8500.00,
            tier_discount_rate: 10,
            calculated_total: 79000.00,
            original_total: 56897.61,
            delivery_zone: 'Lagos Metro',
            delivery_days: 2
        },
        total_amount: 79000.00
    };

    // Show modal with sample data
    const modalElement = document.getElementById('orderTrackingModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    displayEnhancedOrderModal(sampleOrder);
}

function contactSupportAboutOrder(orderId) {
    console.log(`ðŸ“ž Contacting support about order: ${orderId}`);
    sendQuickMessage(`I need help with my order #${orderId}. Can you provide me with the current status and any updates?`);
}

async function requestOrderCancellation(orderId) {
    console.log(`âŒ Requesting cancellation for order: ${orderId}`);

    const confirmed = confirm(`Are you sure you want to request cancellation for order #${orderId}? This action cannot be undone.`);

    if (confirmed) {
        try {
            const response = await fetch(`/api/orders/cancel/${orderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason: 'Customer requested cancellation via order details'
                })
            });

            const data = await response.json();

            if (data.success) {
                showAlert('Cancellation request submitted successfully', 'success');
                // Refresh the order details
                setTimeout(() => {
                    viewOrderDetails(orderId);
                }, 1000);
            } else {
                throw new Error(data.message || 'Failed to submit cancellation request');
            }

        } catch (error) {
            console.error('âŒ Error requesting cancellation:', error);
            const errorMessage = error.message.includes('SQL') || error.message.includes('database')
                ? 'Unable to process cancellation request. Please contact support.'
                : error.message;
            showAlert(`Error: ${errorMessage}`, 'error');
        }
    }
}

function cancelOrderPrompt(orderId) {
    const confirmCancel = confirm(`Are you sure you want to cancel order #${orderId}?`);
    if (confirmCancel) {
        cancelOrderById(orderId);
    }
}

async function cancelOrderById(orderId) {
    console.log(`âŒ Cancelling order: ${orderId}`);

    try {
        const response = await fetch(`/api/orders/cancel/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                reason: 'Customer requested cancellation'
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Order cancelled successfully', 'success');
            // Refresh orders list
            setTimeout(() => loadMyOrders(), 1000);
        } else {
            throw new Error(data.message || 'Failed to cancel order');
        }

    } catch (error) {
        console.error('âŒ Error cancelling order:', error);
        showAlert(`Error cancelling order: ${error.message}`, 'danger');
    }
}

function showAlert(message, type = 'info') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    // Find a container to show the alert
    const container = document.getElementById('ordersListContainer') || document.querySelector('.tab-content');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);

        // Auto-remove alert after 5 seconds
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendChatMessage();
    }
}

// Add missing handleModalClick function to prevent errors
function handleModalClick(event) {
    // Prevent event propagation to avoid closing modal when clicking inside
    event.stopPropagation();
    console.log('ðŸ–±ï¸ Modal content clicked - preventing close');
}

async function createNewChat() {
    console.log('ðŸ†• Creating new chat...');
    try {
        const response = await fetch('/api/conversations/new', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            console.log(`âœ… New chat created: ${data.conversation_id}`);
            if (window.customerPortal) {
                await window.customerPortal.switchToConversation(data.conversation_id);
                await window.customerPortal.refreshConversationList();
            }
        }
    } catch (error) {
        console.error('âŒ Error creating new chat:', error);
    }
}

async function switchToConversation(conversationId) {
    console.log(`ðŸ”„ Global switchToConversation called: ${conversationId}`);
    if (window.customerPortal) {
        await window.customerPortal.switchToConversation(conversationId);
    } else {
        console.error('âŒ CustomerPortal not initialized');
    }
}

// Initialize floating modal chat portal when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ DOM loaded, initializing raqibtech.com Floating Modal Chat System');

    // Add small delay to ensure all elements are ready
    setTimeout(() => {
        try {
            window.customerPortal = new CustomerSupportPortal();

            const isAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
            const currentConversationId = '{{ current_conversation_id if current_conversation_id else '' }}';

            console.log(`ðŸ” Auth: ${isAuthenticated}, ConvID: ${currentConversationId}`);
            console.log('âœ… Floating modal chat system ready!');

            // ðŸ”§ Enhanced refresh button setup
            if (isAuthenticated) {
                console.log('ðŸ‘¤ User authenticated - setting up refresh button enhancements');
                setupRefreshButtonEnhancements();

                // Test button after setup
                setTimeout(() => {
                    testRefreshButton();
                }, 500);
            }

            // ðŸ”§ DEBUG: Add click test for floating button
            const floatingBtn = document.getElementById('floatingChatBtn');
            if (floatingBtn) {
                console.log('âœ… Floating button found and ready');

                // Test button interactivity
                floatingBtn.addEventListener('mouseenter', () => {
                    console.log('ðŸ–±ï¸ Mouse entered floating button');
                });

                floatingBtn.addEventListener('mouseleave', () => {
                    console.log('ðŸ–±ï¸ Mouse left floating button');
                });
            } else {
                console.error('âŒ Floating button not found!');
            }

        } catch (error) {
            console.error('âŒ Error initializing chat system:', error);
        }
    }, 200);

    // Additional setup for refresh button after longer delay
    setTimeout(() => {
        const refreshBtn = document.getElementById('refreshOrdersBtn');
        if (refreshBtn) {
            console.log('ðŸ”§ Final refresh button check and setup');
            resetRefreshButton();
        }
    }, 1000);
});

console.log('âœ… Modal system loaded and ready');

// Global debugging functions for console access
window.debugRefreshButton = function() {
    console.log('ðŸ› === REFRESH BUTTON DEBUG INFO ===');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    console.log('Button element:', refreshBtn);

    if (refreshBtn) {
        console.log('Button properties:', {
            id: refreshBtn.id,
            disabled: refreshBtn.disabled,
            innerHTML: refreshBtn.innerHTML,
            style: refreshBtn.style.cssText,
            onclick: refreshBtn.onclick,
            eventListeners: refreshBtn.cloneNode().outerHTML
        });

        console.log('Parent elements:', {
            parent: refreshBtn.parentElement,
            parentVisible: refreshBtn.parentElement ? window.getComputedStyle(refreshBtn.parentElement).display : 'N/A'
        });
    }

    // Test authentication variables
    const sessionAuth = {{ 'true' if session.get('user_authenticated') else 'false' }};
    const sessionCustomerId = {{ session.get('customer_id') or 'null' }};

    console.log('Authentication status:', {
        sessionAuth: sessionAuth,
        sessionCustomerId: sessionCustomerId,
        jsAuth: typeof isAuthenticated !== 'undefined' ? isAuthenticated : 'undefined',
        jsCustomerId: typeof customerId !== 'undefined' ? customerId : 'undefined'
    });

    console.log('ðŸ› === END DEBUG INFO ===');
    return refreshBtn;
};

window.fixRefreshButton = function() {
    console.log('ðŸ”§ === FIXING REFRESH BUTTON ===');

    const result = resetRefreshButton();
    if (result) {
        console.log('âœ… Refresh button fixed successfully');
        // Test the fix
        setTimeout(() => {
            testRefreshButton();
        }, 100);
    } else {
        console.log('âŒ Failed to fix refresh button');
    }

    return result;
};

window.testRefresh = function() {
    console.log('ðŸ§ª === TESTING REFRESH FUNCTIONALITY ===');

    // Test the button
    const buttonTest = testRefreshButton();

    // Test the function directly
    console.log('ðŸ§ª Testing loadMyOrders function directly...');
    try {
        loadMyOrders();
        console.log('âœ… loadMyOrders called successfully');
    } catch (error) {
        console.error('âŒ loadMyOrders failed:', error);
    }

    return buttonTest;
};

console.log('ðŸ› Debug functions available: debugRefreshButton(), fixRefreshButton(), testRefresh()');

// Enhanced refresh button responsiveness and debugging
function testRefreshButton() {
    console.log('ðŸ§ª Testing refresh button responsiveness...');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    if (!refreshBtn) {
        console.error('âŒ Refresh button not found!');
        return false;
    }

    console.log('âœ… Refresh button found:', {
        id: refreshBtn.id,
        disabled: refreshBtn.disabled,
        innerHTML: refreshBtn.innerHTML,
        onclick: refreshBtn.onclick,
        eventListeners: refreshBtn.hasAttribute('onclick')
    });

    // Test click simulation
    try {
        refreshBtn.click();
        console.log('âœ… Button click simulation successful');
        return true;
    } catch (error) {
        console.error('âŒ Button click simulation failed:', error);
        return false;
    }
}

// Enhanced button event handling to prevent issues
function setupRefreshButtonEnhancements() {
    console.log('ðŸ”§ Setting up refresh button enhancements...');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    if (!refreshBtn) {
        console.warn('âš ï¸ Refresh button not found during setup');
        return;
    }

    // Remove any existing event listeners and add a robust one
    refreshBtn.removeAttribute('onclick');

    // Add enhanced click handler with debouncing
    let isLoading = false;
    refreshBtn.addEventListener('click', async function(event) {
        event.preventDefault();
        event.stopPropagation();

        console.log('ðŸ–±ï¸ Refresh button clicked');

        // Prevent multiple simultaneous calls
        if (isLoading) {
            console.log('âš ï¸ Already loading, ignoring click');
            return;
        }

        isLoading = true;

        try {
            await loadMyOrders();
        } catch (error) {
            console.error('âŒ Error in refresh button handler:', error);
        } finally {
            isLoading = false;
        }
    });

    // Add visual feedback
    refreshBtn.addEventListener('mousedown', function() {
        this.style.transform = 'scale(0.95)';
    });

    refreshBtn.addEventListener('mouseup', function() {
        this.style.transform = 'scale(1)';
    });

    refreshBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });

    console.log('âœ… Refresh button enhancements applied');
}

// Function to reset refresh button if it gets stuck
function resetRefreshButton() {
    console.log('ðŸ”„ Resetting refresh button...');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
        refreshBtn.style.transform = 'scale(1)';
        console.log('âœ… Refresh button reset successfully');

        // Re-setup enhancements
        setupRefreshButtonEnhancements();

        return true;
    } else {
        console.error('âŒ Refresh button not found for reset');
        return false;
    }
}

// New Shopping & Checkout Functions
async function quickOrderProduct() {
    const productQuery = document.getElementById('quickShopInput').value.trim();
    const quantity = parseInt(document.getElementById('quickShopQuantity').value) || 1;
    const deliveryState = document.getElementById('quickShopState').value;

    if (!productQuery) {
        showAlert('Please describe what you want to order', 'warning');
        return;
    }

    try {
        showAlert('Searching for products...', 'info');

        // First, ask AI to find the product
        const response = await fetch('/api/enhanced-query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: `I want to order ${productQuery}, quantity ${quantity}, delivery to ${deliveryState}. Please help me place this order.`
            })
        });

        const data = await response.json();

        if (data.success && data.shopping_result) {
            // Show checkout modal with product details
            showCheckoutModal(data.shopping_result, quantity, deliveryState);
        } else {
            showAlert('Product not found or out of stock. Try asking our AI assistant for alternatives.', 'warning');
        }
    } catch (error) {
        console.error('Quick order error:', error);
        showAlert('Unable to process order. Please try again.', 'error');
    }
}

function askAIForProduct() {
    const productQuery = document.getElementById('quickShopInput').value.trim();
    if (productQuery) {
        addUserMessage(`I want to buy ${productQuery}. Can you help me find it and place an order?`);
    } else {
        addUserMessage('I want to shop for products. Can you help me find what I need?');
    }
}

function browsePopularProducts() {
    addUserMessage('Show me popular products available for purchase in Nigeria');
}

function reorderPreviousItem() {
    addUserMessage('I want to reorder my last purchased item. Can you help me with that?');
}

function trackGuestOrder() {
    const orderId = document.getElementById('guestOrderIdInput').value.trim();
    if (orderId) {
        addUserMessage(`Track my order ${orderId} - I want to know the current status, location, and estimated delivery time.`);
    } else {
        showAlert('Please enter your order ID', 'warning');
    }
}

function showCheckoutModal(productData, quantity, deliveryState) {
    // Populate checkout modal with product data
    const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));

    // Update product information
    document.getElementById('checkout-product-name').textContent = productData.product_name || 'Product';
    document.getElementById('checkout-product-category').textContent = productData.category || 'Category';
    document.getElementById('checkout-quantity').textContent = quantity;

    const unitPrice = parseFloat(productData.price) || 0;
    document.getElementById('checkout-unit-price').textContent = formatNaira(unitPrice);

    // Update customer information (if authenticated)
    const customerName = '{{ session.get("customer_name", "Customer") }}';
    const customerEmail = '{{ session.get("customer_email", "email@example.com") }}';
    const customerState = '{{ session.get("customer_state", "Lagos") }}';
    const customerTier = '{{ session.get("customer_tier", "Bronze") }}';

    document.getElementById('checkout-customer-name').textContent = customerName;
    document.getElementById('checkout-customer-email').textContent = customerEmail;
    document.getElementById('checkout-customer-state').textContent = customerState;
    document.getElementById('checkout-customer-tier').textContent = customerTier;

    // Update delivery information
    document.getElementById('checkout-delivery-state').textContent = deliveryState;

    // Calculate totals
    const subtotal = unitPrice * quantity;
    const deliveryFee = calculateDeliveryFee(deliveryState);
    const discount = calculateTierDiscount(subtotal, customerTier);
    const total = subtotal + deliveryFee - discount;

    document.getElementById('checkout-subtotal').textContent = formatNaira(subtotal);
    document.getElementById('checkout-delivery-fee').textContent = formatNaira(deliveryFee);
    document.getElementById('checkout-total').textContent = formatNaira(total);

    if (discount > 0) {
        document.getElementById('checkout-discount-amount').textContent = formatNaira(discount);
        document.getElementById('checkout-discount-row').style.display = 'flex';
    }

    // Store order data for confirmation
    window.currentOrderData = {
        product_id: productData.product_id,
        product_name: productData.product_name,
        quantity: quantity,
        unit_price: unitPrice,
        delivery_state: deliveryState,
        total_amount: total
    };

    modal.show();
}

function calculateDeliveryFee(state) {
    const fees = {
        'Lagos': 2500,
        'Abuja': 3000,
        'Kano': 3500,
        'Rivers': 3000,
        'Oyo': 3000
    };
    return fees[state] || 3500;
}

function calculateTierDiscount(subtotal, tier) {
    const discounts = {
        'Bronze': 0,
        'Silver': 0.05,
        'Gold': 0.10,
        'Platinum': 0.15
    };
    return subtotal * (discounts[tier] || 0);
}

function formatNaira(amount) {
    return `â‚¦${amount.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Checkout confirmation
document.addEventListener('DOMContentLoaded', function() {
    const confirmOrderBtn = document.getElementById('confirm-order-btn');
    if (confirmOrderBtn) {
        confirmOrderBtn.addEventListener('click', async function() {
            if (!window.currentOrderData) {
                showAlert('Order data missing. Please try again.', 'error');
                return;
            }

            try {
                const paymentMethod = document.getElementById('checkout-payment-method').value;

                const orderPayload = {
                    product_query: window.currentOrderData.product_name,
                    quantity: window.currentOrderData.quantity,
                    delivery_state: window.currentOrderData.delivery_state,
                    payment_method: paymentMethod
                };

                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderPayload)
                });

                const result = await response.json();

                if (result.success) {
                    // Hide checkout modal
                    bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();

                    // Show success modal
                    document.getElementById('success-order-id').textContent = result.order_id;
                    document.getElementById('success-total-amount').textContent = formatNaira(result.total_amount);
                    document.getElementById('success-payment-method').textContent = paymentMethod;
                    document.getElementById('success-delivery-date').textContent = result.estimated_delivery;

                    const successModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
                    successModal.show();

                    // Refresh orders list
                    setTimeout(() => {
                        loadMyOrders();
                    }, 2000);
                } else {
                    showAlert(result.message || 'Order failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Order confirmation error:', error);
                showAlert('Unable to process order. Please try again.', 'error');
            }
        });
    }
});

// ... existing code ...
</script>

<!-- Include Checkout Modal -->
{% include 'checkout.html' %}

<!-- Custom Styles for Enhanced Order Tracking -->
<style>
    .order-card {
        transition: all 0.2s ease;
        border: 1px solid #e3e6f0;
    }

    .order-card:hover {
        border-color: #5a5c69;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transform: translateY(-1px);
    }

    .raqibtech-branding {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        color: white;
        margin-bottom: 20px;
    }

    .brand-title {
        margin-bottom: 8px;
    }

    .brand-logo {
        font-size: 1.5rem;
        margin-right: 8px;
    }

    .brand-text {
        font-weight: bold;
        font-size: 1.8rem;
    }

    .brand-domain {
        color: #ffd700;
        font-weight: normal;
    }

    .brand-subtitle {
        margin-bottom: 12px;
        opacity: 0.9;
    }

    .brand-stats .badge {
        margin-right: 8px;
        margin-bottom: 4px;
    }

    .account-dashboard {
        background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e3e6f0;
    }

    .dashboard-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .dashboard-action-btn {
        background: white;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 12px;
        text-align: left;
        transition: all 0.2s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .dashboard-action-btn:hover {
        border-color: #5a5c69;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        background-color: #f8f9fc;
    }

    .action-icon {
        font-size: 1.5rem;
    }

    .action-text strong {
        display: block;
        color: #5a5c69;
        font-size: 0.9rem;
    }

    .action-text small {
        color: #858796;
        font-size: 0.75rem;
    }

    .auth-prompt-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #2196f3;
        border-radius: 12px;
    }

    .order-status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }

    .order-tracking-section {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .products-section {
        background-color: #f8f9fc;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e3e6f0;
    }

    .products-list .badge {
        font-size: 0.75rem;
        font-weight: normal;
    }

    .order-tracking-section {
        border-left: 4px solid #667eea;
    }

    .order-card .btn-group-vertical .btn {
        border-radius: 4px;
        margin-bottom: 2px;
    }

    .order-card .btn-group .btn {
        flex: 1;
    }

    .order-status-badge {
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .modal-body .table th {
        border-top: none;
        font-weight: 600;
        color: #5a5c69;
        font-size: 0.85rem;
    }

    .modal-body .table td {
        vertical-align: middle;
    }

    .btn:disabled {
        opacity: 0.6;
    }

    .alert {
        border: none;
        border-radius: 8px;
    }

    /* Enhanced Order Tracking Timeline Styles */
    .tracking-timeline {
        padding: 20px 0;
    }

    .timeline-item {
        display: flex;
        margin-bottom: 20px;
        position: relative;
    }

    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 20px;
        top: 40px;
        width: 2px;
        height: calc(100% + 10px);
        background-color: #e3e6f0;
        z-index: 1;
    }

    .timeline-item.completed:not(:last-child)::after {
        background-color: #1cc88a;
    }

    .timeline-marker {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e3e6f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        position: relative;
        z-index: 2;
        flex-shrink: 0;
    }

    .timeline-item.completed .timeline-marker {
        background-color: #1cc88a;
        color: white;
    }

    .timeline-item.current .timeline-marker {
        background-color: #4e73df;
        color: white;
        animation: pulse 2s infinite;
    }

    .timeline-icon {
        font-size: 16px;
    }

    .timeline-content {
        flex: 1;
        padding-top: 5px;
    }

    .timeline-title {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 600;
        color: #5a5c69;
    }

    .timeline-item.completed .timeline-title {
        color: #1cc88a;
    }

    .timeline-item.current .timeline-title {
        color: #4e73df;
    }

    .timeline-description {
        margin: 0;
        color: #858796;
        font-size: 14px;
        line-height: 1.4;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(78, 115, 223, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0);
        }
    }

    /* Enhanced order modal styles */
    .modal-lg {
        max-width: 900px;
    }

    .order-details-card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border-radius: 12px;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }

    .delivery-info-card {
        background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
        border: 1px solid #e3e6f0;
        border-radius: 12px;
    }
</style>

<!-- Order Tracking Modal -->
<div class="modal fade" id="orderTrackingModal" tabindex="-1" aria-labelledby="orderTrackingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderTrackingModalLabel">
                    <i class="bi bi-box-seam me-2"></i>Order Tracking Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Order tracking content will be dynamically loaded here -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading order details...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading comprehensive order information...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Integrated Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="checkoutModalLabel">
                    <i class="fas fa-shopping-cart me-2"></i>Order Confirmation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Order Summary Section -->
                <div class="row">
                    <div class="col-md-8">
                        <!-- Product Details -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-box me-2"></i>Product Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="product-image me-3">
                                        <div class="bg-light rounded p-3" style="width: 80px; height: 80px;">
                                            <i class="fas fa-mobile-alt fa-2x text-muted"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" id="checkout-product-name">Product Name</h6>
                                        <p class="text-muted mb-1" id="checkout-product-category">Category</p>
                                        <div class="d-flex justify-content-between">
                                            <span>Quantity: <span id="checkout-quantity">1</span></span>
                                            <span class="fw-bold" id="checkout-unit-price">â‚¦0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Information -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Customer Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <strong>Name:</strong> <span id="checkout-customer-name">Customer Name</span>
                                    </div>
                                    <div class="col-sm-6">
                                        <strong>Email:</strong> <span id="checkout-customer-email">email@example.com</span>
                                    </div>
                                    <div class="col-sm-6 mt-2">
                                        <strong>State:</strong> <span id="checkout-customer-state">Lagos</span>
                                    </div>
                                    <div class="col-sm-6 mt-2">
                                        <strong>Account Tier:</strong>
                                        <span class="badge" id="checkout-customer-tier">Bronze</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Information -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-truck me-2"></i>Delivery Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <strong>Delivery State:</strong> <span id="checkout-delivery-state">Lagos</span>
                                    </div>
                                    <div class="col-sm-6">
                                        <strong>Estimated Delivery:</strong> <span id="checkout-delivery-days">3 days</span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <strong>Payment Method:</strong>
                                    <select class="form-select" id="checkout-payment-method">
                                        <option value="Pay on Delivery">Pay on Delivery</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Card">Card Payment</option>
                                        <option value="RaqibTechPay">RaqibTechPay</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Total Section -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Order Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="checkout-subtotal">â‚¦0.00</span>
                                </div>

                                <div class="d-flex justify-content-between mb-2 text-success" id="checkout-discount-row" style="display: none !important;">
                                    <span>Discount (<span id="checkout-discount-rate">0</span>%):</span>
                                    <span>-â‚¦<span id="checkout-discount-amount">0.00</span></span>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span>Delivery Fee:</span>
                                    <span id="checkout-delivery-fee">â‚¦0.00</span>
                                </div>

                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Total:</span>
                                    <span class="text-success" id="checkout-total">â‚¦0.00</span>
                                </div>

                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        Secure checkout powered by RaqibTech
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Nigerian Payment Methods Info -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-credit-card me-2"></i>Payment Options
                                </h6>
                                <div class="payment-methods">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-truck text-primary me-2"></i>
                                        <small>Pay on Delivery (Most Popular)</small>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-university text-success me-2"></i>
                                        <small>Bank Transfer</small>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-credit-card text-info me-2"></i>
                                        <small>Card Payment</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-mobile-alt text-warning me-2"></i>
                                        <small>RaqibTechPay</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirm-order-btn">
                    <i class="fas fa-check me-2"></i>Confirm Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order Success Modal -->
<div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-labelledby="orderSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="orderSuccessModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Order Confirmed!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 class="text-success mb-3">Order Successfully Placed!</h4>
                <p class="mb-3">Your order <strong id="success-order-id">#RQB20250101</strong> has been confirmed.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    You'll receive SMS and email confirmation shortly.
                </div>
                <div class="order-details">
                    <p><strong>Total Amount:</strong> <span id="success-total-amount">â‚¦0.00</span></p>
                    <p><strong>Payment Method:</strong> <span id="success-payment-method">Pay on Delivery</span></p>
                    <p><strong>Estimated Delivery:</strong> <span id="success-delivery-date">January 15, 2025</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>Great!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced raqibtech.com Account Section Styles -->
<style>
/* Account Container */
.account-container {
    padding: 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
}

/* Glassmorphism Brand Header Only - Compact */
.account-hero-glass {
    margin: 1.5rem;
    margin-bottom: 2rem;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 24px;
    border: 1px solid rgba(46, 204, 113, 0.2);
    box-shadow: 0 8px 32px rgba(46, 204, 113, 0.1);
    position: relative;
    overflow: hidden;
}

.account-hero-glass::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.08) 0%, rgba(39, 174, 96, 0.05) 100%);
    z-index: 1;
}

.hero-content-glass {
    position: relative;
    z-index: 2;
    text-align: center;
    padding: 2rem 2rem;
}

.brand-logo-glass {
    width: 64px;
    height: 64px;
    background: rgba(46, 204, 113, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    border: 2px solid rgba(46, 204, 113, 0.3);
    box-shadow: 0 4px 20px rgba(46, 204, 113, 0.2);
}

.account-brand-title-glass {
    color: #2c3e50;
    font-weight: 800;
    margin-bottom: 0.5rem;
    letter-spacing: -0.5px;
    text-shadow: 0 2px 10px rgba(46, 204, 113, 0.1);
    font-size: 2rem;
}

.account-brand-subtitle-glass {
    color: #495057;
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
    font-weight: 500;
}

.account-brand-stats-glass {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.stat-glass {
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(46, 204, 113, 0.2);
    border-radius: 20px;
    padding: 0.75rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #2c3e50;
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.1);
    transition: all 0.3s ease;
}

.stat-glass:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(46, 204, 113, 0.2);
    background: rgba(46, 204, 113, 0.1);
}

.stat-glass i {
    color: var(--brand-primary);
}

/* Welcome Section */
.welcome-section {
    padding: 0 2rem 2rem;
}

.welcome-card {
    background: white;
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(46, 204, 113, 0.1);
    display: flex;
    align-items: center;
    gap: 1.5rem;
    position: relative;
    overflow: hidden;
}

.welcome-card.authenticated {
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.05) 0%, rgba(39, 174, 96, 0.1) 100%);
}

.welcome-card.guest {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.1) 100%);
}

.welcome-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-dark));
    color: white;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.welcome-content h4 {
    margin-bottom: 0.5rem;
    color: #2c3e50;
    font-weight: 700;
}

.welcome-content p {
    margin: 0;
    color: #6c757d;
    line-height: 1.5;
}

.account-tier-display {
    margin-left: auto;
}

.tier-badge {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #8b5a00;
    padding: 0.75rem 1.25rem;
    border-radius: 25px;
    font-weight: 700;
    border: 2px solid rgba(255, 215, 0, 0.3);
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.auth-actions {
    display: flex;
    gap: 1rem;
    margin-left: auto;
}

/* Dashboard Section */
.dashboard-section {
    padding: 0 2rem 2rem;
}

.section-title {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
}

.section-title i {
    color: var(--brand-primary);
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}

.dashboard-card {
    background: white;
    border-radius: 1.25rem;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.dashboard-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(46, 204, 113, 0.15);
    border-color: var(--brand-primary);
}

.card-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    margin-bottom: 1rem;
}

.card-icon.orders {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.card-icon.benefits {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.card-icon.recommendations {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.card-icon.payments {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.card-content h6 {
    margin-bottom: 0.5rem;
    color: #2c3e50;
    font-weight: 700;
}

.card-content p {
    margin-bottom: 1rem;
    color: #6c757d;
    font-size: 0.9rem;
}

.card-badge {
    background: var(--brand-primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Services Section */
.services-section {
    padding: 0 2rem 2rem;
}

.service-card {
    background: white;
    border-radius: 1.25rem;
    border: 1px solid #e9ecef;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    height: 100%;
}

.service-header {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 1.25rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
}

.service-header i {
    color: var(--brand-primary);
    font-size: 1.1rem;
}

.service-header h6 {
    margin: 0;
    color: #2c3e50;
    font-weight: 600;
}

.service-actions {
    padding: 1rem;
}

.service-btn {
    background: none;
    border: none;
    width: 100%;
    padding: 1rem;
    text-align: left;
    border-radius: 0.75rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #495057;
}

.service-btn:hover {
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(39, 174, 96, 0.1));
    color: var(--brand-primary);
    transform: translateX(5px);
}

.service-btn i:first-child {
    color: var(--brand-primary);
    font-size: 1.1rem;
}

.service-btn i:last-child {
    color: #6c757d;
    font-size: 0.9rem;
}

/* Tier Card Specific */
.tier-card {
    border: 2px solid var(--brand-light);
}

.tier-progression {
    padding: 1rem;
}

.tier-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
    position: relative;
}

.tier-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 100%;
    width: 2px;
    height: 0.75rem;
    background: #e9ecef;
}

.tier-item.active::after {
    background: var(--brand-primary);
}

.tier-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #e9ecef;
    flex-shrink: 0;
}

.tier-item.bronze .tier-dot {
    background: #cd7f32;
}

.tier-item.silver .tier-dot {
    background: #c0c0c0;
}

.tier-item.gold .tier-dot {
    background: #ffd700;
}

.tier-item.platinum .tier-dot {
    background: #e5e4e2;
}

.tier-item.active .tier-dot {
    background: var(--brand-primary);
    box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
}

.tier-info strong {
    display: block;
    color: #2c3e50;
    font-weight: 600;
}

.tier-info small {
    color: #6c757d;
    font-size: 0.8rem;
}

.current-badge {
    background: var(--brand-primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: auto;
}

/* Responsive Design */
@media (max-width: 768px) {
    .account-hero-glass {
        margin: 1rem;
    }

    .hero-content-glass {
        padding: 1.5rem 1rem;
    }

    .account-brand-title-glass {
        font-size: 1.75rem;
    }

    .account-brand-stats-glass {
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .welcome-section,
    .dashboard-section,
    .services-section {
        padding: 0 1rem 1rem;
    }

    .welcome-card {
        flex-direction: column;
        text-align: center;
    }

    .auth-actions {
        margin-left: 0;
        width: 100%;
        justify-content: center;
    }

    .dashboard-grid {
        grid-template-columns: 1fr;
    }

    .tier-badge {
        margin-top: 1rem;
    }
}

/* Legacy styles for compatibility */
.raqibtech-branding {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.brand-title {
    font-size: 28px;
    font-weight: 800;
    margin: 0;
}

.brand-logo {
    font-size: 32px;
    margin-right: 8px;
}

.brand-text {
    color: #ffd700;
    letter-spacing: 1px;
}

.brand-domain {
    color: #ffffff;
    font-weight: 600;
}

.brand-subtitle {
    font-size: 16px;
    margin-bottom: 16px;
    opacity: 0.9;
    font-weight: 500;
}

.brand-stats .badge {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
}

/* Legacy Account Dashboard Styles */
.account-dashboard {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid #dee2e6;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.dashboard-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.dashboard-action-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.dashboard-action-btn:hover {
    border-color: #18bc9c;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(24, 188, 156, 0.2);
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
}

.action-icon {
    font-size: 24px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 12px;
    flex-shrink: 0;
}

.action-text strong {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.action-text small {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}
</style>

{% endblock %}

