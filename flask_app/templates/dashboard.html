{% extends "base.html" %}

{% block title %}raqibtech.com Customer Support - How can we help you?{% endblock %}

{% block content %}

<!-- ChatGPT-inspired styling with Flatly Bootswatch theme -->
<style>
/* Main chat container styling */
.chat-messages {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
}

/* Message styling - ChatGPT inspired */
.message {
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.message.customer {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 600;
    flex-shrink: 0;
}

.message.ai .message-avatar {
    background: #2c3e50;
    color: white;
}

.message.customer .message-avatar {
    background: #18bc9c;
    color: white;
}

.message-content {
    flex: 1;
    max-width: 75%;
}

.message-bubble {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 15px;
    line-height: 1.6;
    word-wrap: break-word;
}

.message.customer .message-bubble {
    background: #2c3e50;
    color: white;
    border-color: #2c3e50;
}

.message-meta {
    margin-top: 6px;
    font-size: 11px;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.message.customer .message-meta {
    flex-direction: row-reverse;
}

.response-time {
    font-size: 10px;
    color: #95a5a6;
    font-style: italic;
}

/* Welcome message special styling - Modern vibrant design */
.message.welcome .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    color: white;
    border: none;
    box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4), 0 5px 15px rgba(0, 0, 0, 0.1);
    border-radius: 20px;
    padding: 28px 32px;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(20px);
}

.message.welcome .message-bubble::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
    pointer-events: none;
    animation: shimmer 4s ease-in-out infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0.6; transform: rotate(0deg) scale(1); }
    50% { opacity: 1; transform: rotate(180deg) scale(1.1); }
}

.welcome-content {
    position: relative;
    z-index: 1;
}

.welcome-content h6 {
    font-size: 20px;
    font-weight: 800;
    color: #2C3E50;
    margin-bottom: 16px;
    letter-spacing: 0.5px;
}

.welcome-content p {
    font-size: 16px;
    line-height: 1.7;
    margin-bottom: 16px;
    opacity: 0.95;
    color: #2C3E50;
    font-weight: 500;
}

.welcome-content ul {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 16px;
    padding: 20px 24px;
    margin: 20px 0;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.welcome-content ul li {
    font-size: 15px;
    line-height: 1.6;
    padding: 6px 0;
    border-left: 4px solid rgba(255, 255, 255, 0.4);
    padding-left: 16px;
    margin-left: 12px;
    transition: all 0.3s ease;
    color: #2C3E50;
    font-weight: 500;
}

.welcome-content ul li:hover {
    border-left-color: #ffd700;
    transform: translateX(6px);
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding-right: 12px;
}

.welcome-content ul li strong {
    color: #2C3E50;
    font-weight: 700;
}

.welcome-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 24px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.welcome-quick-action-btn {
    background: linear-gradient(45deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
    color: #2C3E50;
    border: 1px solid rgba(255, 255, 255, 0.4);
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);

}

.welcome-quick-action-btn:hover {
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
    text-decoration: none;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
    text-shadow: none;
    border-color: #ffd700;
}

.welcome-quick-action-btn:active {
    transform: translateY(0);
}

/* Welcome message meta styling */
.message.welcome .message-meta {
    background: rgba(255, 255, 255, 0.15);
    padding: 12px 16px;
    border-radius: 12px;
    margin-top: 16px;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.message.welcome .message-meta .response-time {
    color: #2C3E50;
    font-style: italic;
    font-size: 13px;
    font-weight: 500;
}

/* Chat input styling */
.chat-input-container {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 12px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.chat-input-container .input-group {
    border: none;
}

.chat-input-container .form-control {
    border: none;
    padding: 12px 16px;
    font-size: 15px;
    background: transparent;
    box-shadow: none;
}

.chat-input-container .form-control:focus {
    border: none;
    box-shadow: none;
    background: transparent;
}

.chat-input-container .btn {
    border: none;
    padding: 12px 20px;
    background: #18bc9c;
    color: white;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
}

.chat-input-container .btn:hover {
    background: #16a085;
    transform: translateY(-1px);
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 12px;
    margin-top: 8px;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #95a5a6;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30% { transform: translateY(-8px); opacity: 1; }
}

/* Sidebar styling */
.conversation-item {
    border-radius: 8px;
    margin-bottom: 4px;
    transition: all 0.2s;
    cursor: pointer;
}

.conversation-item:hover {
    background-color: #f8f9fa;
    transform: translateX(4px);
}

.conversation-item.active {
    background-color: #18bc9c;
    color: white;
}

.conversation-item.active .text-muted {
    color: rgba(255, 255, 255, 0.8) !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .message-content {
        max-width: 85%;
    }

    .message-avatar {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }

    .message-bubble {
        padding: 12px 16px;
        font-size: 14px;
    }
}

/* Remove technical details completely */
.simple-tech-details,
.smart-quick-actions {
    display: none !important;
}

/* Smart Quick Actions Styling */
.smart-quick-actions-container {
    margin: 15px 0;
    padding: 0;
}

.smart-quick-actions {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.quick-actions-header {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    text-align: center;
}

.quick-actions-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}

.smart-quick-action-btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,123,255,0.3);
}

.smart-quick-action-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.4);
}

.smart-quick-action-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,123,255,0.3);
}

/* raqibtech.com Branding Styles */
.raqibtech-branding {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.brand-title {
    font-size: 28px;
    font-weight: 800;
    margin: 0;

}

.brand-logo {
    font-size: 32px;
    margin-right: 8px;
}

.brand-text {
    color: #ffd700;
    letter-spacing: 1px;
}

.brand-domain {
    color: #ffffff;
    font-weight: 600;
}

.brand-subtitle {
    font-size: 16px;
    margin-bottom: 16px;
    opacity: 0.9;
    font-weight: 500;
}

.brand-stats .badge {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
}

/* Account Dashboard Styles */
.account-dashboard {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid #dee2e6;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.dashboard-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.dashboard-action-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.dashboard-action-btn:hover {
    border-color: #18bc9c;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(24, 188, 156, 0.2);
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
}

.action-icon {
    font-size: 24px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 12px;
    flex-shrink: 0;
}

.action-text strong {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.action-text small {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

/* Responsive dashboard */
@media (max-width: 768px) {
    .dashboard-actions {
        grid-template-columns: 1fr;
    }

    .dashboard-action-btn {
        padding: 16px;
    }

    .action-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
}

/* üé® Enhanced Quick Actions for Smart Response */
.smart-quick-actions-container {
    margin: 15px 0;
    padding: 0;
}

.smart-quick-actions {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.quick-actions-header {
    font-size: 13px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    text-align: center;
}

.quick-actions-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}

.smart-quick-action-btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,123,255,0.3);
}

.smart-quick-action-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.4);
}

.smart-quick-action-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,123,255,0.3);
}

/* üÜï Conversation Management Styles */
.conversation-item {
    position: relative;
    transition: all 0.3s ease;
    cursor: pointer;
}

.conversation-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}

.conversation-item.active {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-left: 4px solid #2196f3;
}

.conversation-info {
    flex: 1;
    padding: 8px 0;
}

.conversation-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.conversation-item:hover .conversation-actions {
    opacity: 1;
}

.conversation-actions .btn-outline-danger {
    border: 1px solid #dc3545;
    color: #dc3545;
    background: transparent;
    transition: all 0.3s ease;
}

.conversation-actions .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
    transform: scale(1.1);
}

.conversation-actions .btn-outline-danger:active {
    transform: scale(0.95);
}

/* üîß FIX: Improved typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #6c757d;
    animation: typingPulse 1.4s ease-in-out infinite both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes typingPulse {
    0%, 80%, 100% {
        opacity: 0.4;
        transform: scale(0.8);
    }
    40% {
        opacity: 1;
        transform: scale(1);
    }
}

/* üÜï Enhanced Welcome Message Quick Actions */
.welcome-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin: 15px 0;
}

.welcome-quick-action-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 3px 6px rgba(40,167,69,0.3);
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.welcome-quick-action-btn:hover {
    background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(40,167,69,0.4);
}

.welcome-quick-action-btn:active {
    transform: translateY(0);
    box-shadow: 0 3px 6px rgba(40,167,69,0.3);
}

/* üîß FIX: Conversation list improvements */
#chatHistoryList .list-group-item {
    border-left: none;
    border-right: none;
    border-top: 1px solid #dee2e6;
    border-bottom: none;
    padding: 12px 15px;
}

#chatHistoryList .list-group-item:first-child {
    border-top: none;
}

#chatHistoryList .list-group-item:last-child {
    border-bottom: 1px solid #dee2e6;
}

/* üÜï Empty conversation state */
.empty-conversations {
    text-align: center;
    color: #6c757d;
    padding: 40px 20px;
}

.empty-conversations i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* üîß FIX: Loading states */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* üÜï Enhanced message meta styling */
.message-meta {
    margin-top: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

.message-meta span:first-child {
    font-size: 11px;
    color: #6c757d;
}

.response-time {
    font-size: 10px;
    color: #28a745;
    background: rgba(40,167,69,0.1);
    padding: 2px 6px;
    border-radius: 10px;
    white-space: nowrap;
}

/* üîß FIX: Responsive improvements */
@media (max-width: 768px) {
    .welcome-quick-actions {
        flex-direction: column;
        align-items: stretch;
    }

    .welcome-quick-action-btn {
        justify-content: center;
        width: 100%;
    }

    .quick-actions-buttons {
        flex-direction: column;
        align-items: stretch;
    }

    .smart-quick-action-btn {
        justify-content: center;
        width: 100%;
    }

    .conversation-actions {
        opacity: 1; /* Always visible on mobile */
    }
}
</style>

<!-- Session and User Info Header -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="session-info">
                {% if session.get('user_authenticated') %}
                    <span class="badge bg-success">
                        <i class="bi bi-person-check-fill me-1"></i>
                        Logged in as {{ session.get('user_email', 'User') }}
                    </span>
                {% else %}
                    <span class="badge bg-secondary">
                        <i class="bi bi-person me-1"></i>
                        Guest Session
                    </span>
                {% endif %}
            </div>
            <div class="session-actions">
                {% if session.get('user_authenticated') %}
                    <a href="/logout" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </a>
                {% else %}
                    <a href="/login" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Main Chat Interface with Sidebar -->
<div class="row">
    <!-- Chat History Sidebar -->
    <div class="col-lg-3 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-chat-left-text me-2"></i>Chat History
                </h6>
                <button class="btn btn-primary btn-sm" onclick="createNewChat()">
                    <i class="bi bi-plus-circle me-1"></i>New
                </button>
            </div>
            <div class="card-body p-0">
                <div id="chatHistoryList" class="list-group list-group-flush">
                    {% for conv in conversations %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start conversation-item"
                         data-conversation-id="{{ conv.conversation_id }}"
                         onclick="switchToConversation('{{ conv.conversation_id }}')">
                        <div class="conversation-info">
                            <h6 class="mb-1 conversation-title">{{ conv.conversation_title }}</h6>
                            <small class="text-muted">{{ conv.message_count }} messages</small>
                        </div>
                        <small class="text-muted">{{ conv.updated_at.strftime('%m/%d %H:%M') }}</small>
                    </div>
                    {% endfor %}

                    {% if not conversations %}
                    <div class="text-center text-muted p-3">
                        <i class="bi bi-chat-dots display-4 mb-2"></i>
                        <p class="mb-0">No chat history yet</p>
                        <small>Start a conversation to see it here</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-lg-9">
        <!-- Customer Support Navigation -->
        <div class="card">
            <!-- Support Navigation Tabs -->
            <ul class="nav nav-tabs nav-fill" id="supportTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                        <i class="bi bi-chat-heart-fill me-2"></i>
                        üí¨ Get Help Now
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                        <i class="bi bi-box-seam me-2"></i>
                        üì¶ Track My Orders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                        <i class="bi bi-person-gear me-2"></i>
                        üë§ My Account
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                        <i class="bi bi-telephone-fill me-2"></i>
                        üìû Contact Support
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="supportTabContent">

                <!-- Get Help Now Tab (Primary Chat Interface) -->
                <div class="tab-pane fade show active" id="chat" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-robot text-primary me-2"></i>
                                Chat with our AI Support Assistant
                            </h4>
                            <p class="text-muted mb-4">
                                Ask me anything about your orders, payments, delivery, account, or shopping on raqibtech.com!
                            </p>
                        </div>

                        <!-- Chat Messages Container -->
                        <div class="chat-messages" id="chatMessages">
                            <!-- Messages will be loaded dynamically -->
                            <div id="loadingIndicator" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading conversation...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading your conversation...</p>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div class="chat-input-container bg-light p-3 rounded">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput"
                                       placeholder="Ask me anything..."
                                       onkeypress="handleChatKeyPress(event)">
                                <button class="btn btn-primary" type="button" onclick="sendChatMessage()">
                                    <i class="bi bi-send-fill me-1"></i>Send
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-shield-check me-1"></i>Your conversations are secure and private
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Track My Orders Tab -->
                <div class="tab-pane fade" id="orders" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-box-seam text-primary me-2"></i>
                                Track Your Orders
                            </h4>
                            <p class="text-muted">
                                {% if session.get('user_authenticated') %}
                                    Your recent orders will appear here. You can also ask the AI assistant about specific orders.
                                {% else %}
                                    <a href="/login" class="text-decoration-none">Login</a> to see your order history, or ask the AI assistant for help.
                                {% endif %}
                            </p>
                        </div>

                        <!-- Order Tracking Form -->
                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Quick Order Lookup</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Order ID</label>
                                            <input type="text" class="form-control" id="orderIdInput"
                                                   placeholder="Enter your order ID (e.g., 12345)">
                                        </div>
                                        <button class="btn btn-primary w-100" onclick="trackOrderViaChat()">
                                            <i class="bi bi-search me-1"></i>Track My Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-info-circle text-info me-1"></i>
                                            Order Status Guide
                                        </h6>
                                        <ul class="list-unstyled small">
                                            <li class="mb-1">
                                                <span class="badge bg-warning me-2">Pending</span>
                                                Order received, being prepared
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-info me-2">Processing</span>
                                                Order being processed for delivery
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-success me-2">Delivered</span>
                                                Order delivered successfully
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-secondary me-2">Returned</span>
                                                Order was returned
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Account Tab -->
                <div class="tab-pane fade" id="account" role="tabpanel">
                    <div class="p-4">
                        <!-- raqibtech.com Branding Header -->
                        {% if session.get('user_authenticated') %}
                        <div class="mb-4 text-center">
                            <div class="raqibtech-branding">
                                <h2 class="brand-title mb-2">
                                    <span class="brand-logo">üöÄ</span>
                                    <span class="brand-text">raqibtech</span>
                                    <span class="brand-domain">.com</span>
                                </h2>
                                <p class="brand-subtitle">Your Trusted Nigerian E-commerce Partner</p>
                                <div class="brand-stats">
                                    <span class="badge bg-success me-2">üá≥üá¨ 36 States + FCT</span>
                                    <span class="badge bg-primary me-2">üì¶ 1M+ Deliveries</span>
                                    <span class="badge bg-warning">‚≠ê 4.8/5 Rating</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-person-gear text-warning me-2"></i>
                                My Account & Profile
                            </h4>
                            {% if session.get('user_authenticated') %}
                                <p class="text-muted">
                                    Welcome back! Manage your account information and explore personalized features.
                                </p>
                            {% else %}
                                <p class="text-muted">
                                    <a href="/login" class="text-decoration-none">Login</a> to access your account settings and order history.
                                </p>
                            {% endif %}
                        </div>

                        {% if session.get('user_authenticated') %}
                        <!-- Enhanced Quick Actions Dashboard for Logged-in Users -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="account-dashboard">
                                    <h5 class="mb-3">
                                        <i class="bi bi-speedometer2 text-primary me-2"></i>
                                        Personal Dashboard
                                    </h5>
                                    <div class="dashboard-actions">
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Show my recent orders')">
                                            <div class="action-icon">üì¶</div>
                                            <div class="action-text">
                                                <strong>Recent Orders</strong>
                                                <small>Track & manage</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('What are my account benefits?')">
                                            <div class="action-icon">‚≠ê</div>
                                            <div class="action-text">
                                                <strong>Account Benefits</strong>
                                                <small>Tier & rewards</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Recommend products for me')">
                                            <div class="action-icon">üõçÔ∏è</div>
                                            <div class="action-text">
                                                <strong>For You</strong>
                                                <small>Personalized picks</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Help with payments')">
                                            <div class="action-icon">üí≥</div>
                                            <div class="action-text">
                                                <strong>Payments</strong>
                                                <small>Methods & billing</small>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Account Actions -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Account Services</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="sendQuickMessage('Update my profile information')">
                                                <i class="bi bi-person-fill-gear me-2"></i>Update Profile Information
                                            </button>
                                            <button class="btn btn-outline-success" onclick="sendQuickMessage('Change my delivery address')">
                                                <i class="bi bi-geo-alt-fill me-2"></i>Update Delivery Address
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="sendQuickMessage('Check my account tier and benefits')">
                                                <i class="bi bi-star-fill me-2"></i>View Account Tier & Benefits
                                            </button>
                                            <button class="btn btn-outline-info" onclick="sendQuickMessage('Update my payment methods')">
                                                <i class="bi bi-credit-card-fill me-2"></i>Manage Payment Methods
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Benefits -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">Account Tiers & Benefits</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="tier-info">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-secondary">Bronze</span>
                                                <small>Standard benefits</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">Silver</span>
                                                <small>5% discount + priority support</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-warning">Gold</span>
                                                <small>10% discount + free delivery</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-info">Platinum</span>
                                                <small>15% discount + premium perks</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Support Tab -->
                <div class="tab-pane fade" id="contact" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-telephone-fill text-danger me-2"></i>
                                Contact raqibtech.com Support
                            </h4>
                            <p class="text-muted">
                                Multiple ways to reach our support team across Nigeria.
                            </p>
                        </div>

                        <div class="row">
                            <!-- Contact Methods -->
                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-telephone-fill text-success display-4 mb-3"></i>
                                        <h6>Phone Support</h6>
                                        <p class="text-muted small">Speak with our support team</p>
                                        <strong class="text-success">+234 (702) 5965-922 (72242)</strong>
                                        <p class="small mt-2">Daily 8AM - 8PM (WAT)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-envelope-fill text-primary display-4 mb-3"></i>
                                        <h6>Email Support</h6>
                                        <p class="text-muted small">Send us your questions</p>
                                        <strong class="text-primary">support@raqibtech.com</strong>
                                        <p class="small mt-2">Response within 24 hours</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-chat-heart-fill text-danger display-4 mb-3"></i>
                                        <h6>Live AI Chat</h6>
                                        <p class="text-muted small">Instant help available</p>
                                        <strong class="text-danger">Available 24/7</strong>
                                        <p class="small mt-2">
                                            <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('chat-tab').click()">
                                                Start Chat Now
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nigerian Coverage -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-geo-alt-fill me-2"></i>
                                            üá≥üá¨ Nationwide Coverage in Nigeria
                                        </h6>
                                        <p class="mb-0">
                                            We deliver to all 36 Nigerian states + FCT with dedicated support for your region.
                                            Payment options include Pay on Delivery, Bank Transfer, Card, and RaqibTechPay.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script>
window.currentConversationId = {% if current_conversation_id %}'{{ current_conversation_id }}'{% else %}null{% endif %};
window.userAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
</script>

<!-- Enhanced Customer Support JavaScript with Session Management -->
<script>
// Customer-focused support system with session and chat history
class CustomerSupportPortal {
    constructor() {
        console.log('üõçÔ∏è Initializing raqibtech.com Customer Support Portal with Session Management...');
        this.currentConversationId = window.currentConversationId;
        this.userAuthenticated = window.userAuthenticated;
        this.isTyping = false; // üîß FIX: Track typing state to prevent contamination
        this.activeMessageRequest = null; // üîß FIX: Track active requests
        this.conversationLocked = false; // üîß FIX: Prevent rapid conversation switching
        this.initializeCustomerFeatures();
        this.loadCurrentConversation();
    }

    initializeCustomerFeatures() {
        // Focus chat input when page loads
        setTimeout(() => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.focus();
            }
        }, 1000);
    }

    async loadCurrentConversation() {
        if (!this.currentConversationId) {
            this.displayWelcomeMessage();
            return;
        }

        // üîß FIX: Ensure we're loading the correct conversation
        console.log(`üîÑ Loading conversation: ${this.currentConversationId}`);

        try {
            const response = await fetch(`/api/conversations/${this.currentConversationId}/messages`);
            const data = await response.json();

            // üîß FIX: Verify we're still on the same conversation
            if (this.currentConversationId !== window.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed during loading, aborting');
                return;
            }

            if (data.success && data.messages.length > 0) {
                this.displayConversationHistory(data.messages);
            } else {
                this.showWelcomeMessage();
            }
        } catch (error) {
            console.error('Error loading conversation:', error);
            this.showWelcomeMessage();
        }
    }

    displayConversationHistory(messages) {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        // üîß FIX: Clear completely before loading new messages
        chatMessages.innerHTML = '';

        messages.forEach(message => {
            this.addMessageToChatDisplay(message.content, message.sender_type, false, message.metadata || {});
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
        console.log(`‚úÖ Loaded ${messages.length} messages for conversation ${this.currentConversationId}`);
    }

    showWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        const welcomeMessage = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeMessage;
    }

    createWelcomeMessage() {
        return `
            <div class="message ai welcome">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="welcome-content">
                            ${this.userAuthenticated ?
                                `<h6 class="mb-2">üëã Welcome back! üåü</h6>
                                <p class="mb-3">üéâ Great to see you again! I'm excited to help you with your orders and account today! üòä‚ú®</p>
                                <p class="mb-3">üíô As your personal support assistant, I can help with:</p>
                                <ul class="list-unstyled mb-3">
                                    <li class="mb-1">üîç <strong>Track your orders</strong> - Real-time delivery updates</li>
                                    <li class="mb-1">üí≥ <strong>Payment assistance</strong> - Billing and payment issues</li>
                                    <li class="mb-1">üöö <strong>Delivery management</strong> - Address changes and scheduling</li>
                                    <li class="mb-1">üë§ <strong>Account settings</strong> - Profile and preferences</li>
                                    <li class="mb-1">üõçÔ∏è <strong>Shopping help</strong> - Product recommendations</li>
                                    <li class="mb-1">üè™ <strong>Browse our amazing product catalog</strong> - Electronics, Fashion, Beauty, Computing, Automotive, Books</li>
                                </ul>
                                <div class="welcome-quick-start-actions">
                                    <p class="mb-2"><strong>‚ú® Quick Actions:</strong></p>
                                    <div class="welcome-quick-actions">
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Track my recent orders')">üì¶ My Orders</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Show my account summary')">üë§ Account Info</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Browse your product catalog')">üè™ Browse Catalog</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Show me electronics products')">üì± Electronics</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Check prices for popular products')">üí∞ Check Prices</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Contact customer support')">üìû Support</button>
                                    </div>
                                </div>
                                <p class="mt-3 mb-0">üí¨ <strong>Ask me anything!</strong> I'm here to help with your personal account and orders. üåüüíù</p>` :
                                `<h6 class="mb-2">üëã Welcome to raqibtech.com! üåü</h6>
                                <p class="mb-3">üòä I'm your AI customer support guide! I'm here to show you what our platform can do.</p>
                                <p class="mb-3">üîí <strong>For Guest Users:</strong> I can provide general information about our services, but for personalized support with your orders and account, you'll need to sign up or log in!</p>
                                <p class="mb-3">üåü <strong>What raqibtech.com offers:</strong></p>
                                <ul class="list-unstyled mb-3">
                                    <li class="mb-1">üõçÔ∏è <strong>E-commerce Platform</strong> - Shop from thousands of products</li>
                                    <li class="mb-1">üá≥üá¨ <strong>Nigeria-wide Delivery</strong> - We deliver to all 36 states + FCT</li>
                                    <li class="mb-1">üí≥ <strong>Flexible Payments</strong> - Pay on Delivery, Card, Bank Transfer</li>
                                    <li class="mb-1">üë§ <strong>Account Tiers</strong> - Bronze, Silver, Gold, Platinum with benefits</li>
                                    <li class="mb-1">üìû <strong>24/7 Support</strong> - AI and human support always available</li>
                                    <li class="mb-1">üè™ <strong>Amazing Product Catalog</strong> - Electronics, Fashion, Beauty, Computing, Automotive, Books</li>
                                </ul>
                                <p class="mb-3">üéØ <strong>Ready for personalized service?</strong> Sign up or log in to:</p>
                                <ul class="list-unstyled mb-2">
                                    <li class="mb-1">‚úÖ Track your specific orders in real-time</li>
                                    <li class="mb-1">‚úÖ Get personalized product recommendations</li>
                                    <li class="mb-1">‚úÖ Manage your account and payment methods</li>
                                    <li class="mb-1">‚úÖ Access order history and support tickets</li>
                                </ul>
                                <div class="welcome-quick-start-actions">
                                    <p class="mb-2"><strong>‚ú® Quick Actions:</strong></p>
                                    <div class="welcome-quick-actions">
                                        <a href="/login" class="welcome-quick-action-btn">üîê Login</a>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('How do I create an account?')">üìù Sign Up</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('What services do you offer?')">üí° Learn More</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Contact customer support')">üìû Contact Support</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Browse your product catalog')">üè™ Browse Catalog</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Show me electronics products')">üì± Electronics</button>
                                        <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Check prices for popular products')">üí∞ Check Prices</button>
                                    </div>
                                </div>
                                <p class="mt-3 mb-0">üí¨ <strong>Ask me anything!</strong> I can guide you about our services and help you get started! üåü</p>`
                            }
                        </div>
                    </div>
                    <div class="message-meta">
                        <span>${new Date().toLocaleTimeString()}</span>
                        <span class="response-time">${this.userAuthenticated ?
                            "Your personal support assistant - always here for you!" :
                            "Sign up for personalized support - it's free!"
                        }</span>
                    </div>
                </div>
            </div>
        `;
    }

    async sendCustomerMessage(message = null) {
        // üîß FIX: Prevent sending messages while typing or during conversation switch
        if (this.isTyping || this.conversationLocked) {
            console.warn('‚ö†Ô∏è Message blocked: System is busy');
            return;
        }

        const chatInput = document.getElementById('chatInput');
        if (!chatInput) return;

        const userMessage = message || chatInput.value.trim();
        if (!userMessage) return;

        // üîß FIX: Cancel any existing request before starting new one
        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
            this.removeTypingIndicator();
        }

        // Clear input
        if (!message) chatInput.value = '';

        // üîß FIX: Store the conversation ID when starting the request
        const requestConversationId = this.currentConversationId;

        // Add user message to chat
        this.addMessageToChatDisplay(userMessage, 'customer');

        // Show typing indicator
        this.isTyping = true;
        this.showTypingIndicator();

        try {
            // üîß FIX: Create AbortController for request tracking
            const controller = new AbortController();
            this.activeMessageRequest = controller;

            // Send to enhanced API
            const response = await fetch('/api/enhanced-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: userMessage
                }),
                signal: controller.signal
            });

            // üîß FIX: Verify we're still in the same conversation
            if (requestConversationId !== this.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed during request, ignoring response');
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // üîß FIX: Final check before processing response
            if (requestConversationId !== this.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed before response processing, ignoring');
                return;
            }

            this.isTyping = false;
            this.activeMessageRequest = null;
            this.removeTypingIndicator();

            if (data.success) {
                this.addCustomerResponseToChat(data);
                // Refresh conversation list
                this.refreshConversationList();
            } else {
                this.addMessageToChatDisplay(data.message || 'Sorry, I encountered an issue. Please try again.', 'ai', true);
            }

        } catch (error) {
            // üîß FIX: Only handle non-aborted errors
            if (error.name !== 'AbortError') {
                this.isTyping = false;
                this.activeMessageRequest = null;
                this.removeTypingIndicator();
                console.error('‚ùå Customer chat error:', error);

                // üîß FIX: Only show error if still in same conversation
                if (requestConversationId === this.currentConversationId) {
                    this.addMessageToChatDisplay('I apologize, but I\'m experiencing technical difficulties. Please try again or contact our phone support at +234 (702) 5965-922.', 'ai', true);
                }
            }
        }
    }

    addMessageToChatDisplay(message, sender, isError = false, metadata = {}) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender === 'customer' ? 'customer' : 'ai'}`;

        if (isError) {
            messageDiv.classList.add('error');
        }

        const timestamp = new Date().toLocaleTimeString();

        // Create avatar
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = sender === 'customer' ? 'U' : 'AI';

        // Create message content container
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        // Create message bubble
        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';
        messageBubble.innerHTML = message;

        // Create message meta (timestamp and response time for AI)
        const messageMeta = document.createElement('div');
        messageMeta.className = 'message-meta';

        if (sender === 'customer') {
            messageMeta.innerHTML = `<span>${timestamp}</span>`;
        } else {
            // For AI messages, include response time if available
            const responseTime = metadata.execution_time || '';
            messageMeta.innerHTML = `
                <span>${timestamp}</span>
                ${responseTime ? `<span class="response-time">‚ö° ${responseTime}</span>` : ''}
            `;
        }

        // Assemble message
        messageContent.appendChild(messageBubble);
        messageContent.appendChild(messageMeta);

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    addCustomerResponseToChat(data) {
        // Create main response message with response time
        this.addMessageToChatDisplay(data.response, 'ai', false, data);

        // üÜï Add smart quick actions after every AI response for ALL users
        this.addSmartQuickActions(data);
    }

    // üÜï Smart Quick Actions System - Fixed for ALL users
    addSmartQuickActions(data) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const quickActionDiv = document.createElement('div');
        quickActionDiv.className = 'smart-quick-actions-container';

        // Generate contextual quick actions based on query type and authentication
        const quickActions = this.generateSmartQuickActions(data);

        quickActionDiv.innerHTML = `
            <div class="smart-quick-actions">
                <div class="quick-actions-header">
                    <span>üí° Quick Actions</span>
                </div>
                <div class="quick-actions-buttons">
                    ${quickActions.map(action => `
                        <button class="smart-quick-action-btn" onclick="${action.onclick}">
                            ${action.icon} ${action.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;

        chatMessages.appendChild(quickActionDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    generateSmartQuickActions(data) {
        const actions = [];
        const queryType = data.query_type || 'general';

        if (this.userAuthenticated) {
            // Authenticated user actions
            switch (queryType) {
                case 'order_analytics':
                    actions.push(
                        { icon: 'üì¶', text: 'Track Another Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: 'üìã', text: 'View Order History', onclick: `customerPortal.sendCustomerMessage('Show my order history')` },
                        { icon: 'üöö', text: 'Update Delivery Address', onclick: `customerPortal.sendCustomerMessage('Update my delivery address')` },
                        { icon: 'üí≥', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` }
                    );
                    break;
                case 'customer_analysis':
                    actions.push(
                        { icon: 'üë§', text: 'Update Profile', onclick: `customerPortal.sendCustomerMessage('Update my profile')` },
                        { icon: 'üîí', text: 'Account Security', onclick: `customerPortal.sendCustomerMessage('Account security settings')` },
                        { icon: '‚≠ê', text: 'Upgrade Account', onclick: `customerPortal.sendCustomerMessage('How to upgrade my account tier')` },
                        { icon: 'üíº', text: 'Account Benefits', onclick: `customerPortal.sendCustomerMessage('What are my account benefits')` }
                    );
                    break;
                case 'product_performance':
                    actions.push(
                        { icon: 'üè™', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: 'üì±', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: 'üëó', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: 'üíÑ', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` }
                    );
                    break;
                case 'revenue_insights':
                    actions.push(
                        { icon: 'üí≥', text: 'Payment Methods', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept')` },
                        { icon: 'üîÑ', text: 'Refund Request', onclick: `customerPortal.sendCustomerMessage('How to request a refund')` },
                        { icon: 'üìä', text: 'Spending History', onclick: `customerPortal.sendCustomerMessage('Show my spending history')` },
                        { icon: 'üí∞', text: 'Payment Issues', onclick: `customerPortal.sendCustomerMessage('Help with payment issues')` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: 'üõçÔ∏è', text: 'Browse Products', onclick: `customerPortal.sendCustomerMessage('What products do you recommend')` },
                        { icon: 'üì¶', text: 'Track Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: 'üí≥', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` },
                        { icon: 'üìû', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('Contact customer support')` }
                    );
            }
        } else {
            // Guest user actions - encourage engagement and signup
            switch (queryType) {
                case 'product_performance':
                    actions.push(
                        { icon: 'üè™', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: 'üì±', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: 'üëó', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: 'üíÑ', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` },
                        { icon: 'üîê', text: 'Login for Personal Shop', onclick: `window.location.href='/login'` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: 'üîê', text: 'Login', onclick: `window.location.href='/login'` },
                        { icon: 'üìù', text: 'Create Account', onclick: `customerPortal.sendCustomerMessage('How do I create an account?')` },
                        { icon: 'üõçÔ∏è', text: 'Explore Products', onclick: `customerPortal.sendCustomerMessage('What products do you offer?')` },
                        { icon: 'üìç', text: 'Delivery Areas', onclick: `customerPortal.sendCustomerMessage('What areas do you deliver to?')` },
                        { icon: 'üí≥', text: 'Payment Options', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept?')` },
                        { icon: 'üìû', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('How to contact customer support')` }
                    );
            }
        }

        return actions;
    }

    showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        // üîß FIX: Remove any existing typing indicator first
        this.removeTypingIndicator();

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-avatar">AI</div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span style="color: #6c757d; font-size: 14px;">raqibtech.com Assistant is typing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        `;

        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    async refreshConversationList() {
        try {
            const response = await fetch('/api/conversations');
            const data = await response.json();

            if (data.success) {
                this.updateConversationList(data.conversations);
            }
        } catch (error) {
            console.error('Error refreshing conversation list:', error);
        }
    }

    async loadConversationMessages(conversationId) {
        try {
            // üîß FIX: Clear state before loading
            this.isTyping = false;
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.removeTypingIndicator();

            const response = await fetch(`/api/conversations/${conversationId}/messages`);
            const data = await response.json();

            // üîß FIX: Verify conversation hasn't changed
            if (conversationId !== this.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed during message loading');
                return;
            }

            if (data.success && data.messages) {
                // Clear current chat completely
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                }

                // Load all messages in chronological order
                data.messages.forEach(msg => {
                    const senderType = msg.sender_type === 'user' ? 'customer' : 'ai';
                    const metadata = msg.metadata || {};
                    this.addMessageToChatDisplay(msg.content, senderType, false, metadata);
                });

                console.log(`‚úÖ Loaded ${data.messages.length} messages for conversation ${conversationId}`);
            }
        } catch (error) {
            console.error('‚ùå Error loading conversation messages:', error);
        }
    }

    updateConversationList(conversations) {
        const listContainer = document.getElementById('chatHistoryList');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (conversations.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center text-muted p-3">
                    <i class="bi bi-chat-dots display-4 mb-2"></i>
                    <p class="mb-0">No chat history yet</p>
                    <small>Start a conversation to see it here</small>
                </div>
            `;
            return;
        }

        conversations.forEach(conv => {
            const convElement = document.createElement('div');
            convElement.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-start conversation-item';
            convElement.setAttribute('data-conversation-id', conv.conversation_id);

            // üÜï ADD: Delete button functionality
            convElement.innerHTML = `
                <div class="conversation-info" onclick="customerPortal.switchToConversation('${conv.conversation_id}')" style="flex: 1; cursor: pointer;">
                    <h6 class="mb-1 conversation-title">${conv.title}</h6>
                    <small class="text-muted">${conv.message_count} messages</small>
                </div>
                <div class="conversation-actions" style="display: flex; align-items: center; gap: 8px;">
                    <small class="text-muted">${new Date(conv.updated_at).toLocaleDateString()}</small>
                    <button class="btn btn-sm btn-outline-danger" onclick="customerPortal.deleteConversation('${conv.conversation_id}', event)"
                            title="Delete conversation" style="padding: 2px 6px; font-size: 10px;">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;

            listContainer.appendChild(convElement);
        });
    }

    // üÜï ADD: Delete conversation functionality
    async deleteConversation(conversationId, event) {
        event.stopPropagation(); // Prevent conversation switching

        if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/conversations/${conversationId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                console.log(`‚úÖ Deleted conversation ${conversationId}`);

                // If we deleted the current conversation, create a new one or show welcome
                if (conversationId === this.currentConversationId) {
                    this.currentConversationId = null;
                    window.currentConversationId = null;
                    this.displayWelcomeMessage();
                }

                // Refresh conversation list
                this.refreshConversationList();
            } else {
                alert('Failed to delete conversation. Please try again.');
            }
        } catch (error) {
            console.error('‚ùå Error deleting conversation:', error);
            alert('Error deleting conversation. Please try again.');
        }
    }

    async switchToConversation(conversationId) {
        // üîß FIX: Prevent rapid switching and contamination
        if (this.conversationLocked || conversationId === this.currentConversationId) {
            return;
        }

        this.conversationLocked = true;

        try {
            // üîß FIX: Cancel any active requests
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.isTyping = false;
            this.removeTypingIndicator();

            console.log(`üîÑ Switching from conversation ${this.currentConversationId} to ${conversationId}`);

            // Update current conversation ID immediately
            this.currentConversationId = conversationId;
            window.currentConversationId = conversationId;

            // Switch conversation on server
            const response = await fetch(`/api/conversations/${conversationId}/switch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                // Load conversation messages
                await this.loadConversationMessages(conversationId);

                // Update active conversation highlighting
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }

                console.log(`‚úÖ Successfully switched to conversation ${conversationId}`);
            }
        } catch (error) {
            console.error('‚ùå Error switching conversation:', error);
        } finally {
            // üîß FIX: Always unlock conversation switching
            setTimeout(() => {
                this.conversationLocked = false;
            }, 500);
        }
    }

    displayWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        // üîß FIX: Clear any pending states
        this.isTyping = false;
        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
        }
        this.removeTypingIndicator();

        // Clear any existing messages
        chatMessages.innerHTML = '';

        const welcomeHtml = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeHtml;
        chatMessages.scrollTop = chatMessages.scrollHeight;

        console.log('‚úÖ Welcome message displayed');
    }
}

// Global functions for compatibility
function sendChatMessage() {
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage();
    }
}

function sendQuickMessage(message) {
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage(message);
    }
}

function trackOrderViaChat() {
    const orderIdInput = document.getElementById('orderIdInput');
    const orderId = orderIdInput?.value.trim();

    if (orderId) {
        sendQuickMessage(`Track my order ${orderId}`);
        // Switch to chat tab
        document.getElementById('chat-tab').click();
    } else {
        sendQuickMessage('Help me track my order');
        document.getElementById('chat-tab').click();
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

async function createNewChat() {
    try {
        const response = await fetch('/api/conversations/new', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            // üîß FIX: Use the new conversation switching instead of page reload
            if (window.customerPortal) {
                await window.customerPortal.switchToConversation(data.conversation_id);
                await window.customerPortal.refreshConversationList();
            }
        }
    } catch (error) {
        console.error('Error creating new chat:', error);
    }
}

async function switchToConversation(conversationId) {
    // üîß FIX: Use the portal's switchToConversation method
    if (window.customerPortal) {
        await window.customerPortal.switchToConversation(conversationId);
    }
}

// Initialize customer portal when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing raqibtech.com Customer Support Portal with Session Management');
    window.customerPortal = new CustomerSupportPortal();

    // üîß NEW: Load current conversation if user is authenticated
    const isAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
    const currentConversationId = '{{ current_conversation_id if current_conversation_id else '' }}';

    if (isAuthenticated && currentConversationId) {
        // Load the current conversation messages
        window.customerPortal.loadConversationMessages(currentConversationId).then(() => {
            // Mark as active in conversation list
            const activeItem = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            console.log(`‚úÖ Loaded current conversation: ${currentConversationId}`);
        }).catch(error => {
            console.error('‚ùå Error loading current conversation:', error);
        });
    } else if (!isAuthenticated) {
        // For guest users, show welcome message
        window.customerPortal.displayWelcomeMessage();
    }

    console.log('‚úÖ Customer support portal ready!');
});
</script>
{% endblock %}
