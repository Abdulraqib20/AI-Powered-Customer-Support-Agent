{% extends "base.html" %}

{% block title %}Dashboard - Nigerian Customer Support Agent{% endblock %}

{% block content %}
<!-- Quick Stats Overview -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="stats-number">{{ stats.total_customers or 0 }}</div>
            <div class="stats-label">
                <i class="bi bi-people-fill me-1"></i>Total Customers
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stats-card bg-success">
            <div class="stats-number">{{ stats.total_orders or 0 }}</div>
            <div class="stats-label">
                <i class="bi bi-cart-fill me-1"></i>Total Orders
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stats-card bg-warning">
            <div class="stats-number">{{ stats.usage_stats.groq_api.requests_today or 0 }}</div>
            <div class="stats-label">
                <i class="bi bi-cpu-fill me-1"></i>AI Requests Today
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stats-card bg-info">
            <div class="stats-number">99.9%</div>
            <div class="stats-label">
                <i class="bi bi-check-circle-fill me-1"></i>System Uptime
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Tabs -->
<div class="row">
    <div class="col-12">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="support-tab" data-bs-toggle="tab" data-bs-target="#support" type="button" role="tab">
                    <i class="bi bi-chat-dots-fill me-2"></i>üá≥üá¨ AI Customer Support
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab">
                    <i class="bi bi-people-fill me-2"></i>Customer Profiles
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage" type="button" role="tab">
                    <i class="bi bi-graph-up me-2"></i>Usage Analytics
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                    <i class="bi bi-bar-chart-fill me-2"></i>Support Dashboard
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="dashboardTabContent">

            <!-- Unified Support Tab -->
            <div class="tab-pane fade show active" id="support" role="tabpanel">
                <h4 class="mb-4">
                    <i class="bi bi-chat-dots-fill text-primary me-2"></i>
                    üá≥üá¨ AI-Powered Nigerian E-commerce Customer Support Agent
                </h4>

                <div class="row">
                    <!-- Chat Interface -->
                    <div class="col-lg-8">
                        <div class="chat-container">
                            <div class="chat-messages" id="chatMessages">
                                <div class="message ai">
                                    <strong>ü§ñ Nigerian E-commerce AI Support Agent</strong><br>
                                    Sannu! Welcome to your AI-powered customer support assistant for Nigerian e-commerce.
                                    I can help you with customer queries, order tracking, payment issues, analytics, and database insights.
                                    Ask me anything about your business data!
                                    <div class="quick-actions">
                                        <button class="quick-action-btn" onclick="sendQuickMessage('Show customers from Lagos state')">
                                            Lagos Customers
                                        </button>
                                        <button class="quick-action-btn" onclick="sendQuickMessage('Show orders with status Pending')">
                                            Pending Orders
                                        </button>
                                        <button class="quick-action-btn" onclick="sendQuickMessage('What is our total revenue this month?')">
                                            Revenue Analytics
                                        </button>
                                        <button class="quick-action-btn" onclick="sendQuickMessage('Which Nigerian state has the most customers?')">
                                            Geographic Analysis
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input-area p-3 border-top">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="chatInput"
                                           placeholder="Ask me anything... (e.g., 'Show customers from Rivers state with Card payments')"
                                           onkeypress="handleChatKeyPress(event)">
                                    <button class="btn btn-primary" type="button" onclick="sendChatMessage()">
                                        <i class="bi bi-send-fill"></i>
                                    </button>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="showSqlQueries" checked>
                                    <label class="form-check-label" for="showSqlQueries">
                                        <small class="text-muted">
                                            <i class="bi bi-database me-1"></i>Show SQL queries for validation
                                        </small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Right Panel -->
                    <div class="col-lg-4">
                        <!-- Quick Query Categories -->
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-gradient-primary text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-lightning-fill me-1"></i>
                                    Query Categories
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm query-category" data-category="customer_analysis">
                                        <i class="bi bi-people me-1"></i> Customer Analytics
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm query-category" data-category="order_analytics">
                                        <i class="bi bi-cart me-1"></i> Order Analysis
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm query-category" data-category="revenue_insights">
                                        <i class="bi bi-currency-dollar me-1"></i> Revenue Insights
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm query-category" data-category="geographic_analysis">
                                        <i class="bi bi-geo-alt me-1"></i> Geographic Analysis
                                    </button>
                                </div>

                                <!-- Query Suggestions -->
                                <div id="querySuggestions" class="mt-3" style="display: none;">
                                    <small class="text-muted"><strong>Suggested queries:</strong></small>
                                    <div id="suggestionsContainer" class="mt-1"></div>
                                </div>
                            </div>
                        </div>

                        <!-- System Status & Chat History -->
                        <div class="card border-info">
                            <div class="card-header bg-gradient-info text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    System Status & History
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- System Status -->
                                <div class="mb-3">
                                    <small class="text-muted"><strong>System Status:</strong></small>
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small>AI Services</small>
                                        <span class="badge bg-success">Online</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small>Database</small>
                                        <span class="badge bg-success">Connected</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small>Enhanced Pipeline</small>
                                        <span class="badge bg-success">Active</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small>Memory Store</small>
                                        <span class="badge bg-success">Available</span>
                                    </div>
                                </div>

                                <!-- Recent Queries -->
                                <div id="conversationHistory" style="max-height: 200px; overflow-y: auto;">
                                    <small class="text-muted"><strong>Recent Queries:</strong></small>
                                    <div class="text-center text-muted mt-2">
                                        <i class="bi bi-chat-text fa-2x mb-2"></i>
                                        <p>No queries yet.<br>Start asking questions!</p>
                                    </div>
                                </div>
                                <div class="mt-2 d-grid gap-1">
                                    <button class="btn btn-sm btn-outline-info" id="loadHistoryBtn">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Profiles Tab -->
            <div class="tab-pane fade" id="customers" role="tabpanel">
                <h4 class="mb-4">
                    <i class="bi bi-people-fill text-primary me-2"></i>
                    Customer Management
                </h4>

                <!-- Search and Filters -->
                <div class="row mb-4">
                    <div class="col-lg-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="customerSearch"
                                   placeholder="Search customers...">
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <select class="form-select" id="stateFilter">
                            <option value="all">All States</option>
                            {% for state in states %}
                            <option value="{{ state }}">{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3">
                        <select class="form-select" id="tierFilter">
                            <option value="all">All Tiers</option>
                            {% for tier in account_tiers %}
                            <option value="{{ tier }}">{{ tier }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <button class="btn btn-primary w-100" onclick="loadCustomers()">
                            <i class="bi bi-funnel-fill me-1"></i>Filter
                        </button>
                    </div>
                </div>

                <!-- Customers Table -->
                <div class="loading" id="customersLoading">
                    <div class="spinner-border" role="status"></div>
                    <div class="mt-2">Loading customers...</div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>State</th>
                                <th>LGA</th>
                                <th>Account Tier</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Customers will be loaded here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Usage Analytics Tab -->
            <div class="tab-pane fade" id="usage" role="tabpanel">
                <h4 class="mb-4">
                    <i class="bi bi-graph-up text-primary me-2"></i>
                    API Usage & Performance Analytics
                </h4>

                <div class="row">
                    <!-- API Usage Charts -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Groq API Usage (Today)</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="groqUsageChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Response Time Analytics</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="responseTimeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <!-- Usage Statistics -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-speedometer2 me-1"></i>
                                    Real-time Usage Metrics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center border-end">
                                            <h5 class="text-primary mb-1" id="requestsToday">0</h5>
                                            <small class="text-muted">Requests Today</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center border-end">
                                            <h5 class="text-success mb-1" id="tokensToday">0</h5>
                                            <small class="text-muted">Tokens Used</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center border-end">
                                            <h5 class="text-warning mb-1" id="averageResponse">0ms</h5>
                                            <small class="text-muted">Avg Response</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h5 class="text-info mb-1" id="cacheHitRate">0%</h5>
                                            <small class="text-muted">Cache Hit Rate</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quota Information -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-gauge me-1"></i>
                                    API Quotas
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <small>Groq Requests/Min</small>
                                        <small><span id="groqRpm">0</span>/30</small>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" id="groqRpmProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <small>Groq Tokens/Min</small>
                                        <small><span id="groqTpm">0</span>/100K</small>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" id="groqTpmProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="alert alert-info py-2">
                                    <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                        Quotas reset every minute
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Dashboard Tab -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <h4 class="mb-4">
                    <i class="bi bi-bar-chart-fill text-primary me-2"></i>
                    Business Intelligence Dashboard
                </h4>

                <div class="row">
                    <!-- Customer Distribution Chart -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-geo-alt-fill text-success me-1"></i>
                                    Customer Distribution by State
                                </h6>
                            </div>
                            <div class="card-body">
                                <canvas id="customerDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue by State Chart -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-currency-exchange text-warning me-1"></i>
                                    Revenue by State (‚Ç¶)
                                </h6>
                            </div>
                            <div class="card-body">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <!-- Order Status Distribution -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Order Status Distribution</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="orderStatusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Payment Methods</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="paymentMethodsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-trophy-fill text-warning me-1"></i>
                                    Key Performance Indicators
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Revenue</span>
                                        <strong class="text-success" id="totalRevenue">‚Ç¶0</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Avg Order Value</span>
                                        <strong class="text-primary" id="avgOrderValue">‚Ç¶0</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Top State</span>
                                        <strong class="text-info" id="topState">Lagos</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Delivery Success</span>
                                        <strong class="text-success" id="deliverySuccess">95%</strong>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Customer Satisfaction</span>
                                        <strong class="text-warning" id="customerSat">4.8/5</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript for Integrated Customer Support Agent -->
<script>
// Integrated Nigerian E-commerce Customer Support Agent
class IntegratedCustomerSupportAgent {
    constructor() {
        console.log('üá≥üá¨ Initializing Integrated Nigerian E-commerce Customer Support Agent...');
        this.initializeEventListeners();
        this.loadQuerySuggestions();
        this.loadConversationHistory();
    }

    initializeEventListeners() {
        // Query category buttons
        document.querySelectorAll('.query-category').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.showSuggestions(e.target.dataset.category);
            });
        });

        // History management
        const loadHistoryBtn = document.getElementById('loadHistoryBtn');
        if (loadHistoryBtn) {
            loadHistoryBtn.addEventListener('click', () => {
                this.loadConversationHistory();
            });
        }
    }

    async sendChatMessage(message = null) {
        const chatInput = document.getElementById('chatInput');
        if (!chatInput) return;

        const userMessage = message || chatInput.value.trim();
        if (!userMessage) return;

        // Clear input
        if (!message) chatInput.value = '';

        // Add user message to chat
        this.addMessageToChat(userMessage, 'user');

        // Show typing indicator
        this.showTypingIndicator();

        try {
            // Send to enhanced API
            const response = await fetch('/api/enhanced-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: userMessage,
                    include_sql: true
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            this.removeTypingIndicator();

            if (data.success) {
                this.addEnhancedResponseToChat(data);
                // Refresh conversation history
                setTimeout(() => {
                    this.loadConversationHistory();
                }, 1000);
            } else {
                this.addMessageToChat(data.message || 'Query failed', 'ai', true);
            }

        } catch (error) {
            this.removeTypingIndicator();
            console.error('‚ùå Chat error:', error);
            this.addMessageToChat('I apologize, but I encountered a technical issue. Please try again.', 'ai', true);
        }
    }

    addMessageToChat(message, sender, isError = false) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;

        if (isError) {
            messageDiv.classList.add('error');
        }

        const timestamp = new Date().toLocaleTimeString();
        const senderName = sender === 'user' ? 'You' : 'ü§ñ AI Support Agent';

        messageDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <strong>${senderName}</strong>
                <small class="text-muted">${timestamp}</small>
            </div>
            <div class="mt-1">${message}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    addEnhancedResponseToChat(data) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai enhanced';

        const timestamp = new Date().toLocaleTimeString();
        const showSql = document.getElementById('showSqlQueries')?.checked || false;

        // Create message content
        let messageContent = `
            <div class="d-flex justify-content-between align-items-center">
                <strong>ü§ñ Nigerian E-commerce AI Agent</strong>
                <div>
                    <span class="badge bg-info me-1">${data.query_type || 'Analysis'}</span>
                    <small class="text-muted">${timestamp}</small>
                </div>
            </div>
            <div class="mt-2">${data.response}</div>
        `;

        // Add execution metrics
        if (data.results_count !== undefined || data.execution_time) {
            messageContent += `
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Found ${data.results_count || 0} records ‚Ä¢ Processed in ${data.execution_time || 'N/A'}
                    </small>
                </div>
            `;
        }

        // Add SQL query section if enabled
        if (showSql && data.sql_query) {
            messageContent += `
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-secondary" type="button"
                            data-bs-toggle="collapse" data-bs-target="#sqlQuery_${Date.now()}"
                            aria-expanded="false">
                        <i class="bi bi-database me-1"></i>View SQL Query
                    </button>
                    <div class="collapse mt-2" id="sqlQuery_${Date.now()}">
                        <div class="card bg-dark text-light">
                            <div class="card-header d-flex justify-content-between">
                                <small>Generated SQL Query</small>
                                <button class="btn btn-sm btn-outline-light" onclick="copyToClipboard('${data.sql_query.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <pre class="mb-0"><code>${this.formatSqlQuery(data.sql_query)}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add quick actions if available
        if (data.query_type) {
            const quickActions = this.getQuickActionsForQueryType(data.query_type);
            if (quickActions.length > 0) {
                messageContent += `
                    <div class="mt-2">
                        <small class="text-muted d-block mb-1">Quick follow-up actions:</small>
                        <div class="quick-actions">
                            ${quickActions.map(action =>
                                `<button class="quick-action-btn" onclick="sendQuickMessage('${action}')">${action}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        }

        messageDiv.innerHTML = messageContent;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    formatSqlQuery(sql) {
        // Basic SQL formatting for better readability
        return sql
            .replace(/SELECT/gi, '\nSELECT')
            .replace(/FROM/gi, '\nFROM')
            .replace(/WHERE/gi, '\nWHERE')
            .replace(/GROUP BY/gi, '\nGROUP BY')
            .replace(/ORDER BY/gi, '\nORDER BY')
            .replace(/LIMIT/gi, '\nLIMIT')
            .trim();
    }

    getQuickActionsForQueryType(queryType) {
        const actions = {
            'customer_analysis': [
                'Show customer distribution by account tier',
                'Find customers from other states'
            ],
            'order_analytics': [
                'Show order trends this month',
                'Check payment method distribution'
            ],
            'revenue_insights': [
                'Compare revenue by states',
                'Show monthly revenue trends'
            ],
            'geographic_analysis': [
                'Show top performing regions',
                'Compare Northern vs Southern Nigeria'
            ]
        };

        return actions[queryType] || [];
    }

    showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <strong>ü§ñ AI Support Agent</strong><br>
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        `;

        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    async showSuggestions(category) {
        try {
            const response = await fetch(`/api/query-suggestions?category=${category}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                const container = document.getElementById('suggestionsContainer');
                if (container) {
                    container.innerHTML = '';

                    data.suggestions.forEach(suggestion => {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-outline-secondary me-1 mb-1';
                        btn.textContent = suggestion;
                        btn.onclick = () => {
                            this.sendChatMessage(suggestion);
                            this.hideSuggestions();
                        };
                        container.appendChild(btn);
                    });

                    const suggestionsEl = document.getElementById('querySuggestions');
                    if (suggestionsEl) {
                        suggestionsEl.style.display = 'block';
                    }
                }
            }
        } catch (error) {
            console.error('‚ùå Suggestions error:', error);
        }
    }

    hideSuggestions() {
        const suggestionsEl = document.getElementById('querySuggestions');
        if (suggestionsEl) {
            suggestionsEl.style.display = 'none';
        }
    }

    async loadConversationHistory() {
        try {
            const response = await fetch('/api/conversation-history?limit=5');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.history.length > 0) {
                this.displayConversationHistory(data.history);
            } else {
                this.displayEmptyHistory();
            }
        } catch (error) {
            console.error('‚ùå History loading error:', error);
            this.displayEmptyHistory();
        }
    }

    displayConversationHistory(history) {
        const container = document.getElementById('conversationHistory');
        if (!container) return;

        container.innerHTML = '<small class="text-muted"><strong>Recent Queries:</strong></small>';

        history.forEach((entry) => {
            const historyItem = document.createElement('div');
            historyItem.className = 'border-bottom pb-1 mb-1';

            const timestamp = new Date(entry.timestamp).toLocaleTimeString();

            historyItem.innerHTML = `
                <div class="d-flex justify-content-between">
                    <small class="text-primary">${entry.query_type || 'Query'}</small>
                    <small class="text-muted">${timestamp}</small>
                </div>
                <div class="small">${entry.user_query.substring(0, 50)}...</div>
                <button class="btn btn-xs btn-outline-primary mt-1" onclick="supportAgent.sendChatMessage('${entry.user_query.replace(/'/g, "\\'")}')">
                    <i class="bi bi-arrow-clockwise me-1"></i>Replay
                </button>
            `;

            container.appendChild(historyItem);
        });
    }

    displayEmptyHistory() {
        const container = document.getElementById('conversationHistory');
        if (container) {
            container.innerHTML = `
                <small class="text-muted"><strong>Recent Queries:</strong></small>
                <div class="text-center text-muted mt-2">
                    <i class="bi bi-chat-text fa-2x mb-2"></i>
                    <p>No queries yet.<br>Start asking questions!</p>
                </div>
            `;
        }
    }

    copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Show temporary success message
            const toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; opacity: 0.9;';
            toast.innerHTML = '<i class="bi bi-check-circle me-1"></i>SQL query copied to clipboard!';
            document.body.appendChild(toast);

            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            alert('Failed to copy to clipboard. Please copy manually.');
        });
    }

    loadQuerySuggestions() {
        console.log('‚úÖ Integrated Nigerian E-commerce Customer Support Agent initialized');
    }
}

// Global functions for compatibility
function sendChatMessage() {
    console.log('üì§ sendChatMessage called');
    if (window.supportAgent) {
        window.supportAgent.sendChatMessage();
    } else {
        console.error('‚ùå supportAgent not initialized yet');
        // Try to initialize if not ready
        if (typeof IntegratedCustomerSupportAgent !== 'undefined') {
            window.supportAgent = new IntegratedCustomerSupportAgent();
            window.supportAgent.sendChatMessage();
        }
    }
}

function sendQuickMessage(message) {
    console.log('üöÄ sendQuickMessage called with:', message);

    // Add visual feedback - find and highlight the clicked button
    const buttons = document.querySelectorAll('.quick-action-btn');
    buttons.forEach(btn => {
        if (btn.onclick?.toString().includes(message)) {
            btn.style.transform = 'scale(0.95)';
            btn.style.opacity = '0.7';
            btn.style.backgroundColor = '#007bff';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.style.transform = '';
                btn.style.opacity = '';
                btn.style.backgroundColor = '';
                btn.style.color = '';
            }, 300);
        }
    });

    if (window.supportAgent) {
        window.supportAgent.sendChatMessage(message);
    } else {
        console.error('‚ùå supportAgent not initialized for quick message');

        // Show user-friendly message
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            messageDiv.innerHTML = `
                <strong>ü§ñ AI Support Agent</strong><br>
                <div class="mt-1">I'm still initializing... Please wait a moment and try again, or type your message in the input box below.</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Try to initialize if not ready
        if (typeof IntegratedCustomerSupportAgent !== 'undefined') {
            console.log('üîÑ Initializing supportAgent...');
            window.supportAgent = new IntegratedCustomerSupportAgent();
            // Wait a moment then send the message
            setTimeout(() => {
                if (window.supportAgent) {
                    window.supportAgent.sendChatMessage(message);
                }
            }, 100);
        } else {
            console.error('‚ùå IntegratedCustomerSupportAgent class not available');
        }
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; opacity: 0.9;';
        toast.innerHTML = '<i class="bi bi-check-circle me-1"></i>SQL query copied to clipboard!';
        document.body.appendChild(toast);

        setTimeout(() => {
            document.body.removeChild(toast);
        }, 3000);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy to clipboard. Please copy manually.');
    });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM Content Loaded - Initializing Customer Support Agent');

    // Function to initialize the support agent
    function initializeSupportAgent() {
        try {
            if (typeof IntegratedCustomerSupportAgent !== 'undefined') {
                window.supportAgent = new IntegratedCustomerSupportAgent();
                console.log('‚úÖ Integrated customer support system initialized successfully');
                return true;
            } else {
                console.warn('‚ö†Ô∏è IntegratedCustomerSupportAgent class not yet available');
                return false;
            }
        } catch (error) {
            console.error('‚ùå Error initializing support system:', error);
            return false;
        }
    }

    // Try immediate initialization
    if (!initializeSupportAgent()) {
        // If failed, try again after a short delay
        setTimeout(() => {
            if (!initializeSupportAgent()) {
                // If still failed, try one more time with longer delay
                setTimeout(() => {
                    initializeSupportAgent();
                }, 1000);
            }
        }, 500);
    }

    // Also try when the page is fully loaded
    window.addEventListener('load', function() {
        if (!window.supportAgent) {
            console.log('üîÑ Page fully loaded, trying to initialize support agent again...');
            initializeSupportAgent();
        }
    });
});

// Enhanced CSS Styles for the integrated interface
const enhancedStyles = `
<style>
/* Chat Messages Styling */
.chat-container {
    background: #f8f9fa;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.chat-messages {
    max-height: 500px;
    overflow-y: auto;
    padding: 20px;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
}

.message {
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.message.user {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    margin-left: 50px;
    border-bottom-right-radius: 4px;
}

.message.ai {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
    margin-right: 50px;
    border-bottom-left-radius: 4px;
}

.message.enhanced {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    margin-right: 30px;
    border-left: 5px solid #ffc107;
    box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
}

.message.error {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-left: 5px solid #ffc107;
}

.message.typing {
    background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    color: white;
    margin-right: 50px;
}

/* SQL Query Card Styling */
.card.bg-dark {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
    border: 2px solid #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

.card.bg-dark .card-header {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important;
    color: white !important;
    border-bottom: 1px solid #5dade2;
}

.card.bg-dark .card-body {
    background: #2c3e50 !important;
}

.card.bg-dark pre {
    background: #1a252f !important;
    color: #00ff88 !important;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #3498db;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
    overflow-x: auto;
}

.card.bg-dark code {
    color: #00ff88 !important;
    text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
}

/* Button Styling */
.btn-outline-light {
    border-color: #ffc107 !important;
    color: #ffc107 !important;
}

.btn-outline-light:hover {
    background-color: #ffc107 !important;
    color: #000 !important;
}

/* Badge Styling */
.badge.bg-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    color: white !important;
    border: 1px solid rgba(255,255,255,0.3);
}

/* Typing Animation */
.typing-dots {
    display: inline-flex;
    gap: 5px;
    align-items: center;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #ffc107;
    animation: typing 1.4s infinite ease-in-out both;
    box-shadow: 0 0 5px rgba(255, 193, 7, 0.5);
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1.2);
        opacity: 1;
    }
}

/* Quick Actions Styling */
.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
}

.quick-action-btn {
    padding: 6px 12px;
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
    border: 2px solid #2196f3;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #1976d2;
    box-shadow: 0 2px 5px rgba(33, 150, 243, 0.2);
}

.quick-action-btn:hover {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
}

/* Query Category Buttons */
.query-category {
    transition: all 0.3s ease;
    border-width: 2px;
    font-weight: 500;
}

.query-category:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.15);
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-color: #007bff;
}

.btn-outline-success:hover {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    border-color: #28a745;
}

.btn-outline-warning:hover {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    border-color: #ffc107;
    color: #000;
}

.btn-outline-info:hover {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    border-color: #17a2b8;
}

/* Card Styling */
.card.border-primary {
    border-color: #007bff !important;
    border-width: 2px;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.card.border-info {
    border-color: #17a2b8 !important;
    border-width: 2px;
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.15);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #6610f2 100%) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%) !important;
}

/* Input Styling */
.chat-input-area {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-top: 2px solid #dee2e6;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.25);
}

/* System Status Badges */
.badge.bg-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
    color: white !important;
    box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3);
}

/* Conversation History */
.border-bottom {
    border-bottom: 2px solid #e9ecef !important;
    margin-bottom: 8px !important;
    padding-bottom: 8px !important;
}

.text-primary {
    color: #007bff !important;
    font-weight: 600;
}

/* Button Extra Small */
.btn-xs {
    padding: 0.2rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 15px;
    font-weight: 500;
}

/* Scrollbar Styling */
.chat-messages::-webkit-scrollbar,
#conversationHistory::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track,
#conversationHistory::-webkit-scrollbar-track {
    background: linear-gradient(135deg, #f1f1f1 0%, #e9ecef 100%);
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb,
#conversationHistory::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-radius: 10px;
    border: 2px solid #f1f1f1;
}

.chat-messages::-webkit-scrollbar-thumb:hover,
#conversationHistory::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
}

/* Toast Notification */
.alert.alert-success.position-fixed {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
    color: white !important;
    border: none !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4) !important;
    font-weight: 500;
}

/* Stats Cards */
.stats-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 5px solid #007bff;
    transition: all 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stats-card.bg-success {
    border-left-color: #28a745;
}

.stats-card.bg-warning {
    border-left-color: #ffc107;
}

.stats-card.bg-info {
    border-left-color: #17a2b8;
}

/* Responsive Design */
@media (max-width: 768px) {
    .message.user {
        margin-left: 20px;
    }

    .message.ai,
    .message.enhanced {
        margin-right: 20px;
    }

    .quick-actions {
        flex-direction: column;
    }

    .quick-action-btn {
        width: 100%;
        margin-bottom: 5px;
    }
}

/* Nigerian Flag Colors Accent */
.nigeria-accent {
    border-left: 5px solid #008751;
    border-right: 2px solid #ffffff;
    border-bottom: 2px solid #008751;
}

/* Enhanced Collapse Animation */
.collapse {
    transition: all 0.4s ease;
}

.collapsing {
    transition: height 0.4s ease;
}
</style>
`;

// Add styles to head
document.head.insertAdjacentHTML('beforeend', enhancedStyles);
</script>
{% endblock %}
