{% extends "base.html" %}

{% block title %}raqibtech.com Customer Support - How can we help you?{% endblock %}

{% block content %}

<!-- Customer Support Navigation -->
<div class="row">
    <div class="col-12">
        <!-- Support Navigation Tabs -->
        <ul class="nav nav-tabs nav-fill" id="supportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                    <i class="bi bi-chat-heart-fill me-2"></i>
                    üí¨ Get Help Now
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                    <i class="bi bi-box-seam me-2"></i>
                    üì¶ Track My Orders
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                    <i class="bi bi-person-gear me-2"></i>
                    üë§ My Account
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                    <i class="bi bi-telephone-fill me-2"></i>
                    üìû Contact Support
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content border border-top-0 p-4" id="supportTabContent">

            <!-- Get Help Now Tab (Primary Chat Interface) -->
            <div class="tab-pane fade show active" id="chat" role="tabpanel">
                <div class="mb-4">
                    <h4 class="mb-3">
                        <i class="bi bi-robot text-primary me-2"></i>
                        Chat with our AI Support Assistant
                    </h4>
                    <p class="text-muted mb-4">
                        Ask me anything about your orders, payments, delivery, account, or shopping on raqibtech.com!
                    </p>
                </div>

                <div class="row">
                    <!-- Main Chat Interface -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="chat-messages" id="chatMessages">
                                <div class="message ai welcome">
                                    <div class="message-header">
                                        <div class="ai-avatar">
                                            <i class="bi bi-robot"></i>
                                        </div>
                                        <strong>raqibtech.com AI Assistant</strong>
                                        <span class="badge bg-success ms-2">Online</span>
                                    </div>
                                    <div class="message-bubble">
                                        <div class="welcome-content">
                                            <h6 class="mb-2">üëã Hello! Welcome to raqibtech.com support!</h6>
                                            <p class="mb-3">I'm here to help you with:</p>
                                            <ul class="list-unstyled mb-3">
                                                <li class="mb-1">üîç <strong>Order tracking</strong> - "Where is my order?"</li>
                                                <li class="mb-1">üí≥ <strong>Payment help</strong> - "Payment issue with my order"</li>
                                                <li class="mb-1">üöö <strong>Delivery updates</strong> - "When will my order arrive?"</li>
                                                <li class="mb-1">üë§ <strong>Account questions</strong> - "Update my profile"</li>
                                                <li class="mb-1">üõçÔ∏è <strong>Shopping help</strong> - "Product recommendations"</li>
                                            </ul>
                                            <div class="quick-start-actions">
                                                <p class="mb-2"><strong>Quick Start:</strong></p>
                                                <div class="quick-actions">
                                                    <button class="quick-action-btn" onclick="sendQuickMessage('Track my recent order')">
                                                        üîç Track My Order
                                                    </button>
                                                    <button class="quick-action-btn" onclick="sendQuickMessage('Help with payment issue')">
                                                        üí≥ Payment Help
                                                    </button>
                                                    <button class="quick-action-btn" onclick="sendQuickMessage('Where is my delivery?')">
                                                        üöö Delivery Status
                                                    </button>
                                                    <button class="quick-action-btn" onclick="sendQuickMessage('Update my account information')">
                                                        üë§ Account Help
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="message-timestamp">
                                        <i class="bi bi-clock me-1"></i>Support available 24/7
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="chatInput"
                                           placeholder="Ask me anything..."
                                           onkeypress="handleChatKeyPress(event)">
                                    <button class="btn btn-primary" type="button" onclick="sendChatMessage()">
                                        <i class="bi bi-send-fill me-1"></i>Send
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-shield-check me-1"></i>Your conversations are secure and private
                                    </small>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showTechnicalDetails">
                                        <label class="form-check-label" for="showTechnicalDetails">
                                            <small class="text-muted">Show technical details</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Help Sidebar -->
                    <div class="col-lg-4">
                        <!-- Quick Help Categories -->
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-lightning-fill me-1"></i>
                                    Common Questions
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm category-btn" data-category="order_tracking">
                                        <i class="bi bi-box-seam me-1"></i> Order & Delivery Questions
                                    </button>
                                    <button class="btn btn-outline-success btn-sm category-btn" data-category="payments">
                                        <i class="bi bi-credit-card me-1"></i> Payment & Billing Help
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm category-btn" data-category="account">
                                        <i class="bi bi-person-gear me-1"></i> Account & Profile
                                    </button>
                                    <button class="btn btn-outline-info btn-sm category-btn" data-category="shopping">
                                        <i class="bi bi-bag-heart me-1"></i> Shopping & Products
                                    </button>
                                </div>

                                <!-- Suggested Questions -->
                                <div id="suggestedQuestions" class="mt-3" style="display: none;">
                                    <small class="text-muted"><strong>Try asking:</strong></small>
                                    <div id="questionsContainer" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Support Status -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-headset me-1"></i>
                                    Support Status
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="support-status-info">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>AI Assistant</span>
                                        <span class="badge bg-success">Online 24/7</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Live Chat</span>
                                        <span class="badge bg-success">Available</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>Phone Support</span>
                                        <span class="badge bg-primary">8AM-8PM WAT</span>
                                    </div>

                                    <div class="current-time">
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>
                                            Nigeria Time: <span class="nigerian-time">--:-- WAT</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Track My Orders Tab -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
                <div class="mb-4">
                    <h4 class="mb-3">
                        <i class="bi bi-box-seam text-primary me-2"></i>
                        Track Your Orders
                    </h4>
                    <p class="text-muted">
                        Enter your order ID or email to track your recent orders and delivery status.
                    </p>
                </div>

                <!-- Order Tracking Form -->
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Quick Order Lookup</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Order ID</label>
                                    <input type="text" class="form-control" id="orderIdInput"
                                           placeholder="Enter your order ID (e.g., 12345)">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email (Optional)</label>
                                    <input type="email" class="form-control" id="emailInput"
                                           placeholder="Your email address">
                                </div>
                                <button class="btn btn-primary w-100" onclick="trackCustomerOrder()">
                                    <i class="bi bi-search me-1"></i>Track My Order
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="mb-3">
                                    <i class="bi bi-info-circle text-info me-1"></i>
                                    Order Status Guide
                                </h6>
                                <ul class="list-unstyled small">
                                    <li class="mb-1">
                                        <span class="badge bg-warning me-2">Pending</span>
                                        Order received, being prepared
                                    </li>
                                    <li class="mb-1">
                                        <span class="badge bg-info me-2">Processing</span>
                                        Order being processed for delivery
                                    </li>
                                    <li class="mb-1">
                                        <span class="badge bg-success me-2">Delivered</span>
                                        Order delivered successfully
                                    </li>
                                    <li class="mb-1">
                                        <span class="badge bg-secondary me-2">Returned</span>
                                        Order was returned
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Orders Display -->
                <div id="customerOrdersDisplay">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-box display-1 mb-3"></i>
                        <p>Enter your order details above to track your orders</p>
                    </div>
                </div>
            </div>

            <!-- My Account Tab -->
            <div class="tab-pane fade" id="account" role="tabpanel">
                <div class="mb-4">
                    <h4 class="mb-3">
                        <i class="bi bi-person-gear text-warning me-2"></i>
                        My Account & Profile
                    </h4>
                    <p class="text-muted">
                        Manage your account information, delivery addresses, and preferences.
                    </p>
                </div>

                <div class="row">
                    <!-- Account Actions -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Account Services</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="sendQuickMessage('Update my profile information')">
                                        <i class="bi bi-person-fill-gear me-2"></i>Update Profile Information
                                    </button>
                                    <button class="btn btn-outline-success" onclick="sendQuickMessage('Change my delivery address')">
                                        <i class="bi bi-geo-alt-fill me-2"></i>Update Delivery Address
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="sendQuickMessage('Check my account tier and benefits')">
                                        <i class="bi bi-star-fill me-2"></i>View Account Tier & Benefits
                                    </button>
                                    <button class="btn btn-outline-info" onclick="sendQuickMessage('Update my payment methods')">
                                        <i class="bi bi-credit-card-fill me-2"></i>Manage Payment Methods
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Benefits -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Account Tiers & Benefits</h6>
                            </div>
                            <div class="card-body">
                                <div class="tier-info">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-secondary">Bronze</span>
                                        <small>Standard benefits</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-primary">Silver</span>
                                        <small>5% discount + priority support</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge bg-warning">Gold</span>
                                        <small>10% discount + free delivery</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-info">Platinum</span>
                                        <small>15% discount + premium perks</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Support Tab -->
            <div class="tab-pane fade" id="contact" role="tabpanel">
                <div class="mb-4">
                    <h4 class="mb-3">
                        <i class="bi bi-telephone-fill text-danger me-2"></i>
                        Contact raqibtech.com Support
                    </h4>
                    <p class="text-muted">
                        Multiple ways to reach our support team across Nigeria.
                    </p>
                </div>

                <div class="row">
                    <!-- Contact Methods -->
                    <div class="col-lg-4 mb-3">
                        <div class="card h-100 text-center">
                            <div class="card-body">
                                <i class="bi bi-telephone-fill text-success display-4 mb-3"></i>
                                <h6>Phone Support</h6>
                                <p class="text-muted small">Speak with our support team</p>
                                <strong class="text-success">+234 800 RAQIB (72242)</strong>
                                <p class="small mt-2">Daily 8AM - 8PM (WAT)</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 mb-3">
                        <div class="card h-100 text-center">
                            <div class="card-body">
                                <i class="bi bi-envelope-fill text-primary display-4 mb-3"></i>
                                <h6>Email Support</h6>
                                <p class="text-muted small">Send us your questions</p>
                                <strong class="text-primary">support@raqibtech.com</strong>
                                <p class="small mt-2">Response within 24 hours</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 mb-3">
                        <div class="card h-100 text-center">
                            <div class="card-body">
                                <i class="bi bi-chat-heart-fill text-danger display-4 mb-3"></i>
                                <h6>Live AI Chat</h6>
                                <p class="text-muted small">Instant help available</p>
                                <strong class="text-danger">Available 24/7</strong>
                                <p class="small mt-2">
                                    <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('chat-tab').click()">
                                        Start Chat Now
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nigerian Coverage -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h6 class="mb-3">
                                    <i class="bi bi-geo-alt-fill me-2"></i>
                                    üá≥üá¨ Nationwide Coverage in Nigeria
                                </h6>
                                <p class="mb-0">
                                    We deliver to all 36 Nigerian states + FCT with dedicated support for your region.
                                    Payment options include Pay on Delivery, Bank Transfer, Card, and RaqibTechPay.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Support JavaScript -->
<script>
// Customer-focused support system
class CustomerSupportPortal {
    constructor() {
        console.log('üõçÔ∏è Initializing raqibtech.com Customer Support Portal...');
        this.initializeCustomerFeatures();
    }

    initializeCustomerFeatures() {
        // Category help buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.showCategoryQuestions(e.target.dataset.category);
            });
        });

        // Focus chat input when page loads
        setTimeout(() => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.focus();
            }
        }, 1000);
    }

    async sendCustomerMessage(message = null) {
        const chatInput = document.getElementById('chatInput');
        if (!chatInput) return;

        const userMessage = message || chatInput.value.trim();
        if (!userMessage) return;

        // Clear input
        if (!message) chatInput.value = '';

        // Add user message to chat
        this.addMessageToChat(userMessage, 'customer');

        // Show typing indicator
        this.showTypingIndicator();

        try {
            // Send to enhanced API
            const response = await fetch('/api/enhanced-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: userMessage,
                    include_sql: document.getElementById('showTechnicalDetails')?.checked || false
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            this.removeTypingIndicator();

            if (data.success) {
                this.addCustomerResponseToChat(data);
            } else {
                this.addMessageToChat(data.message || 'Sorry, I encountered an issue. Please try again.', 'ai', true);
            }

        } catch (error) {
            this.removeTypingIndicator();
            console.error('‚ùå Customer chat error:', error);
            this.addMessageToChat('I apologize, but I\'m experiencing technical difficulties. Please try again or contact our phone support at +234 800 RAQIB.', 'ai', true);
        }
    }

    addMessageToChat(message, sender, isError = false) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender === 'customer' ? 'customer' : 'ai'}`;

        if (isError) {
            messageDiv.classList.add('error');
        }

        const timestamp = new Date().toLocaleTimeString();
        const senderName = sender === 'customer' ? 'You' : 'raqibtech.com Assistant';

        if (sender === 'customer') {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>${senderName}</strong>
                </div>
                <div class="message-bubble">
                    ${message}
                </div>
                <div class="message-timestamp">${timestamp}</div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="ai-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <strong>${senderName}</strong>
                </div>
                <div class="message-bubble">
                    ${message}
                </div>
                <div class="message-timestamp">${timestamp}</div>
            `;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    addCustomerResponseToChat(data) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai customer-response';

        const timestamp = new Date().toLocaleTimeString();

        let messageContent = `
            <div class="message-header">
                <div class="ai-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <strong>raqibtech.com Assistant</strong>
            </div>
            <div class="message-bubble">
                <div class="message-content mb-2">${data.response}</div>
        `;

        // Add helpful follow-up actions for customers
        if (data.query_type) {
            const followUpActions = this.getCustomerFollowUpActions(data.query_type);
            if (followUpActions.length > 0) {
                messageContent += `
                    <div class="follow-up-actions mt-2">
                        <small class="text-muted d-block mb-2">What else can I help you with?</small>
                        <div class="quick-actions">
                            ${followUpActions.map(action =>
                                `<button class="quick-action-btn" onclick="customerPortal.sendCustomerMessage('${action}')">${action}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Show technical details if requested
        if (document.getElementById('showTechnicalDetails')?.checked && data.sql_query) {
            messageContent += `
                <details class="mt-2">
                    <summary class="small text-muted">Technical Details</summary>
                    <div class="technical-info small mt-1 p-2 rounded">
                        <strong>Query Type:</strong> ${data.query_type || 'N/A'}<br>
                        <strong>Results:</strong> ${data.results_count || 0} records<br>
                        <strong>Processing Time:</strong> ${data.execution_time || 'N/A'}
                    </div>
                </details>
            `;
        }

        messageContent += `
            </div>
            <div class="message-timestamp">
                <i class="bi bi-clock me-1"></i>${timestamp}
            </div>
        `;

        messageDiv.innerHTML = messageContent;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    getCustomerFollowUpActions(queryType) {
        const actions = {
            'order_analytics': [
                'Update my delivery address',
                'Check payment status',
                'Cancel an order'
            ],
            'customer_analysis': [
                'Update my profile',
                'Change password',
                'View account benefits'
            ],
            'revenue_insights': [
                'Check my spending',
                'View payment history',
                'Update payment method'
            ]
        };

        return actions[queryType] || [
            'Track another order',
            'Update my account',
            'Contact phone support'
        ];
    }

    showCategoryQuestions(category) {
        const questions = {
            'order_tracking': [
                'Track my order #12345',
                'Where is my delivery?',
                'Change delivery address',
                'Cancel my order'
            ],
            'payments': [
                'Payment issue with my order',
                'Update my payment method',
                'Refund request',
                'Payment options available'
            ],
            'account': [
                'Update my profile information',
                'Change my password',
                'Check my account tier',
                'Update delivery address'
            ],
            'shopping': [
                'Product recommendations',
                'Return policy',
                'Delivery charges',
                'Product availability'
            ]
        };

        const container = document.getElementById('questionsContainer');
        const questionsDiv = document.getElementById('suggestedQuestions');

        if (container && questionsDiv) {
            container.innerHTML = '';

            questions[category].forEach(question => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary me-1 mb-1';
                btn.textContent = question;
                btn.onclick = () => {
                    this.sendCustomerMessage(question);
                    questionsDiv.style.display = 'none';
                };
                container.appendChild(btn);
            });

            questionsDiv.style.display = 'block';
        }
    }

    showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-header">
                <div class="ai-avatar">
                    <i class="bi bi-robot"></i>
                </div>
                <strong>raqibtech.com Assistant</strong>
            </div>
            <div class="message-bubble">
                <div class="typing-animation">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;

        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    async trackCustomerOrder() {
        const orderIdInput = document.getElementById('orderIdInput');
        const emailInput = document.getElementById('emailInput');

        const orderId = orderIdInput?.value.trim();

        if (!orderId) {
            alert('Please enter your order ID');
            return;
        }

        // Use the chat system to track the order
        const query = `Track my order ${orderId}`;
        this.sendCustomerMessage(query);

        // Switch to chat tab to show results
        document.getElementById('chat-tab').click();
    }
}

// Global functions for compatibility
function sendChatMessage() {
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage();
    }
}

function sendQuickMessage(message) {
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage(message);
    }
}

function trackCustomerOrder() {
    if (window.customerPortal) {
        window.customerPortal.trackCustomerOrder();
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

// Initialize customer portal when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing raqibtech.com Customer Support Portal');
    window.customerPortal = new CustomerSupportPortal();
    console.log('‚úÖ Customer support portal ready!');
});
</script>
{% endblock %}
