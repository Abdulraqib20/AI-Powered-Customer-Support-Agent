{% extends "base.html" %}

{% block title %}raqibtech.com Customer Support - How can we help you?{% endblock %}

{% block content %}

<!-- Enhanced Floating Modal Chat System with Microsoft-style Design -->
<style>
/* ===== FLOATING CHAT MODAL SYSTEM ===== */
/* Floating Chat Button */
.floating-chat-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #2c3e50 0%, #18bc9c 100%);
    border-radius: 50%;
    box-shadow: 0 8px 32px rgba(44, 62, 80, 0.3);
    border: none;
    cursor: pointer;
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: scale(1);
    pointer-events: auto;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    outline: none;
}

.floating-chat-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 40px rgba(44, 62, 80, 0.4);
    background: linear-gradient(135deg, #18bc9c 0%, #2c3e50 100%);
}

.floating-chat-btn:active {
    transform: scale(0.95);
}

.floating-chat-btn.active {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    transform: rotate(45deg) scale(1.1);
}

/* Chat Modal Overlay */
.chat-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 9999;
    display: none;
    opacity: 0;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
}

.chat-modal-overlay.active {
    display: flex;
    opacity: 1;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
}

/* Main Chat Modal Container */
.chat-modal {
    width: 400px;
    height: 600px;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: scale(0.9) translateY(50px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    pointer-events: auto;
}

.chat-modal-overlay.active .chat-modal {
    transform: scale(1) translateY(0);
}

/* Modal Header */
.chat-modal-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.chat-modal-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.chat-modal-title .brand-logo {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.chat-modal-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.chat-modal-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.chat-modal-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
}

/* Conversation Sidebar */
.conversation-sidebar {
    position: absolute;
    left: -300px;
    top: 0;
    width: 300px;
    height: 100%;
    background: #f8f9fa;
    border-right: 1px solid #e9ecef;
    z-index: 10;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.conversation-sidebar.active {
    transform: translateX(300px);
}

.conversation-sidebar-header {
    padding: 16px;
    background: #ffffff;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.conversation-sidebar-title {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

/* Sidebar overlay effect when open */
.chat-modal.sidebar-open::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 5;
    pointer-events: none;
}

.conversation-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

/* Chat Messages Area */
/* .chat-modal-messages {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 100%;
} */

.chat-modal-messages {
    flex: 1;
    padding: 0; /* Remove padding for full width messages */
    overflow-y: auto;
    background: #f8f9fa; /* White background like ChatGPT */
    display: flex;
    flex-direction: column;
    gap: 0; /* No gaps - messages touch each other */
    max-width: 100%;
}

/* ===== WELCOME PAGE STYLES ===== */
.welcome-page {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    height: 100%;
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.welcome-page .brand-logo-large {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: white;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(24, 188, 156, 0.3);
}

.welcome-page h2 {
    font-size: 22px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.welcome-page p {
    font-size: 14px;
    color: #576574;
    margin-bottom: 24px;
    line-height: 1.6;
    max-width: 300px;
}

.welcome-quick-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 280px;
}

.welcome-quick-actions .quick-action-btn {
    background: #ffffff;
    color: #2c3e50;
    border: 1px solid #e0e0e0;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.welcome-quick-actions .quick-action-btn:hover {
    background: #f8f9fa;
    border-color: #ced4da;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.welcome-quick-actions .quick-action-btn i {
    color: #18bc9c;
    font-size: 16px;
}

/* Message Bubbles - Microsoft Fluent Style */
/* .message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
} */

 .message {
    display: flex;
    flex-direction: column;
    animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    margin-bottom: 24px; /* More spacing between messages like ChatGPT */
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.customer {
    align-items: flex-end; /* Align the entire message to the right */
    margin-left: auto; /* Push message container to the right */
    max-width: 80%; /* Limit width like ChatGPT */
}

/* .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
} */

/* .message.ai .message-avatar {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    margin-right: 10px;
    margin-top: 8px;
    padding: 10px;
}

.message.customer .message-avatar {
    background: linear-gradient(135deg, #18bc9c, #16a085);
    color: white;
    margin-left: 10px;
    margin-top: 8px;
} */

/* .message.customer .message-content {
    display: flex;
    flex-direction: row-reverse;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
} */

/* .message-content {
    max-width: calc(100% - 60px);
    flex: 1;
} */

.message-content {
    max-width: 100%;
    width: 100%;
    flex: 1;
}

.message-bubble {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 16px;
    padding: 16px 20px; /* More padding like ChatGPT */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    font-size: 13.5x; /* Slightly larger font */
    line-height: 1.6; /* Better line height */
    word-wrap: break-word;
    position: relative;
    white-space: pre-wrap; /* Preserve whitespace formatting */
    width: 100%; /* Full width within container */
    box-sizing: border-box;
}

/* Enhanced AI Message Formatting */
.message.ai .message-bubble {
    background: #f8f9fa;
    /* border: 1px solid #dee2e6;
    line-height: 1.6;
    white-space: normal; */

    border: none;
    border-radius: 0; /* Remove border radius for full width */
    padding: 24px; /* ChatGPT-style padding */
    margin: 0; /* No margins for full width */
    width: 100%;
    box-sizing: border-box;
    box-shadow: none;
    line-height: 1.6;
    white-space: normal;
}

.message.ai .message-bubble br {
    line-height: 1.8; /* Extra space between lines */
}

/* Better spacing for structured AI responses */
.message.ai .message-bubble p {
    margin: 8px 0;
}

.message.ai .message-bubble ul,
.message.ai .message-bubble ol {
    margin: 8px 0 8px 16px;
    padding-left: 0;
}

.message.ai .message-bubble li {
    margin: 4px 0;
}

/* Customer message bubble adjustments */
.message.customer .message-bubble {
    max-width: fit-content; /* Adjust to content width */
    margin-left: auto; /* Push bubble to the right */
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    border-color: #2c3e50;
}
.message.customer .message-bubble {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    border-color: #2c3e50;
}

.message:last-child .message-bubble {
    border-bottom: none;
}

/* Hide customer message timestamp */
.message.customer .message-meta {
    display: none;
}

/* .message-meta {
    margin-top: 4px;
    font-size: 11px;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
} */
.message-meta {
    margin-top: 8px;
    font-size: 11px;
    color: #6c757d;
    display: flex;
    justify-content: flex-start; /* Always align left */
    align-items: center;
    padding: 0 24px; /* Match bubble padding */
}

.response-time {
    font-size: 10px;
    color: #18bc9c;
    background: rgba(24, 188, 156, 0.1);
    padding: 2px 6px;
    border-radius: 8px;
    white-space: nowrap;
}

/* Welcome Message - Enhanced */
/* .message.welcome .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    color: white;
    border: none;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
} */
.message.welcome .message-bubble {
    background: #f7f7f8; /* Match AI message background */
    color: #000000; /* Black text */
    border: none;
    box-shadow: none;
    border-radius: 0;
    padding: 24px;
    margin: 0;
    width: 100%;
    border-bottom: 1px solid #ececf1;
    position: relative;
    overflow: visible;
}

.message.welcome .message-bubble::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
    animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0.5; transform: rotate(0deg) scale(1); }
    50% { opacity: 1; transform: rotate(180deg) scale(1.05); }
}

.welcome-content {
    position: relative;
    z-index: 1;
}

.welcome-content h6 {
    font-size: 16px;
    font-weight: 700;
    color: #2C3E50;
    margin-bottom: 12px;
}

/* .welcome-content p {
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 12px;
    color: #2C3E50;
    font-weight: 500;
} */
.welcome-content p {
    color: #000000;
}

.welcome-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
}

.welcome-quick-action-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #2C3E50;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.welcome-quick-action-btn:hover {
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
    text-decoration: none;
    transform: translateY(-2px);
    border-color: #ffd700;
}

/* Smart Quick Actions */
.smart-quick-actions-container {
    margin: 12px 0;
}

.smart-quick-actions {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.quick-actions-header {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    text-align: center;
}

.quick-actions-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}

.smart-quick-action-btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 2px 6px rgba(0,123,255,0.2);
}

.smart-quick-action-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

/* Chat Input Area */
.chat-modal-input {
    padding: 16px;
    background: #ffffff;
    border-top: 1px solid #e9ecef;
}

.chat-input-container {
    display: flex;
    gap: 8px;
    align-items: center;
}

.chat-input-container input {
    flex: 1;
    border: 1px solid #e9ecef;
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 14px;
    outline: none;
    transition: all 0.2s ease;
}

.chat-input-container input:focus {
    border-color: #18bc9c;
    box-shadow: 0 0 0 3px rgba(24, 188, 156, 0.1);
}

.chat-send-btn {
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(24, 188, 156, 0.2);
}

.chat-send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(24, 188, 156, 0.3);
}

.chat-send-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Typing Indicator */
/* .typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
} */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 24px; /* Match message padding */
    background: #f7f7f8; /* Match AI background */
    border-bottom: 1px solid #ececf1;
    width: 100%;
    box-sizing: border-box;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #6c757d;
    animation: typingPulse 1.4s ease-in-out infinite both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes typingPulse {
    0%, 80%, 100% {
        opacity: 0.4;
        transform: scale(0.8);
    }
    40% {
        opacity: 1;
        transform: scale(1);
    }
}

/* Conversation List Items */
.conversation-item {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.conversation-item:hover {
    background: #f8f9fa;
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.conversation-item.active {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
}

.conversation-info h6 {
    font-size: 13px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0 0 4px 0;
}

.conversation-info small {
    font-size: 11px;
    color: #6c757d;
}

.conversation-actions {
    display: flex;
    align-items: center;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.conversation-item:hover .conversation-actions {
    opacity: 1;
}

.conversation-actions .btn-sm {
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 4px;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .message.ai .message-bubble,
    .message.customer .message-bubble,
    .message.welcome .message-bubble {
        padding: 16px; /* Slightly less padding on mobile */
    }

    .message-meta {
        padding: 0 16px;
    }

    .typing-indicator {
        padding: 16px;
    }

    .chat-modal {
        width: 100%;
        height: 100%;
        border-radius: 0;
        transform: translateY(100%);
    }

    .chat-modal-overlay.active .chat-modal {
        transform: translateY(0);
    }

    .conversation-sidebar {
        width: 280px;
        left: -280px;
    }

    .conversation-sidebar.active {
        transform: translateX(280px);
    }

    .floating-chat-btn {
        bottom: 16px;
        right: 16px;
        width: 56px;
        height: 56px;
        font-size: 20px;
    }
}

/* Loading States */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #18bc9c;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Hide original chat tab content */
.original-chat-content {
    display: none;
}

/* ===== ENHANCED WELCOME MESSAGE STYLES ===== */

/* AI Avatar Enhancement */
/* .ai-avatar-icon {
    font-size: 18px;
    animation: pulse 2s ease-in-out infinite;
} */

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Welcome Header */
.welcome-header {
    margin-bottom: 20px;
}

.welcome-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
    margin-bottom: 16px;
}

.brand-icon {
    font-size: 24px;
    animation: rotate 3s linear infinite;
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.brand-text .brand-title {
    font-size: 18px;
    font-weight: 700;
    margin: 0;
    color: #ffffff;
}

.brand-text .domain {
    color: #ffd700;
}

.brand-text .brand-subtitle {
    font-size: 12px;
    margin: 0;
    opacity: 0.9;
    color: #e3f2fd;
}

/* Welcome Greeting */
.welcome-greeting {
    margin-bottom: 20px;
    text-align: center;
}

.greeting-text {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.greeting-subtitle {
    font-size: 13px;
    color: #6c757d;
    line-height: 1.5;
    margin: 0;
}

/* Capabilities Grid */
.capabilities-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-bottom: 20px;
}

.capability-card {
    padding: 10px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    border: 1px solid;
}

.capability-card.primary {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-color: #2196f3;
}

.capability-card.secondary {
    background: linear-gradient(135deg, #f3e5f5, #e1bee7);
    border-color: #9c27b0;
}

.capability-card.accent {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border-color: #ff9800;
}

.capability-card.success {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    border-color: #4caf50;
}

.capability-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
}

.capability-icon {
    font-size: 18px;
    flex-shrink: 0;
    line-height: 1;
}

.capability-content h6 {
    font-size: 11px;
    font-weight: 600;
    margin: 0 0 3px 0;
    color: #2c3e50;
    line-height: 1.2;
}

.capability-content p {
    font-size: 9px;
    margin: 0;
    color: #6c757d;
    line-height: 1.3;
    word-wrap: break-word;
}

/* Platform Showcase (for guests) */
.platform-showcase {
    margin-bottom: 20px;
}

.showcase-card {
        padding: 16px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    border: 1px solid #dee2e6;
    margin-bottom: 12px;
}

.showcase-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.showcase-icon {
    font-size: 20px;
}

.showcase-header h6 {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    color: #2c3e50;
}

.showcase-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.tag {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    border: 1px solid;
}

.tag.electronics {
    background: #e3f2fd;
    color: #1976d2;
    border-color: #2196f3;
}

.tag.fashion {
    background: #fce4ec;
    color: #c2185b;
    border-color: #e91e63;
}

.tag.beauty {
    background: #f3e5f5;
    color: #7b1fa2;
    border-color: #9c27b0;
}

.tag.computing {
    background: #e8f5e8;
    color: #388e3c;
    border-color: #4caf50;
}

.tag.automotive {
    background: #fff3e0;
    color: #f57c00;
    border-color: #ff9800;
}

.tag.books {
    background: #efebe9;
    color: #5d4037;
    border-color: #795548;
}

.showcase-features {
    display: grid;
    grid-template-columns: 1fr;
    gap: 6px;
    margin-top: 12px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 8px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.feature-icon {
    font-size: 12px;
    flex-shrink: 0;
}

.feature-text {
    font-size: 9px;
    font-weight: 500;
    color: #2c3e50;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Quick Actions Section */
.quick-actions-section {
    margin-bottom: 20px;
}

.section-title {
    font-size: 13px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 12px;
    text-align: center;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.action-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 6px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border: 1px solid;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    width: 100%;
    box-sizing: border-box;
}

.action-btn.primary {
    color: #1976d2;
    border-color: #2196f3;
}

.action-btn.primary:hover {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(33, 150, 243, 0.2);
}

.action-btn.secondary {
    color: #7b1fa2;
    border-color: #9c27b0;
}

.action-btn.secondary:hover {
    background: linear-gradient(135deg, #f3e5f5, #e1bee7);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(156, 39, 176, 0.2);
}

.action-btn.accent {
    color: #f57c00;
    border-color: #ff9800;
}

.action-btn.accent:hover {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(255, 152, 0, 0.2);
}

.action-btn.success {
    color: #388e3c;
    border-color: #4caf50;
}

.action-btn.success:hover {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(76, 175, 80, 0.2);
}

.action-btn.warning {
    color: #f57c00;
    border-color: #ff9800;
}

.action-btn.warning:hover {
    background: linear-gradient(135deg, #fff8e1, #ffecb3);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(255, 152, 0, 0.2);
}

.action-btn.info {
    color: #0288d1;
    border-color: #03a9f4;
}

.action-btn.info:hover {
    background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(3, 169, 244, 0.2);
}

.action-icon {
    font-size: 12px;
    flex-shrink: 0;
}

.action-text {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Welcome Footer */
.welcome-footer {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.footer-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 12px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    text-align: center;
}

.stat-icon {
    font-size: 16px;
}

.stat-text {
    font-size: 9px;
    font-weight: 500;
    color: #6c757d;
}

.cta-section {
    margin-bottom: 12px;
}

.cta-highlight {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border: 1px solid #ff9800;
    border-radius: 8px;
}

.cta-icon {
    font-size: 16px;
}

.cta-text {
    font-size: 11px;
    font-weight: 500;
    color: #e65100;
}

.footer-cta {
    font-size: 11px;
    text-align: center;
    color: #6c757d;
    margin: 0;
}

/* Welcome Message Responsive */
@media (max-width: 480px) {
    .capabilities-grid,
    .action-grid {
        grid-template-columns: 1fr;
    }

    .showcase-features {
        grid-template-columns: 1fr;
    }

    .footer-stats {
        flex-direction: column;
        gap: 8px;
    }

    .footer-stats .stat-item {
        flex-direction: row;
        gap: 6px;
    }
}

/* Fix: Make close button visible in sidebar header */
.conversation-sidebar-header .chat-modal-btn {
    background: rgba(44, 62, 80, 0.1);
    color: #2c3e50;
    border: 1px solid rgba(44, 62, 80, 0.2);
}

.conversation-sidebar-header .chat-modal-btn:hover {
    background: rgba(44, 62, 80, 0.2);
    color: #2c3e50;
}

    .btn:disabled {
        opacity: 0.6;
    }

    .alert {
        border: none;
        border-radius: 8px;
    }

    /* Enhanced Order Tracking Timeline Styles */
    .tracking-timeline {
        padding: 20px 0;
    }

    .timeline-item {
        display: flex;
        margin-bottom: 20px;
        position: relative;
    }

    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 20px;
        top: 40px;
        width: 2px;
        height: calc(100% + 10px);
        background-color: #e3e6f0;
        z-index: 1;
    }

    .timeline-item.completed:not(:last-child)::after {
        background-color: #1cc88a;
    }

    .timeline-marker {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e3e6f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        position: relative;
        z-index: 2;
        flex-shrink: 0;
    }

    .timeline-item.completed .timeline-marker {
        background-color: #1cc88a;
        color: white;
    }

    .timeline-item.current .timeline-marker {
        background-color: #4e73df;
        color: white;
        animation: pulse 2s infinite;
    }

    .timeline-icon {
        font-size: 16px;
    }

    .timeline-content {
        flex: 1;
        padding-top: 5px;
    }

    .timeline-title {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 600;
        color: #5a5c69;
    }

    .timeline-item.completed .timeline-title {
        color: #1cc88a;
    }

    .timeline-item.current .timeline-title {
        color: #4e73df;
    }

    .timeline-description {
        margin: 0;
        color: #858796;
        font-size: 14px;
        line-height: 1.4;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(78, 115, 223, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0);
        }
    }

    /* Enhanced order modal styles */
    .modal-lg {
        max-width: 900px;
    }

    .order-details-card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border-radius: 12px;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }

    .delivery-info-card {
        background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
        border: 1px solid #e3e6f0;
        border-radius: 12px;
    }
</style>

<!-- Session and User Info Header -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="session-info">
                {% if session.get('user_authenticated') %}
                    <span class="badge bg-success">
                        <i class="bi bi-person-check-fill me-1"></i>
                        Logged in as {{ session.get('user_email', 'User') }}
                    </span>
                {% else %}
                    <span class="badge bg-secondary">
                        <i class="bi bi-person me-1"></i>
                        Guest Session
                    </span>
                {% endif %}
            </div>
            <div class="session-actions">
                {% if session.get('user_authenticated') %}
                    <a href="/logout" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </a>
                {% else %}
                    <a href="/signup" class="btn btn-success btn-sm me-2">
                        <i class="bi bi-person-plus me-1"></i>Sign Up
                    </a>
                    <a href="/login" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Simplified Dashboard without Chat Tab -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <!-- Support Navigation Tabs (without chat) -->
            <ul class="nav nav-tabs nav-fill" id="supportTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                        <i class="bi bi-box-seam me-2"></i>
                        üì¶ Track My Orders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                        <i class="bi bi-person-gear me-2"></i>
                        üë§ My Account
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                        <i class="bi bi-telephone-fill me-2"></i>
                        üìû Contact Support
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="supportTabContent">
                <!-- Track My Orders Tab -->
                <div class="tab-pane fade show active" id="orders" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-box-seam text-primary me-2"></i>
                                Track Your Orders
                            </h4>
                            <p class="text-muted">
                                {% if session.get('user_authenticated') %}
                                    Your recent orders will appear here. You can also ask our AI assistant for help.
                                    <br><small class="text-info">
                                        <i class="bi bi-person-check me-1"></i>
                                        Logged in as: {{ session.get('username', 'User') }}
                                        (Customer ID: {{ session.get('customer_id', 'Unknown') }})
                                    </small>
                                {% else %}
                                    <a href="/login" class="text-decoration-none">Login</a> to see your order history, or ask our AI assistant for help.
                                {% endif %}
                            </p>
                        </div>

                        {% if session.get('user_authenticated') %}
                        <!-- Authenticated User: Order History Display -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-clock-history text-info me-2"></i>
                                            My Order History
                                        </h6>
                                        <button class="btn btn-outline-primary btn-sm" onclick="loadMyOrders()" id="refreshOrdersBtn">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <!-- Order Loading State -->
                                        <div id="orderLoadingState" class="text-center py-4" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading orders...</span>
                                            </div>
                                            <p class="mt-2 text-muted">Loading your orders...</p>
                                        </div>

                                        <!-- Orders List Container -->
                                        <div id="ordersListContainer">
                                            <div class="text-center py-4 text-muted">
                                                <i class="bi bi-box-seam" style="font-size: 2rem;"></i>
                                                <p class="mt-2">Click "Refresh" to load your recent orders</p>
                                            </div>
                                        </div>

                                        <!-- No Orders State -->
                                        <div id="noOrdersState" class="text-center py-4" style="display: none;">
                                            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                            <p class="mt-2 text-muted">No orders found</p>
                                            <p class="small text-muted">Start shopping to see your orders here!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Integrated Shopping & Order Management -->
                        <div class="row mb-4">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-cart-plus text-success me-2"></i>
                                            Quick Shopping & Reorder
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">What would you like to order?</label>
                                                <input type="text" class="form-control" id="quickShopInput"
                                                       placeholder="e.g., iPhone 14, Samsung TV, Laptop">
                                                <small class="text-muted">Describe the product you want to buy</small>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Quantity</label>
                                                <input type="number" class="form-control" id="quickShopQuantity"
                                                       value="1" min="1" max="10">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Delivery State</label>
                                                <select class="form-select" id="quickShopState">
                                                    <option value="{{ session.get('customer_state', 'Lagos') }}">{{ session.get('customer_state', 'Lagos') }}</option>
                                                    <option value="Lagos">Lagos</option>
                                                    <option value="Abuja">Abuja</option>
                                                    <option value="Kano">Kano</option>
                                                    <option value="Rivers">Rivers</option>
                                                    <option value="Oyo">Oyo</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="d-grid gap-2 d-md-flex">
                                            <button class="btn btn-primary" onclick="quickOrderProduct()">
                                                <i class="bi bi-cart-check me-1"></i>Order Now
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="askAIForProduct()">
                                                <i class="bi bi-robot me-1"></i>Ask AI Assistant
                                            </button>
                                            <button class="btn btn-outline-info" onclick="browsePopularProducts()">
                                                <i class="bi bi-stars me-1"></i>Popular Items
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-info-circle text-info me-1"></i>
                                            Order Status Guide
                                        </h6>
                                        <ul class="list-unstyled small">
                                            <li class="mb-1">
                                                <span class="badge bg-warning me-2">Pending</span>
                                                Order received, being prepared
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-info me-2">Processing</span>
                                                Order being processed for delivery
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-success me-2">Delivered</span>
                                                Order delivered successfully
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-secondary me-2">Returned</span>
                                                Order was returned
                                            </li>
                                        </ul>

                                        <div class="mt-3 pt-3 border-top">
                                            <h6 class="small text-muted mb-2">Quick Actions</h6>
                                            <div class="d-grid gap-1">
                                                <button class="btn btn-outline-primary btn-sm" onclick="reorderPreviousItem()">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>Reorder Last Item
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="trackOrderViaChat()">
                                                    <i class="bi bi-search me-1"></i>Track Specific Order
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% else %}
                        <!-- Non-Authenticated User: Login Prompt and Basic Lookup -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Login Required for Full Order Tracking & Shopping
                                    </h6>
                                    <p class="mb-2">To view your complete order history, place new orders, and access personalized features, please log in to your account.</p>
                                    <div class="d-flex gap-2">
                                        <a href="/login" class="btn btn-primary btn-sm">
                                            <i class="bi bi-box-arrow-in-right me-1"></i>Login
                                        </a>
                                        <a href="/signup" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-person-plus me-1"></i>Create Account
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Order Tracking for Non-Authenticated Users -->
                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-search text-primary me-2"></i>
                                            Track Your Order
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Order ID</label>
                                            <input type="text" class="form-control" id="guestOrderIdInput"
                                                   placeholder="Enter your order ID (e.g., 34301)">
                                        </div>
                                        <button class="btn btn-primary w-100" onclick="trackGuestOrder()">
                                            <i class="bi bi-search me-1"></i>Track My Order
                                        </button>
                                        <p class="small text-muted mt-2">
                                            <i class="bi bi-info-circle me-1"></i>
                                            This will open our AI assistant to help you track your order
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-info-circle text-info me-1"></i>
                                            Order Status Guide
                                        </h6>
                                        <ul class="list-unstyled small">
                                            <li class="mb-1">
                                                <span class="badge bg-warning me-2">Pending</span>
                                                Order received, being prepared
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-info me-2">Processing</span>
                                                Order being processed for delivery
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-success me-2">Delivered</span>
                                                Order delivered successfully
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-secondary me-2">Returned</span>
                                                Order was returned
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- My Account Tab -->
                <div class="tab-pane fade" id="account" role="tabpanel">
                    <div class="p-4">
                        <!-- raqibtech.com Branding Header -->
                        {% if session.get('user_authenticated') %}
                        <div class="mb-4 text-center">
                            <div class="raqibtech-branding">
                                <h2 class="brand-title mb-2">
                                    <span class="brand-logo">üöÄ</span>
                                    <span class="brand-text">raqibtech</span>
                                    <span class="brand-domain">.com</span>
                                </h2>
                                <p class="brand-subtitle">Your Trusted Nigerian E-commerce Partner</p>
                                <div class="brand-stats">
                                    <span class="badge bg-success me-2">  36 States + FCT</span>
                                    <span class="badge bg-primary me-2">üì¶ 1M+ Deliveries</span>
                                    <span class="badge bg-warning">‚≠ê 4.8/5 Rating</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-person-gear text-warning me-2"></i>
                                My Account & Profile
                            </h4>
                            {% if session.get('user_authenticated') %}
                                <p class="text-muted">
                                    Welcome back! Manage your account information and explore personalized features.
                                </p>
                            {% else %}
                                <p class="text-muted">
                                    <a href="/login" class="text-decoration-none">Login</a> to access your account settings and order history.
                                </p>
                            {% endif %}
                        </div>

                        {% if session.get('user_authenticated') %}
                        <!-- Enhanced Quick Actions Dashboard for Logged-in Users -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="account-dashboard">
                                    <h5 class="mb-3">
                                        <i class="bi bi-speedometer2 text-primary me-2"></i>
                                        Personal Dashboard
                                    </h5>
                                    <div class="dashboard-actions">
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Show my recent orders')">
                                            <div class="action-icon">üì¶</div>
                                            <div class="action-text">
                                                <strong>Recent Orders</strong>
                                                <small>Track & manage</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('What are my account benefits?')">
                                            <div class="action-icon">‚≠ê</div>
                                            <div class="action-text">
                                                <strong>Account Benefits</strong>
                                                <small>Tier & rewards</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Recommend products for me')">
                                            <div class="action-icon">üõçÔ∏è</div>
                                            <div class="action-text">
                                                <strong>For You</strong>
                                                <small>Personalized picks</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Help with payments')">
                                            <div class="action-icon">üí≥</div>
                                            <div class="action-text">
                                                <strong>Payments</strong>
                                                <small>Methods & billing</small>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Account Actions -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Account Services</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="sendQuickMessage('Update my profile information')">
                                                <i class="bi bi-person-fill-gear me-2"></i>Update Profile Information
                                            </button>
                                            <button class="btn btn-outline-success" onclick="sendQuickMessage('Change my delivery address')">
                                                <i class="bi bi-geo-alt-fill me-2"></i>Update Delivery Address
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="sendQuickMessage('Check my account tier and benefits')">
                                                <i class="bi bi-star-fill me-2"></i>View Account Tier & Benefits
                                            </button>
                                            <button class="btn btn-outline-info" onclick="sendQuickMessage('Update my payment methods')">
                                                <i class="bi bi-credit-card-fill me-2"></i>Manage Payment Methods
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Benefits -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">Account Tiers & Benefits</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="tier-info">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-secondary">Bronze</span>
                                                <small>Standard benefits</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">Silver</span>
                                                <small>5% discount + priority support</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-warning">Gold</span>
                                                <small>10% discount + free delivery</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-info">Platinum</span>
                                                <small>15% discount + premium perks</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Support Tab -->
                <div class="tab-pane fade" id="contact" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-telephone-fill text-danger me-2"></i>
                                Contact raqibtech.com Support
                            </h4>
                            <p class="text-muted">
                                Multiple ways to reach our support team across Nigeria.
                            </p>
                        </div>

                        <div class="row">
                            <!-- Contact Methods -->
                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-telephone-fill text-success display-4 mb-3"></i>
                                        <h6>Phone Support</h6>
                                        <p class="text-muted small">Speak with our support team</p>
                                        <strong class="text-success">+234 (702) 5965-922 (72242)</strong>
                                        <p class="small mt-2">Daily 8AM - 8PM (WAT)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-envelope-fill text-primary display-4 mb-3"></i>
                                        <h6>Email Support</h6>
                                        <p class="text-muted small">Send us your questions</p>
                                        <strong class="text-primary">support@raqibtech.com</strong>
                                        <p class="small mt-2">Response within 24 hours</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-chat-heart-fill text-danger display-4 mb-3"></i>
                                        <h6>Live AI Chat</h6>
                                        <p class="text-muted small">Instant help available</p>
                                        <strong class="text-danger">Available 24/7</strong>
                                        <p class="small mt-2">
                                            <button class="btn btn-sm btn-outline-danger" onclick="openChatModal()">
                                                Start Chat Now
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nigerian Coverage -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-geo-alt-fill me-2"></i>
                                              Nationwide Coverage in Nigeria
                                        </h6>
                                        <p class="mb-0">
                                            We deliver to all 36 Nigerian states + FCT with dedicated support for your region.
                                            Payment options include Pay on Delivery, Bank Transfer, Card, and RaqibTechPay.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Chat Button -->
<button class="floating-chat-btn" id="floatingChatBtn">
    <i class="bi bi-chat-heart-fill"></i>
</button>

<!-- üîß DEBUG: Temporary test button to verify modal functionality -->
<!-- <div style="position: fixed; top: 10px; right: 10px; z-index: 10000;">
    <button class="btn btn-warning btn-sm" onclick="debugTestModal()" id="debugTestBtn">
        üîß Test Modal
    </button>
</div> -->

<!-- Chat Modal -->
<div class="chat-modal-overlay" id="chatModalOverlay" onclick="closeChatModal(event)">
    <div class="chat-modal" onclick="handleModalClick(event)">
        <!-- Modal Header -->
        <div class="chat-modal-header">
            <h6 class="chat-modal-title">
                <div class="brand-logo">üöÄ</div>
                <span>raqibtech.com Assistant</span>
            </h6>
            <div class="chat-modal-actions">
                <button class="chat-modal-btn" onclick="toggleConversationSidebar()" title="Chat History">
                    <i class="bi bi-clock-history"></i>
                </button>
                <button class="chat-modal-btn" onclick="createNewChat()" title="New Chat">
                    <i class="bi bi-plus-circle"></i>
                </button>
                <button class="chat-modal-btn" onclick="closeChatModal()" title="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- Conversation Sidebar -->
        <div class="conversation-sidebar" id="conversationSidebar">
            <div class="conversation-sidebar-header">
                <h6 class="conversation-sidebar-title">Chat History</h6>
                <button class="chat-modal-btn" onclick="toggleConversationSidebar()" title="Close History">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="conversation-list" id="chatHistoryList">
                {% for conv in conversations %}
                <div class="conversation-item" data-conversation-id="{{ conv.conversation_id }}"
                     onclick="switchToConversation('{{ conv.conversation_id }}')">
                    <div class="conversation-info">
                        <h6>{{ conv.conversation_title }}</h6>
                        <small>{{ conv.message_count }} messages</small>
                    </div>
                    <div class="conversation-actions">
                        <small class="text-muted">{{ conv.updated_at.strftime('%m/%d') }}</small>
                        <button class="btn btn-outline-danger btn-sm" onclick="customerPortal.deleteConversation('{{ conv.conversation_id }}', event)"
                                title="Delete conversation">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}

                {% if not conversations %}
                <div class="text-center text-muted p-3">
                    <i class="bi bi-chat-dots display-6 mb-2"></i>
                    <p class="mb-0 small">No chat history yet</p>
                    <small>Start a conversation!</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Messages Area -->
        <div class="chat-modal-messages" id="chatMessages">
            <div id="loadingIndicator" class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted small">Loading conversation...</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-modal-input">
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask me anything..."
                       onkeypress="handleChatKeyPress(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced raqibtech.com Branding Styles for Account Dashboard -->
<style>
.raqibtech-branding {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.brand-title {
    font-size: 28px;
    font-weight: 800;
    margin: 0;
}

.brand-logo {
    font-size: 32px;
    margin-right: 8px;
}

.brand-text {
    color: #ffd700;
    letter-spacing: 1px;
}

.brand-domain {
    color: #ffffff;
    font-weight: 600;
}

.brand-subtitle {
    font-size: 16px;
    margin-bottom: 16px;
    opacity: 0.9;
    font-weight: 500;
}

.brand-stats .badge {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
}

/* Account Dashboard Styles */
.account-dashboard {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid #dee2e6;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.dashboard-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.dashboard-action-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.dashboard-action-btn:hover {
    border-color: #18bc9c;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(24, 188, 156, 0.2);
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
}

.action-icon {
    font-size: 24px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 12px;
    flex-shrink: 0;
}

.action-text strong {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.action-text small {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

/* Responsive dashboard */
@media (max-width: 768px) {
    .dashboard-actions {
        grid-template-columns: 1fr;
    }

    .dashboard-action-btn {
        padding: 16px;
    }

    .action-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
}
</style>

<!-- Hidden data for JavaScript -->
<script>
window.currentConversationId = {% if current_conversation_id %}'{{ current_conversation_id }}'{% else %}null{% endif %};
window.userAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
</script>

<!-- Enhanced Customer Support JavaScript with Floating Modal Chat -->
<script>
// üîß DEBUG: Check for JavaScript errors and conflicts
console.log('üîç Modal Debug: Starting initialization...');

// Check for required dependencies
if (typeof bootstrap === 'undefined') {
    console.error('‚ùå Bootstrap JavaScript not loaded! Modal will not work.');
}

// Enhanced Customer-focused support system with floating modal interface
class CustomerSupportPortal {
    constructor() {
        console.log('üõçÔ∏è Initializing raqibtech.com Floating Modal Chat System...');

        // Debug: Check if elements exist
        this.debugElementExistence();

        this.currentConversationId = window.currentConversationId;
        this.userAuthenticated = window.userAuthenticated;
        this.isTyping = false;
        this.activeMessageRequest = null;
        this.conversationLocked = false;
        this.modalOpen = false;
        this.sidebarOpen = false;

        // Add delay to ensure DOM is fully ready
        setTimeout(() => {
            this.initializeFloatingChat();
            this.setupKeyboardShortcuts();
            console.log('‚úÖ Modal initialization complete');
        }, 100);
    }

    debugElementExistence() {
        const requiredElements = [
            'chatModalOverlay',
            'floatingChatBtn',
            'conversationSidebar',
            'chatMessages',
            'chatInput'
        ];

        console.log('üîç Checking required elements...');
        requiredElements.forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`‚ùå Missing element: ${id}`);
            } else {
                console.log(`‚úÖ Found element: ${id}`);
            }
        });
    }

    initializeFloatingChat() {
        // Initialize modal state with error checking
        this.chatModal = document.getElementById('chatModalOverlay');
        this.chatBtn = document.getElementById('floatingChatBtn');
        this.conversationSidebar = document.getElementById('conversationSidebar');

        if (!this.chatModal) {
            console.error('‚ùå Chat modal overlay not found!');
            return;
        }

        if (!this.chatBtn) {
            console.error('‚ùå Floating chat button not found!');
            return;
        }

        console.log('‚úÖ Modal elements found and initialized');

        // Ensure proper z-index (fix from WeWeb community issue)
        this.chatModal.style.zIndex = '9999';
        this.chatBtn.style.zIndex = '9998';

        // Load conversation when modal is opened
        this.setupModalEventListeners();

        // üîß FIX: Multiple event listeners for better compatibility
        // Remove any existing listeners first
        this.chatBtn.replaceWith(this.chatBtn.cloneNode(true));
        this.chatBtn = document.getElementById('floatingChatBtn');

        // Method 1: Click event listener
        this.chatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('üñ±Ô∏è Floating button clicked via addEventListener');
            this.toggleChatModal();
        });

        // Method 2: Mouse down/up for better mobile support
        this.chatBtn.addEventListener('mousedown', (e) => {
            console.log('üñ±Ô∏è Mouse down detected on floating button');
        });

        // Method 3: Touch events for mobile
        this.chatBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            console.log('üì± Touch start detected on floating button');
            this.toggleChatModal();
        }, { passive: false });

        // Method 4: Pointer events (modern approach)
        this.chatBtn.addEventListener('pointerdown', (e) => {
            console.log('üëÜ Pointer down detected on floating button');
        });

        console.log('‚úÖ Multiple event listeners attached to floating button');
    }

    setupKeyboardShortcuts() {
        // ESC to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.modalOpen) {
                console.log('‚å®Ô∏è ESC key pressed, closing modal');
                this.closeChatModal();
            }
        });
        console.log('‚úÖ Keyboard shortcuts configured');
    }

    setupModalEventListeners() {
        if (!this.chatModal) return;

        // Auto-focus input when modal opens
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class' && this.chatModal.classList.contains('active')) {
        setTimeout(() => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.focus();
                            console.log('‚úÖ Chat input focused');
                        }
                    }, 400); // Wait for animation
                }
            });
        });
        observer.observe(this.chatModal, { attributes: true });
        console.log('‚úÖ Modal event listeners configured');
    }

    toggleChatModal() {
        console.log(`üîÑ Toggle modal - Current state: ${this.modalOpen ? 'open' : 'closed'}`);
        if (this.modalOpen) {
            this.closeChatModal();
        } else {
            this.openChatModal();
        }
    }

    openChatModal() {
        console.log('üìÇ Opening chat modal...');

        if (!this.chatModal || !this.chatBtn) {
            console.error('‚ùå Cannot open modal - elements missing');
            return;
        }

        this.modalOpen = true;
        this.chatModal.classList.add('active');
        this.chatBtn.classList.add('active');
        this.chatBtn.innerHTML = '<i class="bi bi-x-lg"></i>';

        // Load current conversation if not already loaded
        if (!this.conversationLoaded) {
            this.loadCurrentConversation();
            this.conversationLoaded = true;
        }

        // Disable body scroll (fix from Frozen Modal guide)
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';

        console.log('‚úÖ Modal opened successfully');
    }

    closeChatModal(event) {
        // Don't close if clicking inside modal
        if (event && event.target.closest('.chat-modal')) {
            console.log('üñ±Ô∏è Click inside modal, not closing');
            return;
        }

        console.log('üìÅ Closing chat modal...');

        if (!this.chatModal || !this.chatBtn) {
            console.error('‚ùå Cannot close modal - elements missing');
            return;
        }

        this.modalOpen = false;
        this.chatModal.classList.remove('active');
        this.chatBtn.classList.remove('active');
        this.chatBtn.innerHTML = '<i class="bi bi-chat-heart-fill"></i>';

        // Close sidebar if open and reset modal state
        if (this.sidebarOpen) {
            this.sidebarOpen = false;
            this.conversationSidebar.classList.remove('active');
            const chatModal = document.querySelector('.chat-modal');
            if (chatModal) {
                chatModal.classList.remove('sidebar-open');
            }
        }

        // Re-enable body scroll (fix from WeWeb community)
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';

        // Force layout recalculation (fix from WeWeb community)
        document.body.offsetHeight;

        console.log('‚úÖ Modal closed successfully');
    }

    toggleConversationSidebar() {
        if (!this.conversationSidebar) {
            console.error('‚ùå Conversation sidebar not found');
            return;
        }

        this.sidebarOpen = !this.sidebarOpen;
        this.conversationSidebar.classList.toggle('active', this.sidebarOpen);

        // Add overlay effect to main modal when sidebar is open
        const chatModal = document.querySelector('.chat-modal');
        if (chatModal) {
            chatModal.classList.toggle('sidebar-open', this.sidebarOpen);
        }

        console.log(`üîÑ Sidebar ${this.sidebarOpen ? 'opened' : 'closed'}`);

        // Refresh conversation list when opening
        if (this.sidebarOpen) {
            this.refreshConversationList();
        }

        // Focus the close button when sidebar opens for better accessibility
        if (this.sidebarOpen) {
            setTimeout(() => {
                const closeBtn = this.conversationSidebar.querySelector('.chat-modal-btn');
                if (closeBtn) {
                    closeBtn.focus();
                }
            }, 300);
        }
    }

    async loadCurrentConversation() {
        if (!this.currentConversationId) {
            console.log('üí¨ No current conversation, showing welcome message');
            this.displayWelcomeMessage();
            return;
        }

        console.log(`üîÑ Loading conversation: ${this.currentConversationId}`);

        try {
            const response = await fetch(`/api/conversations/${this.currentConversationId}/messages`);
            const data = await response.json();

            if (this.currentConversationId !== window.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed during loading, aborting');
                return;
            }

            if (data.success && data.messages.length > 0) {
                this.displayConversationHistory(data.messages);
            } else {
                this.showWelcomeMessage();
            }
        } catch (error) {
            console.error('‚ùå Error loading conversation:', error);
            this.showWelcomeMessage();
        }
    }

    displayConversationHistory(messages) {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (!chatMessages) {
            console.error('‚ùå Chat messages container not found');
            return;
        }

        chatMessages.innerHTML = '';

        messages.forEach(message => {
            const senderType = message.sender_type === 'user' ? 'customer' : 'ai';
            this.addMessageToChatDisplay(message.content, senderType, false, message.metadata || {});
        });

        this.smoothScrollToBottom();
        console.log(`‚úÖ Loaded ${messages.length} messages for conversation ${this.currentConversationId}`);
    }

    showWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (!chatMessages) {
            console.error('‚ùå Chat messages container not found');
            return;
        }

        const welcomeMessage = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeMessage;
        this.smoothScrollToBottom();

        console.log('‚úÖ Welcome message displayed in modal');
    }

    createWelcomeMessage() {
        return `
            <div class="message ai welcome">
                <div class="message-avatar">
                    <div class="ai-avatar-icon">üöÄ</div>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="welcome-content">
                            ${this.userAuthenticated ?
                                this.createAuthenticatedWelcome() :
                                this.createGuestWelcome()
                            }
                                    </div>
                                </div>
                    <div class="message-meta">
                        <span class="welcome-timestamp">${new Date().toLocaleTimeString()}</span>
                        <span class="response-time">${this.userAuthenticated ?
                            "üåü Your Personal AI Assistant" :
                            "üéØ Ready to Help You Explore"
                        }</span>
                                    </div>
                                </div>
            </div>
        `;
    }

    createAuthenticatedWelcome() {
        return `
            <div class="welcome-header">
                <div class="welcome-brand">
                    <div class="brand-icon">üöÄ</div>
                    <div class="brand-text">
                        <h5 class="brand-title">raqibtech<span class="domain">.com</span></h5>
                        <p class="brand-subtitle">Your Personal AI Support Assistant</p>
                        </div>
                    </div>
                    </div>

            <div class="welcome-greeting">
                <h6 class="greeting-text">üåü Welcome back! Ready to supercharge your experience?</h6>
                <p class="greeting-subtitle">I'm your dedicated AI assistant, powered by advanced technology to make your shopping and support experience seamless! ‚ú®</p>
                </div>

            <div class="capabilities-grid">
                <div class="capability-card primary">
                    <div class="capability-icon">üì¶</div>
                    <div class="capability-content">
                        <h6>Order Management</h6>
                        <p>Track, modify, and manage all your orders with real-time updates</p>
                    </div>
                </div>
                <div class="capability-card secondary">
                    <div class="capability-icon">üõçÔ∏è</div>
                    <div class="capability-content">
                        <h6>Smart Shopping</h6>
                        <p>Get personalized recommendations and exclusive deals</p>
                    </div>
                </div>
                <div class="capability-card accent">
                    <div class="capability-icon">üí≥</div>
                    <div class="capability-content">
                        <h6>Payment & Billing</h6>
                        <p>Secure payment assistance and billing support</p>
                    </div>
                </div>
                <div class="capability-card success">
                    <div class="capability-icon">üöö</div>
                    <div class="capability-content">
                        <h6>Delivery Control</h6>
                        <p>Manage addresses, schedules, and delivery preferences</p>
                    </div>
                </div>
            </div>

            <div class="quick-actions-section">
                <h6 class="section-title">üéØ Popular Actions</h6>
                <div class="action-grid">
                    <button class="action-btn primary" onclick="customerPortal.sendCustomerMessage('Track my recent orders')">
                        <span class="action-icon">üì¶</span>
                        <span class="action-text">My Orders</span>
                    </button>
                    <button class="action-btn secondary" onclick="customerPortal.sendCustomerMessage('Show my account summary')">
                        <span class="action-icon">üë§</span>
                        <span class="action-text">Account Info</span>
                    </button>
                    <button class="action-btn accent" onclick="customerPortal.sendCustomerMessage('Browse your product catalog')">
                        <span class="action-icon">üè™</span>
                        <span class="action-text">Browse Store</span>
                    </button>
                    <button class="action-btn success" onclick="customerPortal.sendCustomerMessage('Show me trending electronics')">
                        <span class="action-icon">üì±</span>
                        <span class="action-text">Electronics</span>
                    </button>
                    <button class="action-btn warning" onclick="customerPortal.sendCustomerMessage('What are the latest deals and offers?')">
                        <span class="action-icon">üè∑Ô∏è</span>
                        <span class="action-text">Deals & Offers</span>
                    </button>
                    <button class="action-btn info" onclick="customerPortal.sendCustomerMessage('Contact customer support')">
                        <span class="action-icon">üí¨</span>
                        <span class="action-text">Support</span>
                    </button>
                </div>
            </div>

            <div class="welcome-footer">
                <div class="footer-stats">
                    <div class="stat-item">
                        <span class="stat-icon"> </span>
                        <span class="stat-text">Nationwide Delivery</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">‚ö°</span>
                        <span class="stat-text">Instant Support</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">üîí</span>
                        <span class="stat-text">Secure Platform</span>
                    </div>
                </div>
                <p class="footer-cta">üí¨ <strong>Ready to get started?</strong> Just type your question or tap any action above!</p>
            </div>
        `;
    }

    createGuestWelcome() {
        return `
            <div class="welcome-header">
                <div class="welcome-brand">
                    <div class="brand-icon">üöÄ</div>
                    <div class="brand-text">
                        <h5 class="brand-title">raqibtech<span class="domain">.com</span></h5>
                        <p class="brand-subtitle">Nigeria's Premier E-commerce Platform</p>
                    </div>
                </div>
            </div>

            <div class="welcome-greeting">
                <h6 class="greeting-text">üëã Welcome to the Future of Shopping!</h6>
                <p class="greeting-subtitle">I'm your AI shopping guide! Discover amazing products, unbeatable prices, and seamless delivery across Nigeria!  ‚ú®</p>
            </div>

            <div class="platform-showcase">
                <div class="showcase-card featured">
                    <div class="showcase-header">
                        <span class="showcase-icon">üè™</span>
                        <h6>Amazing Product Range</h6>
                    </div>
                    <div class="showcase-tags">
                        <span class="tag electronics">üì± Electronics</span>
                        <span class="tag fashion">üëó Fashion</span>
                        <span class="tag beauty">üíÑ Beauty</span>
                        <span class="tag computing">üíª Computing</span>
                        <span class="tag automotive">üöó Automotive</span>
                        <span class="tag books">üìö Books</span>
                    </div>
                </div>

                <div class="showcase-features">
                    <div class="feature-item">
                        <span class="feature-icon"> </span>
                        <span class="feature-text">All 36 States + FCT Delivery</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üí≥</span>
                        <span class="feature-text">Pay on Delivery Available</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">‚≠ê</span>
                        <span class="feature-text">Premium Account Tiers</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">üìû</span>
                        <span class="feature-text">24/7 AI + Human Support</span>
                    </div>
                </div>
            </div>

            <div class="quick-actions-section">
                <h6 class="section-title">üéØ Explore Our Platform</h6>
                <div class="action-grid">
                    <a href="/login" class="action-btn primary">
                        <span class="action-icon">üîê</span>
                        <span class="action-text">Login</span>
                    </a>
                    <button class="action-btn secondary" onclick="customerPortal.sendCustomerMessage('How do I create an account?')">
                        <span class="action-icon">üìù</span>
                        <span class="action-text">Sign Up</span>
                    </button>
                    <button class="action-btn accent" onclick="customerPortal.sendCustomerMessage('Browse your product catalog')">
                        <span class="action-icon">üè™</span>
                        <span class="action-text">Browse Store</span>
                    </button>
                    <button class="action-btn success" onclick="customerPortal.sendCustomerMessage('Show me trending electronics')">
                        <span class="action-icon">üì±</span>
                        <span class="action-text">Electronics</span>
                    </button>
                    <button class="action-btn warning" onclick="customerPortal.sendCustomerMessage('What are your delivery areas?')">
                        <span class="action-icon">üöö</span>
                        <span class="action-text">Delivery Info</span>
                    </button>
                    <button class="action-btn info" onclick="customerPortal.sendCustomerMessage('Contact customer support')">
                        <span class="action-icon">üí¨</span>
                        <span class="action-text">Support</span>
                    </button>
                </div>
            </div>

            <div class="welcome-footer">
                <div class="cta-section">
                    <div class="cta-highlight">
                        <span class="cta-icon">üéâ</span>
                        <span class="cta-text">Ready to start shopping? Create your account for personalized experiences!</span>
                    </div>
                </div>
                <p class="footer-cta">üí¨ <strong>Ask me anything!</strong> I'm here to help you discover our amazing platform!</p>
            </div>
        `;
    }

    async sendCustomerMessage(message = null) {
        if (this.isTyping || this.conversationLocked) {
            console.warn('‚ö†Ô∏è Message blocked: System is busy');
            return;
        }

        const chatInput = document.getElementById('chatInput');
        if (!chatInput) {
            console.error('‚ùå Chat input not found');
            return;
        }

        const userMessage = message || chatInput.value.trim();
        if (!userMessage) {
            console.warn('‚ö†Ô∏è Empty message, not sending');
            return;
        }

        console.log(`üì§ Sending message: ${userMessage.substring(0, 50)}...`);

        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
            this.removeTypingIndicator();
        }

        if (!message) chatInput.value = '';

        const requestConversationId = this.currentConversationId;
        this.addMessageToChatDisplay(userMessage, 'customer');
        this.isTyping = true;
        this.showTypingIndicator();

        try {
            const controller = new AbortController();
            this.activeMessageRequest = controller;

            const response = await fetch('/api/enhanced-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: userMessage
                }),
                signal: controller.signal
            });

            if (requestConversationId !== this.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed during request, ignoring response');
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (requestConversationId !== this.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed before response processing, ignoring');
                return;
            }

            this.isTyping = false;
            this.activeMessageRequest = null;
            this.removeTypingIndicator();

            if (data.success) {
                console.log('‚úÖ Message sent successfully');
                this.addCustomerResponseToChat(data);
                this.refreshConversationList();
            } else {
                this.addMessageToChatDisplay(data.message || 'Sorry, I encountered an issue. Please try again.', 'ai', true);
            }

        } catch (error) {
            if (error.name !== 'AbortError') {
                this.isTyping = false;
                this.activeMessageRequest = null;
                this.removeTypingIndicator();
                console.error('‚ùå Customer chat error:', error);

                if (requestConversationId === this.currentConversationId) {
                    this.addMessageToChatDisplay('I apologize, but I\'m experiencing technical difficulties. Please try again or contact our phone support at +234 (702) 5965-922.', 'ai', true);
                }
            }
        }
    }

    addMessageToChatDisplay(message, sender, isError = false, metadata = {}) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) {
            console.error('‚ùå Chat messages container not found');
            return;
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender === 'customer' ? 'customer' : 'ai'}`;

        if (isError) {
            messageDiv.classList.add('error');
        }

        const timestamp = new Date().toLocaleTimeString();
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = sender === 'customer' ? 'U' : 'AI';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';

        // üîß FIX: Properly format AI responses with line breaks
        if (sender === 'ai') {
            // Convert line breaks to HTML breaks and preserve formatting for AI responses
            const formattedMessage = message
                .replace(/\n/g, '<br>')
                .replace(/\r\n/g, '<br>')
                .replace(/\r/g, '<br>');
            messageBubble.innerHTML = formattedMessage;
        } else {
            // For customer messages, use as-is (user input should be escaped)
            messageBubble.textContent = message;
        }

        const messageMeta = document.createElement('div');
        messageMeta.className = 'message-meta';

        if (sender === 'customer') {
            messageMeta.innerHTML = `<span>${timestamp}</span>`;
        } else {
            const responseTime = metadata.execution_time || '';
            messageMeta.innerHTML = `
                <span>${timestamp}</span>
                ${responseTime ? `<span class="response-time">‚ö° ${responseTime}</span>` : ''}
            `;
        }

        messageContent.appendChild(messageBubble);
        messageContent.appendChild(messageMeta);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        chatMessages.appendChild(messageDiv);
        this.smoothScrollToBottom();
    }

    addCustomerResponseToChat(data) {
        this.addMessageToChatDisplay(data.response, 'ai', false, data);
        this.addSmartQuickActions(data);
    }

    addSmartQuickActions(data) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const quickActionDiv = document.createElement('div');
        quickActionDiv.className = 'smart-quick-actions-container';

        const quickActions = this.generateSmartQuickActions(data);

        quickActionDiv.innerHTML = `
            <div class="smart-quick-actions">
                <div class="quick-actions-header">
                    <span>üí° Quick Actions</span>
                </div>
                <div class="quick-actions-buttons">
                    ${quickActions.map(action => `
                        <button class="smart-quick-action-btn" onclick="${action.onclick}">
                            ${action.icon} ${action.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;

        chatMessages.appendChild(quickActionDiv);
        this.smoothScrollToBottom();
    }

    generateSmartQuickActions(data) {
        const actions = [];
        const queryType = data.query_type || 'general';

        if (this.userAuthenticated) {
            switch (queryType) {
                case 'order_analytics':
                    actions.push(
                        { icon: 'üì¶', text: 'Track Another Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: 'üìã', text: 'View Order History', onclick: `customerPortal.sendCustomerMessage('Show my order history')` },
                        { icon: 'üöö', text: 'Update Delivery Address', onclick: `customerPortal.sendCustomerMessage('Update my delivery address')` },
                        { icon: 'üí≥', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` }
                    );
                    break;
                case 'customer_analysis':
                    actions.push(
                        { icon: 'üë§', text: 'Update Profile', onclick: `customerPortal.sendCustomerMessage('Update my profile')` },
                        { icon: 'üîí', text: 'Account Security', onclick: `customerPortal.sendCustomerMessage('Account security settings')` },
                        { icon: '‚≠ê', text: 'Upgrade Account', onclick: `customerPortal.sendCustomerMessage('How to upgrade my account tier')` },
                        { icon: 'üíº', text: 'Account Benefits', onclick: `customerPortal.sendCustomerMessage('What are my account benefits')` }
                    );
                    break;
                case 'product_performance':
                    actions.push(
                        { icon: 'üè™', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: 'üì±', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: 'üëó', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: 'üíÑ', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` }
                    );
                    break;
                case 'revenue_insights':
                    actions.push(
                        { icon: 'üí≥', text: 'Payment Methods', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept')` },
                        { icon: 'üîÑ', text: 'Refund Request', onclick: `customerPortal.sendCustomerMessage('How to request a refund')` },
                        { icon: 'üìä', text: 'Spending History', onclick: `customerPortal.sendCustomerMessage('Show my spending history')` },
                        { icon: 'üí∞', text: 'Payment Issues', onclick: `customerPortal.sendCustomerMessage('Help with payment issues')` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: 'üõçÔ∏è', text: 'Browse Products', onclick: `customerPortal.sendCustomerMessage('What products do you recommend')` },
                        { icon: 'üì¶', text: 'Track Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: 'üí≥', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` },
                        { icon: 'üìû', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('Contact customer support')` }
                    );
            }
        } else {
            switch (queryType) {
                case 'product_performance':
                    actions.push(
                        { icon: 'üè™', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: 'üì±', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: 'üëó', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: 'üíÑ', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` },
                        { icon: 'üîê', text: 'Login for Personal Shop', onclick: `window.location.href='/login'` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: 'üîê', text: 'Login', onclick: `window.location.href='/login'` },
                        { icon: 'üìù', text: 'Create Account', onclick: `customerPortal.sendCustomerMessage('How do I create an account?')` },
                        { icon: 'üõçÔ∏è', text: 'Explore Products', onclick: `customerPortal.sendCustomerMessage('What products do you offer?')` },
                        { icon: 'üìç', text: 'Delivery Areas', onclick: `customerPortal.sendCustomerMessage('What areas do you deliver to?')` },
                        { icon: 'üí≥', text: 'Payment Options', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept?')` },
                        { icon: 'üìû', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('How to contact customer support')` }
                    );
            }
        }

        return actions;
    }

    showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        this.removeTypingIndicator();

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-avatar"></div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span style="color: #6c757d; font-size: 12px;">raqibtech.com Assistant is typing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        `;

        chatMessages.appendChild(typingDiv);
        this.smoothScrollToBottom();
    }

    removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    smoothScrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }
    }

    async refreshConversationList() {
        try {
            const response = await fetch('/api/conversations');
            const data = await response.json();

            if (data.success) {
                this.updateConversationList(data.conversations);
            }
        } catch (error) {
            console.error('‚ùå Error refreshing conversation list:', error);
        }
    }

    updateConversationList(conversations) {
        const listContainer = document.getElementById('chatHistoryList');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (conversations.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center text-muted p-3">
                    <i class="bi bi-chat-dots display-6 mb-2"></i>
                    <p class="mb-0 small">No chat history yet</p>
                    <small>Start a conversation!</small>
                </div>
            `;
            return;
        }

        conversations.forEach(conv => {
            const convElement = document.createElement('div');
            convElement.className = 'conversation-item';
            convElement.setAttribute('data-conversation-id', conv.conversation_id);

            convElement.innerHTML = `
                <div class="conversation-info" onclick="customerPortal.switchToConversation('${conv.conversation_id}')" style="flex: 1; cursor: pointer;">
                    <h6>${conv.title}</h6>
                    <small>${conv.message_count} messages</small>
                </div>
                <div class="conversation-actions">
                    <small class="text-muted">${new Date(conv.updated_at).toLocaleDateString()}</small>
                    <button class="btn btn-outline-danger btn-sm" onclick="customerPortal.deleteConversation('${conv.conversation_id}', event)"
                            title="Delete conversation">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;

            listContainer.appendChild(convElement);
        });
    }

    async deleteConversation(conversationId, event) {
        event.stopPropagation();

        if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/conversations/${conversationId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                console.log(`‚úÖ Deleted conversation ${conversationId}`);

                if (conversationId === this.currentConversationId) {
                    this.currentConversationId = null;
                    window.currentConversationId = null;
                    this.displayWelcomeMessage();
                }

                this.refreshConversationList();
            } else {
                alert('Failed to delete conversation. Please try again.');
            }
        } catch (error) {
            console.error('‚ùå Error deleting conversation:', error);
            alert('Error deleting conversation. Please try again.');
        }
    }

    async switchToConversation(conversationId) {
        if (this.conversationLocked || conversationId === this.currentConversationId) {
            return;
        }

        this.conversationLocked = true;

        try {
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.isTyping = false;
            this.removeTypingIndicator();

            console.log(`üîÑ Switching from conversation ${this.currentConversationId} to ${conversationId}`);

            this.currentConversationId = conversationId;
            window.currentConversationId = conversationId;

            const response = await fetch(`/api/conversations/${conversationId}/switch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                await this.loadConversationMessages(conversationId);

                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }

                console.log(`‚úÖ Successfully switched to conversation ${conversationId}`);
            }
        } catch (error) {
            console.error('‚ùå Error switching conversation:', error);
        } finally {
            setTimeout(() => {
                this.conversationLocked = false;
            }, 500);
        }
    }

    async loadConversationMessages(conversationId) {
        try {
            this.isTyping = false;
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.removeTypingIndicator();

            const response = await fetch(`/api/conversations/${conversationId}/messages`);
            const data = await response.json();

            if (conversationId !== this.currentConversationId) {
                console.warn('‚ö†Ô∏è Conversation changed during message loading');
                return;
            }

            if (data.success && data.messages) {
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                }

                data.messages.forEach(msg => {
                    const senderType = msg.sender_type === 'user' ? 'customer' : 'ai';
                    const metadata = msg.metadata || {};
                    this.addMessageToChatDisplay(msg.content, senderType, false, metadata);
                });

                console.log(`‚úÖ Loaded ${data.messages.length} messages for conversation ${conversationId}`);
            }
        } catch (error) {
            console.error('‚ùå Error loading conversation messages:', error);
        }
    }

    displayWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        this.isTyping = false;
        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
        }
        this.removeTypingIndicator();

        chatMessages.innerHTML = '';
        const welcomeHtml = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeHtml;
        this.smoothScrollToBottom();

        console.log('‚úÖ Welcome message displayed in modal');
    }
}

// Global functions for compatibility and modal control
function toggleChatModal() {
    console.log('üñ±Ô∏è Global toggleChatModal called');
    if (window.customerPortal) {
        window.customerPortal.toggleChatModal();
    } else {
        console.error('‚ùå CustomerPortal not initialized');
    }
}

function openChatModal() {
    console.log('üñ±Ô∏è Global openChatModal called');
    if (window.customerPortal) {
        window.customerPortal.openChatModal();
    } else {
        console.error('‚ùå CustomerPortal not initialized');
    }
}

function closeChatModal(event) {
    console.log('üñ±Ô∏è Global closeChatModal called');
    if (window.customerPortal) {
        window.customerPortal.closeChatModal(event);
    } else {
        console.error('‚ùå CustomerPortal not initialized');
    }
}

function toggleConversationSidebar() {
    console.log('üñ±Ô∏è Global toggleConversationSidebar called');
    if (window.customerPortal) {
        window.customerPortal.toggleConversationSidebar();
    } else {
        console.error('‚ùå CustomerPortal not initialized');
    }
}

function sendChatMessage() {
    console.log('üñ±Ô∏è Global sendChatMessage called');
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage();
    } else {
        console.error('‚ùå CustomerPortal not initialized');
    }
}

function sendQuickMessage(message) {
    console.log(`üñ±Ô∏è Global sendQuickMessage called: ${message}`);
    if (window.customerPortal) {
        // Open modal if not already open
        if (!window.customerPortal.modalOpen) {
            window.customerPortal.openChatModal();
        }
        // Wait for modal to open before sending message
        setTimeout(() => {
        window.customerPortal.sendCustomerMessage(message);
        }, 400);
    } else {
        console.error('‚ùå CustomerPortal not initialized');
    }
}

function trackOrderViaChat() {
    const orderIdInput = document.getElementById('orderIdInput');
    const orderId = orderIdInput?.value.trim();

    if (orderId) {
        sendQuickMessage(`Track my order ${orderId}`);
    } else {
        sendQuickMessage('Help me track my order');
    }
}

// üì¶ Enhanced Order Tracking Functions for Authenticated Users
async function loadMyOrders() {
    console.log('üîÑ Loading orders...');

    // Get authentication status from multiple sources with fallback
    const sessionAuth = {{ 'true' if session.get('user_authenticated') else 'false' }};
    const sessionCustomerId = {{ session.get('customer_id') or 'null' }};
    const sessionUsername = '{{ session.get('username', '') }}';

    // Check for existing JavaScript variables with different names to avoid conflicts
    const existingAuth = typeof window.isAuthenticated !== 'undefined' ? window.isAuthenticated : false;
    const existingCustomerId = typeof window.customerId !== 'undefined' ? window.customerId : null;
    const existingUsername = typeof window.username !== 'undefined' ? window.username : '';

    // Use session data as primary source with fallbacks
    const isAuthenticated = sessionAuth;
    const customerId = sessionCustomerId || existingCustomerId;
    const username = sessionUsername || existingUsername;

    console.log('üîê Enhanced Session Debug Info:', {
        sessionAuth: sessionAuth,
        sessionCustomerId: sessionCustomerId,
        sessionUsername: sessionUsername,
        existingAuth: existingAuth,
        existingCustomerId: existingCustomerId,
        existingUsername: existingUsername,
        finalAuth: isAuthenticated,
        finalCustomerId: customerId,
        finalUsername: username
    });

    // Get DOM elements first
    const loadingState = document.getElementById('orderLoadingState');
    const ordersContainer = document.getElementById('ordersListContainer');
    const noOrdersState = document.getElementById('noOrdersState');
    const refreshBtn = document.getElementById('refreshOrdersBtn');

    // Ensure refresh button is enabled and reset, regardless of authentication
    if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
        console.log('‚úÖ Refresh button reset to enabled state');
    } else {
        console.warn('‚ö†Ô∏è Refresh button not found in DOM');
    }

    // Check authentication
    if (!isAuthenticated) {
        console.error('‚ùå User not authenticated');
        showAlert('Please log in to view your orders. <a href="/login" class="alert-link">Click here to login</a>', 'warning');

        // Show login prompt instead of orders
        if (ordersContainer) {
            ordersContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">Authentication Required</h5>
                    <p class="text-muted">Please log in to view your order history</p>
                    <a href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Login to View Orders
                    </a>
                </div>
            `;
            ordersContainer.style.display = 'block';
        }
        if (loadingState) loadingState.style.display = 'none';
        if (noOrdersState) noOrdersState.style.display = 'none';
        return;
    }

    if (!customerId) {
        console.error('‚ùå Customer ID not found in session');
        showAlert('Session error: Customer ID missing. Please try logging in again. <a href="/login" class="alert-link">Login</a>', 'error');

        if (ordersContainer) {
            ordersContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">Session Issue</h5>
                    <p class="text-muted">Your session appears to be incomplete. Please log in again.</p>
                    <a href="/login" class="btn btn-warning">
                        <i class="bi bi-arrow-clockwise me-2"></i>Login Again
                    </a>
                </div>
            `;
            ordersContainer.style.display = 'block';
        }
        if (loadingState) loadingState.style.display = 'none';
        if (noOrdersState) noOrdersState.style.display = 'none';
        return;
    }

    // Show loading state and disable refresh button
    if (loadingState) {
        loadingState.style.display = 'block';
        console.log('‚úÖ Loading state shown');
    } else {
        console.warn('‚ö†Ô∏è Loading state element not found');
    }

    if (ordersContainer) {
        ordersContainer.style.display = 'none';
        console.log('‚úÖ Orders container hidden');
    } else {
        console.warn('‚ö†Ô∏è Orders container element not found');
    }

    if (noOrdersState) {
        noOrdersState.style.display = 'none';
        console.log('‚úÖ No orders state hidden');
    } else {
        console.warn('‚ö†Ô∏è No orders state element not found');
    }

    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Loading...';
    }

    try {
        console.log('üåê Making API call to fetch orders...');
        const response = await fetch('/api/orders/my-orders?limit=10', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        console.log('üì° API Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('üìä API Response data:', data);

        if (data.success && data.orders && data.orders.length > 0) {
            console.log(`‚úÖ Found ${data.orders.length} orders, displaying...`);
            displayOrdersList(data.orders);
        } else if (data.success && (!data.orders || data.orders.length === 0)) {
            console.log('‚ÑπÔ∏è No orders found for user');
            // Show no orders state
            if (loadingState) loadingState.style.display = 'none';
            if (noOrdersState) {
                noOrdersState.style.display = 'block';
                noOrdersState.innerHTML = `
                    <div class="empty-state text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">No Orders Found</h5>
                        <p class="text-muted">You haven't placed any orders yet. Start shopping to see your orders here!</p>
                        <button class="btn btn-primary" onclick="sendQuickMessage('Show me your product catalog')">
                            <i class="bi bi-shop me-2"></i>Browse Products
                        </button>
                    </div>
                `;
            }
            if (ordersContainer) ordersContainer.style.display = 'none';
        } else {
            throw new Error(data.message || data.error || 'Failed to load orders');
        }

    } catch (error) {
        console.error('‚ùå Error loading orders:', error);

        // Show detailed error in orders container
        if (ordersContainer) {
            ordersContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Error loading orders:</strong> ${error.message}
                    <br><small class="text-muted">Check browser console for more details</small>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-danger" onclick="loadMyOrders()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Retry Loading
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="window.location.reload()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Page
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-2" onclick="console.log('Debug info:', {isAuthenticated: ${isAuthenticated}, customerId: ${customerId}, currentURL: window.location.href, timestamp: new Date().toISOString(), error: '${error.message}'})">
                            <i class="bi bi-bug me-1"></i>Debug Info
                        </button>
                    </div>
                </div>
            `;
            ordersContainer.style.display = 'block';
        }

        if (loadingState) loadingState.style.display = 'none';
        if (noOrdersState) noOrdersState.style.display = 'none';

        // Show user-friendly error message
        showAlert(`Unable to load orders: ${error.message}`, 'error');
    } finally {
        // Always ensure refresh button is re-enabled
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
            console.log('‚úÖ Refresh button re-enabled in finally block');
        }
        console.log('üîÑ Order loading process completed');
    }
}

function displayOrdersList(orders) {
    console.log('üìã Displaying orders list:', orders);

    const ordersContainer = document.getElementById('ordersListContainer');
    const loadingState = document.getElementById('orderLoadingState');
    const noOrdersState = document.getElementById('noOrdersState');

    if (!ordersContainer) {
        console.error('‚ùå Orders container not found!');
        return;
    }

    console.log('‚úÖ Orders container found:', ordersContainer);

    // Hide loading and no orders states
    if (loadingState) {
        loadingState.style.display = 'none';
        console.log('‚úÖ Loading state hidden');
    }
    if (noOrdersState) {
        noOrdersState.style.display = 'none';
        console.log('‚úÖ No orders state hidden');
    }

    // Generate orders HTML
    const ordersHtml = orders.map(order => {
        console.log('üîç Processing order:', order);

        const statusBadgeClass = getOrderStatusBadgeClass(order.status);

        // Handle order date properly - fix date parsing
        let orderPlacedDate = 'Unknown Date';
        let expectedDeliveryDate = 'Not specified';

        // üîß FIX: Use created_at for order placement date
        if (order.created_at) {
            try {
                const date = new Date(order.created_at);
                if (!isNaN(date.getTime())) {
                    orderPlacedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (e) {
                console.warn('Created date parsing error:', e);
                orderPlacedDate = order.created_at ? order.created_at.toString() : 'Unknown Date';
            }
        }

        // üîß FIX: Use order_date (delivery_date) for expected delivery
        if (order.order_date) {
            try {
                const date = new Date(order.order_date);
                if (!isNaN(date.getTime())) {
                    expectedDeliveryDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            } catch (e) {
                console.warn('Delivery date parsing error:', e);
                expectedDeliveryDate = order.order_date ? order.order_date.toString() : 'Not specified';
            }
        }

        // Format products list with better handling
        let productsText = 'No products found';
        let productCount = 0;

        if (order.products && Array.isArray(order.products) && order.products.length > 0) {
            productCount = order.products.length;
            const firstProduct = order.products[0];

            if (productCount === 1) {
                productsText = firstProduct.product_name || 'Unknown Product';
            } else {
                productsText = `${firstProduct.product_name || 'Unknown Product'} +${productCount - 1} more`;
            }
        } else if (order.items_count && order.items_count > 0) {
            productsText = `${order.items_count} item${order.items_count > 1 ? 's' : ''}`;
            productCount = order.items_count;
        }

        return `
            <div class="order-card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1">üì¶ Order #${order.order_id}</h6>
                            <small class="text-muted">${orderPlacedDate}</small>
                        </div>
                        <div class="col-md-3">
                            <span class="badge ${statusBadgeClass}">${order.status || 'Pending'}</span>
                            <div class="mt-1">
                                <small class="text-muted">${productCount} item${productCount !== 1 ? 's' : ''}</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="products-section">
                                <small class="text-muted d-block">Products:</small>
                                <span class="fw-medium">${productsText}</span>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <strong class="text-success">‚Ç¶${parseFloat(order.total_amount || 0).toLocaleString()}</strong>
                        </div>
                        <div class="col-md-1">
                            <div class="btn-group-vertical" role="group">
                                <button class="btn btn-sm btn-primary"
                                        onclick="viewOrderDetails('${order.order_id}')"
                                        title="View complete order details and tracking information">
                                    <i class="bi bi-eye me-1"></i>Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    console.log('üìù Generated orders HTML length:', ordersHtml.length);

    // Display orders or empty state
    if (orders.length === 0) {
        console.log('üìã No orders to display, showing empty state');
        ordersContainer.innerHTML = `
            <div class="empty-state text-center py-5">
                <i class="bi bi-inbox text-muted"></i>
                <h5 class="mt-3 text-muted">No Orders Found</h5>
                <p class="text-muted">You haven't placed any orders yet. Start shopping to see your orders here!</p>
                <button class="btn btn-primary" onclick="sendQuickMessage('Show me your product catalog')">
                    <i class="bi bi-shop me-2"></i>Browse Products
                </button>
            </div>
        `;
    } else {
        console.log(`üìã Setting orders HTML for ${orders.length} orders`);
        ordersContainer.innerHTML = ordersHtml;
    }

    // **CRITICAL**: Ensure the orders container is visible
    ordersContainer.style.display = 'block';
    console.log('‚úÖ Orders container made visible:', ordersContainer.style.display);

    // Additional debugging
    console.log('üìã Orders container final state:', {
        innerHTML: ordersContainer.innerHTML.length + ' characters',
        display: ordersContainer.style.display,
        visible: ordersContainer.offsetHeight > 0,
        childCount: ordersContainer.children.length
    });
}

function getOrderStatusBadgeClass(status) {
    switch (status?.toLowerCase()) {
        case 'pending': return 'bg-warning text-dark';
        case 'processing': return 'bg-info';
        case 'delivered': return 'bg-success';
        case 'returned': return 'bg-secondary';
        case 'cancelled': return 'bg-danger';
        default: return 'bg-light text-dark';
    }
}

function trackSpecificOrder() {
    const orderIdInput = document.getElementById('orderIdInput');
    const orderId = orderIdInput?.value.trim();

    if (!orderId) {
        showAlert('Please enter an order ID', 'warning');
        return;
    }

    // Use the consolidated viewOrderDetails function instead
    viewOrderDetails(orderId);
}

async function viewOrderDetails(orderId) {
    console.log(`üëÅÔ∏è Viewing details for order: ${orderId}`);

    try {
        // Get or create modal instance (prevent duplicate instances)
        const modalElement = document.getElementById('orderTrackingModal');
        if (!modalElement) {
            console.error('‚ùå Modal element not found');
            showAlert('Modal not found. Please refresh the page.', 'error');
            return;
        }

        // Clean up any existing modal instance to prevent conflicts
        const existingModalInstance = bootstrap.Modal.getInstance(modalElement);
        if (existingModalInstance) {
            console.log('üßπ Cleaning up existing modal instance');
            existingModalInstance.dispose();
        }

        // Create fresh modal instance
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });

        const modalBody = document.querySelector('#orderTrackingModal .modal-body');

        if (!modalBody) {
            console.error('‚ùå Modal body not found');
            showAlert('Modal structure incomplete. Please refresh the page.', 'error');
            return;
        }

        // Add cleanup listener to prevent memory leaks
        modalElement.addEventListener('hidden.bs.modal', function cleanupModalHandler(event) {
            console.log('üßπ Modal closed - performing cleanup');

            // Remove this event listener to prevent accumulation
            modalElement.removeEventListener('hidden.bs.modal', cleanupModalHandler);

            // Clear any pending timeouts or intervals
            if (window.modalRefreshTimeout) {
                clearTimeout(window.modalRefreshTimeout);
                window.modalRefreshTimeout = null;
            }

            // Reset modal content to prevent stale data
            if (modalBody) {
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-muted">Modal closed. Click Details to reopen.</p>
                    </div>
                `;
            }

            console.log('‚úÖ Modal cleanup complete');
        }, { once: true }); // Ensure it only runs once

        modalBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading order details...</span>
                </div>
                <p class="mt-2 text-muted">Loading comprehensive order details...</p>
            </div>
        `;

        modal.show();

        // Fetch order details with timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

        try {
            const response = await fetch(`/api/orders/status/${orderId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`Failed to fetch order details (${response.status})`);
            }

            const data = await response.json();

            if (data.success && data.order) {
                console.log('‚úÖ Order details loaded successfully');
                displayEnhancedOrderModal(data.order);
            } else {
                throw new Error(data.message || data.error || 'Order details not available');
            }

        } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
                throw new Error('Request timed out. Please try again.');
            }
            throw fetchError;
        }

    } catch (error) {
        console.error('‚ùå Error loading order details:', error);

        // Show user-friendly error without exposing SQL details
        const errorMessage = error.message.includes('SQL') || error.message.includes('database')
            ? 'Unable to load order details. Please try again or contact support.'
            : error.message;

        showOrderErrorModal(orderId, errorMessage);
    }
}

function displayEnhancedOrderModal(order) {
    console.log('üìã Displaying enhanced order modal:', order);

    const modalBody = document.querySelector('#orderTrackingModal .modal-body');
    const modalTitle = document.querySelector('#orderTrackingModal .modal-title');

    // Set modal title
    modalTitle.innerHTML = `
        <i class="bi bi-box-seam me-2"></i>
        Order #${order.order_id} - Complete Details
    `;

    // üîß FIX: Use created_at for order placement date
    let orderPlacedDate = 'Unknown Date';
    let expectedDeliveryDate = 'Not specified';

    if (order.created_at) {
        try {
            const date = new Date(order.created_at);
            if (!isNaN(date.getTime())) {
                orderPlacedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        } catch (e) {
            console.warn('Created date parsing error:', e);
            orderPlacedDate = 'Unknown Date';
        }
    }

    // üîß FIX: Use delivery_date for expected delivery
    if (order.delivery_date || order.order_date) {
        try {
            const date = new Date(order.delivery_date || order.order_date);
            if (!isNaN(date.getTime())) {
                expectedDeliveryDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        } catch (e) {
            console.warn('Delivery date parsing error:', e);
        }
    }

    // Generate status badge
    const statusBadgeClass = getOrderStatusBadgeClass(order.status);
    const statusIcon = getOrderStatusIcon(order.status);

    // Generate products list
    let productsHtml = '';
    if (order.products && order.products.length > 0) {
        productsHtml = `
            <div class="mb-4">
                <h6><i class="bi bi-box me-2"></i>Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Brand</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.products.map(product => `
                                <tr>
                                    <td class="fw-medium">${product.product_name || 'Unknown Product'}</td>
                                    <td><span class="badge bg-secondary">${product.category || 'N/A'}</span></td>
                                    <td>${product.brand || 'N/A'}</td>
                                    <td class="text-success fw-bold">‚Ç¶${parseFloat(product.price || 0).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    } else {
        productsHtml = `
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                Product details not available for this order.
            </div>
        `;
    }

    // Generate tracking timeline
    const trackingTimeline = generateTrackingTimeline(order.status, orderPlacedDate);

    // Generate delivery information
    const deliveryInfo = generateDeliveryInfo(order);

    modalBody.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-info-circle text-primary me-2"></i>Order Status
                        </h6>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge ${statusBadgeClass} me-2">${statusIcon} ${order.status || 'Pending'}</span>
                        </div>
                        <small class="text-muted">Order placed on ${orderPlacedDate}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-currency-exchange text-success me-2"></i>Payment & Total
                        </h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-success">‚Ç¶${parseFloat(order.total_amount || 0).toLocaleString()}</span>
                            <span class="badge bg-info">${order.payment_method || 'Not specified'}</span>
                        </div>
                        ${expectedDeliveryDate !== 'Not specified' ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-truck me-1"></i>Expected delivery: ${expectedDeliveryDate}
                            </small>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>

        ${productsHtml}

        <div class="mb-4">
            <h6><i class="bi bi-truck me-2"></i>Order Tracking Timeline</h6>
            ${generateTrackingTimeline(order.status, orderPlacedDate)}
        </div>

        ${deliveryInfo}

        <div class="d-flex gap-2 mt-4">
            <button class="btn btn-outline-primary btn-sm" onclick="refreshOrderDetails('${order.order_id}')">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh Status
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="contactSupportAboutOrder('${order.order_id}')">
                <i class="bi bi-headset me-1"></i>Contact Support
            </button>
            ${order.status === 'Pending' ? `
                <button class="btn btn-outline-danger btn-sm" onclick="requestOrderCancellation('${order.order_id}')">
                    <i class="bi bi-x-circle me-1"></i>Request Cancellation
                </button>
            ` : ''}
        </div>
    `;
}

function getOrderStatusIcon(status) {
    switch (status?.toLowerCase()) {
        case 'pending': return '‚è≥';
        case 'processing': return 'üîÑ';
        case 'shipped': return 'üöö';
        case 'delivered': return '‚úÖ';
        case 'returned': return '‚Ü©Ô∏è';
        case 'cancelled': return '‚ùå';
        default: return 'üì¶';
    }
}

function generateTrackingTimeline(currentStatus, orderDate) {
    const statuses = [
        { status: 'Pending', icon: '‚è≥', description: 'Order received and being prepared' },
        { status: 'Processing', icon: 'üîÑ', description: 'Order is being processed for shipment' },
        { status: 'Shipped', icon: 'üöö', description: 'Order has been shipped and is on the way' },
        { status: 'Delivered', icon: '‚úÖ', description: 'Order has been delivered successfully' }
    ];

    const currentIndex = statuses.findIndex(s => s.status.toLowerCase() === currentStatus?.toLowerCase());

    return `
        <div class="tracking-timeline">
            ${statuses.map((statusInfo, index) => {
                const isCompleted = index <= currentIndex;
                const isCurrent = index === currentIndex;

                return `
                    <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
                        <div class="timeline-marker">
                            <span class="timeline-icon">${statusInfo.icon}</span>
                        </div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">${statusInfo.status}</h6>
                            <p class="timeline-description">${statusInfo.description}</p>
                            ${isCurrent ? `<small class="text-muted">Current status as of ${orderDate}</small>` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function generateDeliveryInfo(order) {
    if (!order.delivery_address && !order.state) {
        return '';
    }

    return `
        <div class="mb-4">
            <h6><i class="bi bi-geo-alt me-2"></i>Delivery Information</h6>
            <div class="card border-0 bg-light">
                <div class="card-body">
                    ${order.delivery_address ? `
                        <p class="mb-2">
                            <strong>Address:</strong><br>
                            ${order.delivery_address}
                        </p>
                    ` : ''}
                    ${order.state ? `
                        <p class="mb-2">
                            <strong>State:</strong> ${order.state}
                            ${order.lga ? ` - ${order.lga}` : ''}
                        </p>
                    ` : ''}
                    ${order.order_date ? `
                        <p class="mb-0">
                            <strong>Expected Delivery:</strong>
                            <span class="text-primary">${order.order_date}</span>
                        </p>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function showOrderErrorModal(orderId, errorMessage) {
    const modalBody = document.querySelector('#orderTrackingModal .modal-body');
    const modalTitle = document.querySelector('#orderTrackingModal .modal-title');

    if (!modalBody || !modalTitle) {
        console.error('‚ùå Modal elements not found for error display');
        showAlert(`Error loading order #${orderId}: ${errorMessage}`, 'error');
        return;
    }

    modalTitle.innerHTML = `
        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
        Order #${orderId} - Unable to Load
    `;

    modalBody.innerHTML = `
        <div class="text-center py-5">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <h5 class="mt-3 text-muted">Unable to Load Order Details</h5>
            <p class="text-muted">${errorMessage}</p>

            <div class="mt-4">
                <button class="btn btn-primary me-2" onclick="viewOrderDetails('${orderId}')">
                    <i class="bi bi-arrow-clockwise me-1"></i>Try Again
                </button>
                <button class="btn btn-outline-secondary" onclick="contactSupportAboutOrder('${orderId}')">
                    <i class="bi bi-headset me-1"></i>Contact Support
                </button>
            </div>
        </div>
    `;
}

// Helper functions for order actions
async function refreshOrderDetails(orderId) {
    console.log(`üîÑ Refreshing order details for: ${orderId}`);

    try {
        // Clear any existing timeout to prevent conflicts
        if (window.modalRefreshTimeout) {
            clearTimeout(window.modalRefreshTimeout);
            window.modalRefreshTimeout = null;
        }

        // Show loading state in the modal body
        const modalBody = document.querySelector('#orderTrackingModal .modal-body');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Refreshing order details...</span>
                    </div>
                    <p class="mt-2 text-muted">Refreshing order information...</p>
                </div>
            `;

            // Set a timeout to prevent infinite loading
            window.modalRefreshTimeout = setTimeout(() => {
                console.log('‚è∞ Refresh timeout reached');
                if (modalBody) {
                    modalBody.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                            <h6 class="mt-3">Refresh Timeout</h6>
                            <p class="text-muted">The refresh is taking longer than expected.</p>
                            <button class="btn btn-primary btn-sm" onclick="viewOrderDetails('${orderId}')">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }, 15000); // 15 second timeout

            // Use the fetch with AbortController from viewOrderDetails
            const controller = new AbortController();
            const fetchTimeoutId = setTimeout(() => controller.abort(), 10000);

            try {
                const response = await fetch(`/api/orders/status/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(fetchTimeoutId);
                clearTimeout(window.modalRefreshTimeout);
                window.modalRefreshTimeout = null;

                if (!response.ok) {
                    throw new Error(`Failed to refresh order details (${response.status})`);
                }

                const data = await response.json();

                if (data.success && data.order) {
                    console.log('‚úÖ Order details refreshed successfully');
                    displayEnhancedOrderModal(data.order);
                } else {
                    throw new Error(data.message || data.error || 'Order details not available');
                }

            } catch (fetchError) {
                clearTimeout(fetchTimeoutId);
                clearTimeout(window.modalRefreshTimeout);
                window.modalRefreshTimeout = null;

                if (fetchError.name === 'AbortError') {
                    throw new Error('Refresh timed out. Please try again.');
                }
                throw fetchError;
            }

        } else {
            // Fallback: Just refresh normally if modal body not found
            await viewOrderDetails(orderId);
        }
    } catch (error) {
        console.error('‚ùå Error refreshing order details:', error);

        // Clear any pending timeouts
        if (window.modalRefreshTimeout) {
            clearTimeout(window.modalRefreshTimeout);
            window.modalRefreshTimeout = null;
        }

        const errorMessage = error.message.includes('SQL') || error.message.includes('database')
            ? 'Unable to refresh order details. Please contact support.'
            : error.message;

        showAlert(`Refresh failed: ${errorMessage}`, 'error');

        // Show error in modal
        const modalBody = document.querySelector('#orderTrackingModal .modal-body');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <h6 class="mt-3">Refresh Failed</h6>
                    <p class="text-muted">${errorMessage}</p>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm me-2" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-arrow-clockwise me-1"></i>Try Again
                        </button>
                        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                            <i class="bi bi-x me-1"></i>Close
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

function contactSupportAboutOrder(orderId) {
    console.log(`üìû Contacting support about order: ${orderId}`);
    sendQuickMessage(`I need help with my order #${orderId}. Can you provide me with the current status and any updates?`);
}

async function requestOrderCancellation(orderId) {
    console.log(`‚ùå Requesting cancellation for order: ${orderId}`);

    const confirmed = confirm(`Are you sure you want to request cancellation for order #${orderId}? This action cannot be undone.`);

    if (confirmed) {
        try {
            const response = await fetch(`/api/orders/cancel/${orderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason: 'Customer requested cancellation via order details'
                })
            });

            const data = await response.json();

            if (data.success) {
                showAlert('Cancellation request submitted successfully', 'success');
                // Refresh the order details
                setTimeout(() => {
                    viewOrderDetails(orderId);
                }, 1000);
            } else {
                throw new Error(data.message || 'Failed to submit cancellation request');
            }

        } catch (error) {
            console.error('‚ùå Error requesting cancellation:', error);
            const errorMessage = error.message.includes('SQL') || error.message.includes('database')
                ? 'Unable to process cancellation request. Please contact support.'
                : error.message;
            showAlert(`Error: ${errorMessage}`, 'error');
        }
    }
}

function cancelOrderPrompt(orderId) {
    const confirmCancel = confirm(`Are you sure you want to cancel order #${orderId}?`);
    if (confirmCancel) {
        cancelOrderById(orderId);
    }
}

async function cancelOrderById(orderId) {
    console.log(`‚ùå Cancelling order: ${orderId}`);

    try {
        const response = await fetch(`/api/orders/cancel/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                reason: 'Customer requested cancellation'
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Order cancelled successfully', 'success');
            // Refresh orders list
            setTimeout(() => loadMyOrders(), 1000);
        } else {
            throw new Error(data.message || 'Failed to cancel order');
        }

    } catch (error) {
        console.error('‚ùå Error cancelling order:', error);
        showAlert(`Error cancelling order: ${error.message}`, 'danger');
    }
}

function showAlert(message, type = 'info') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    // Find a container to show the alert
    const container = document.getElementById('ordersListContainer') || document.querySelector('.tab-content');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);

        // Auto-remove alert after 5 seconds
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendChatMessage();
    }
}

// Add missing handleModalClick function to prevent errors
function handleModalClick(event) {
    // Prevent event propagation to avoid closing modal when clicking inside
    event.stopPropagation();
    console.log('üñ±Ô∏è Modal content clicked - preventing close');
}

async function createNewChat() {
    console.log('üÜï Creating new chat...');
    try {
        const response = await fetch('/api/conversations/new', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            console.log(`‚úÖ New chat created: ${data.conversation_id}`);
            if (window.customerPortal) {
                await window.customerPortal.switchToConversation(data.conversation_id);
                await window.customerPortal.refreshConversationList();
            }
        }
    } catch (error) {
        console.error('‚ùå Error creating new chat:', error);
    }
}

async function switchToConversation(conversationId) {
    console.log(`üîÑ Global switchToConversation called: ${conversationId}`);
    if (window.customerPortal) {
        await window.customerPortal.switchToConversation(conversationId);
    } else {
        console.error('‚ùå CustomerPortal not initialized');
    }
}

// Initialize floating modal chat portal when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, initializing raqibtech.com Floating Modal Chat System');

    // Add small delay to ensure all elements are ready
    setTimeout(() => {
        try {
            window.customerPortal = new CustomerSupportPortal();

            const isAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
            const currentConversationId = '{{ current_conversation_id if current_conversation_id else '' }}';

            console.log(`üîç Auth: ${isAuthenticated}, ConvID: ${currentConversationId}`);
            console.log('‚úÖ Floating modal chat system ready!');

            // üîß Enhanced refresh button setup
            if (isAuthenticated) {
                console.log('üë§ User authenticated - setting up refresh button enhancements');
                setupRefreshButtonEnhancements();

                // Test button after setup
                setTimeout(() => {
                    testRefreshButton();
                }, 500);
            }

            // üîß DEBUG: Add click test for floating button
            const floatingBtn = document.getElementById('floatingChatBtn');
            if (floatingBtn) {
                console.log('‚úÖ Floating button found and ready');

                // Test button interactivity
                floatingBtn.addEventListener('mouseenter', () => {
                    console.log('üñ±Ô∏è Mouse entered floating button');
                });

                floatingBtn.addEventListener('mouseleave', () => {
                    console.log('üñ±Ô∏è Mouse left floating button');
                });
            } else {
                console.error('‚ùå Floating button not found!');
            }

        } catch (error) {
            console.error('‚ùå Error initializing chat system:', error);
        }
    }, 200);

    // Additional setup for refresh button after longer delay
    setTimeout(() => {
        const refreshBtn = document.getElementById('refreshOrdersBtn');
        if (refreshBtn) {
            console.log('üîß Final refresh button check and setup');
            resetRefreshButton();
        }
    }, 1000);
});

console.log('‚úÖ Modal system loaded and ready');

// Global debugging functions for console access
window.debugRefreshButton = function() {
    console.log('üêõ === REFRESH BUTTON DEBUG INFO ===');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    console.log('Button element:', refreshBtn);

    if (refreshBtn) {
        console.log('Button properties:', {
            id: refreshBtn.id,
            disabled: refreshBtn.disabled,
            innerHTML: refreshBtn.innerHTML,
            style: refreshBtn.style.cssText,
            onclick: refreshBtn.onclick,
            eventListeners: refreshBtn.cloneNode().outerHTML
        });

        console.log('Parent elements:', {
            parent: refreshBtn.parentElement,
            parentVisible: refreshBtn.parentElement ? window.getComputedStyle(refreshBtn.parentElement).display : 'N/A'
        });
    }

    // Test authentication variables
    const sessionAuth = {{ 'true' if session.get('user_authenticated') else 'false' }};
    const sessionCustomerId = {{ session.get('customer_id') or 'null' }};

    console.log('Authentication status:', {
        sessionAuth: sessionAuth,
        sessionCustomerId: sessionCustomerId,
        jsAuth: typeof isAuthenticated !== 'undefined' ? isAuthenticated : 'undefined',
        jsCustomerId: typeof customerId !== 'undefined' ? customerId : 'undefined'
    });

    console.log('üêõ === END DEBUG INFO ===');
    return refreshBtn;
};

window.fixRefreshButton = function() {
    console.log('üîß === FIXING REFRESH BUTTON ===');

    const result = resetRefreshButton();
    if (result) {
        console.log('‚úÖ Refresh button fixed successfully');
        // Test the fix
        setTimeout(() => {
            testRefreshButton();
        }, 100);
    } else {
        console.log('‚ùå Failed to fix refresh button');
    }

    return result;
};

window.testRefresh = function() {
    console.log('üß™ === TESTING REFRESH FUNCTIONALITY ===');

    // Test the button
    const buttonTest = testRefreshButton();

    // Test the function directly
    console.log('üß™ Testing loadMyOrders function directly...');
    try {
        loadMyOrders();
        console.log('‚úÖ loadMyOrders called successfully');
    } catch (error) {
        console.error('‚ùå loadMyOrders failed:', error);
    }

    return buttonTest;
};

console.log('üêõ Debug functions available: debugRefreshButton(), fixRefreshButton(), testRefresh()');

// Enhanced refresh button responsiveness and debugging
function testRefreshButton() {
    console.log('üß™ Testing refresh button responsiveness...');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    if (!refreshBtn) {
        console.error('‚ùå Refresh button not found!');
        return false;
    }

    console.log('‚úÖ Refresh button found:', {
        id: refreshBtn.id,
        disabled: refreshBtn.disabled,
        innerHTML: refreshBtn.innerHTML,
        onclick: refreshBtn.onclick,
        eventListeners: refreshBtn.hasAttribute('onclick')
    });

    // Test click simulation
    try {
        refreshBtn.click();
        console.log('‚úÖ Button click simulation successful');
        return true;
    } catch (error) {
        console.error('‚ùå Button click simulation failed:', error);
        return false;
    }
}

// Enhanced button event handling to prevent issues
function setupRefreshButtonEnhancements() {
    console.log('üîß Setting up refresh button enhancements...');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    if (!refreshBtn) {
        console.warn('‚ö†Ô∏è Refresh button not found during setup');
        return;
    }

    // Remove any existing event listeners and add a robust one
    refreshBtn.removeAttribute('onclick');

    // Add enhanced click handler with debouncing
    let isLoading = false;
    refreshBtn.addEventListener('click', async function(event) {
        event.preventDefault();
        event.stopPropagation();

        console.log('üñ±Ô∏è Refresh button clicked');

        // Prevent multiple simultaneous calls
        if (isLoading) {
            console.log('‚ö†Ô∏è Already loading, ignoring click');
            return;
        }

        isLoading = true;

        try {
            await loadMyOrders();
        } catch (error) {
            console.error('‚ùå Error in refresh button handler:', error);
        } finally {
            isLoading = false;
        }
    });

    // Add visual feedback
    refreshBtn.addEventListener('mousedown', function() {
        this.style.transform = 'scale(0.95)';
    });

    refreshBtn.addEventListener('mouseup', function() {
        this.style.transform = 'scale(1)';
    });

    refreshBtn.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });

    console.log('‚úÖ Refresh button enhancements applied');
}

// Function to reset refresh button if it gets stuck
function resetRefreshButton() {
    console.log('üîÑ Resetting refresh button...');

    const refreshBtn = document.getElementById('refreshOrdersBtn');
    if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
        refreshBtn.style.transform = 'scale(1)';
        console.log('‚úÖ Refresh button reset successfully');

        // Re-setup enhancements
        setupRefreshButtonEnhancements();

        return true;
    } else {
        console.error('‚ùå Refresh button not found for reset');
        return false;
    }
}

// New Shopping & Checkout Functions
async function quickOrderProduct() {
    const productQuery = document.getElementById('quickShopInput').value.trim();
    const quantity = parseInt(document.getElementById('quickShopQuantity').value) || 1;
    const deliveryState = document.getElementById('quickShopState').value;

    if (!productQuery) {
        showAlert('Please describe what you want to order', 'warning');
        return;
    }

    try {
        showAlert('Searching for products...', 'info');

        // First, ask AI to find the product
        const response = await fetch('/api/enhanced-query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: `I want to order ${productQuery}, quantity ${quantity}, delivery to ${deliveryState}. Please help me place this order.`
            })
        });

        const data = await response.json();

        if (data.success && data.shopping_result) {
            // Show checkout modal with product details
            showCheckoutModal(data.shopping_result, quantity, deliveryState);
        } else {
            showAlert('Product not found or out of stock. Try asking our AI assistant for alternatives.', 'warning');
        }
    } catch (error) {
        console.error('Quick order error:', error);
        showAlert('Unable to process order. Please try again.', 'error');
    }
}

function askAIForProduct() {
    const productQuery = document.getElementById('quickShopInput').value.trim();
    if (productQuery) {
        addUserMessage(`I want to buy ${productQuery}. Can you help me find it and place an order?`);
    } else {
        addUserMessage('I want to shop for products. Can you help me find what I need?');
    }
}

function browsePopularProducts() {
    addUserMessage('Show me popular products available for purchase in Nigeria');
}

function reorderPreviousItem() {
    addUserMessage('I want to reorder my last purchased item. Can you help me with that?');
}

function trackGuestOrder() {
    const orderId = document.getElementById('guestOrderIdInput').value.trim();
    if (orderId) {
        addUserMessage(`Track my order ${orderId} - I want to know the current status, location, and estimated delivery time.`);
    } else {
        showAlert('Please enter your order ID', 'warning');
    }
}

function showCheckoutModal(productData, quantity, deliveryState) {
    // Populate checkout modal with product data
    const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));

    // Update product information
    document.getElementById('checkout-product-name').textContent = productData.product_name || 'Product';
    document.getElementById('checkout-product-category').textContent = productData.category || 'Category';
    document.getElementById('checkout-quantity').textContent = quantity;

    const unitPrice = parseFloat(productData.price) || 0;
    document.getElementById('checkout-unit-price').textContent = formatNaira(unitPrice);

    // Update customer information (if authenticated)
    const customerName = '{{ session.get("customer_name", "Customer") }}';
    const customerEmail = '{{ session.get("customer_email", "email@example.com") }}';
    const customerState = '{{ session.get("customer_state", "Lagos") }}';
    const customerTier = '{{ session.get("customer_tier", "Bronze") }}';

    document.getElementById('checkout-customer-name').textContent = customerName;
    document.getElementById('checkout-customer-email').textContent = customerEmail;
    document.getElementById('checkout-customer-state').textContent = customerState;
    document.getElementById('checkout-customer-tier').textContent = customerTier;

    // Update delivery information
    document.getElementById('checkout-delivery-state').textContent = deliveryState;

    // Calculate totals
    const subtotal = unitPrice * quantity;
    const deliveryFee = calculateDeliveryFee(deliveryState);
    const discount = calculateTierDiscount(subtotal, customerTier);
    const total = subtotal + deliveryFee - discount;

    document.getElementById('checkout-subtotal').textContent = formatNaira(subtotal);
    document.getElementById('checkout-delivery-fee').textContent = formatNaira(deliveryFee);
    document.getElementById('checkout-total').textContent = formatNaira(total);

    if (discount > 0) {
        document.getElementById('checkout-discount-amount').textContent = formatNaira(discount);
        document.getElementById('checkout-discount-row').style.display = 'flex';
    }

    // Store order data for confirmation
    window.currentOrderData = {
        product_id: productData.product_id,
        product_name: productData.product_name,
        quantity: quantity,
        unit_price: unitPrice,
        delivery_state: deliveryState,
        total_amount: total
    };

    modal.show();
}

function calculateDeliveryFee(state) {
    const fees = {
        'Lagos': 2500,
        'Abuja': 3000,
        'Kano': 3500,
        'Rivers': 3000,
        'Oyo': 3000
    };
    return fees[state] || 3500;
}

function calculateTierDiscount(subtotal, tier) {
    const discounts = {
        'Bronze': 0,
        'Silver': 0.05,
        'Gold': 0.10,
        'Platinum': 0.15
    };
    return subtotal * (discounts[tier] || 0);
}

function formatNaira(amount) {
    return `‚Ç¶${amount.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Checkout confirmation
document.addEventListener('DOMContentLoaded', function() {
    const confirmOrderBtn = document.getElementById('confirm-order-btn');
    if (confirmOrderBtn) {
        confirmOrderBtn.addEventListener('click', async function() {
            if (!window.currentOrderData) {
                showAlert('Order data missing. Please try again.', 'error');
                return;
            }

            try {
                const paymentMethod = document.getElementById('checkout-payment-method').value;

                const orderPayload = {
                    product_query: window.currentOrderData.product_name,
                    quantity: window.currentOrderData.quantity,
                    delivery_state: window.currentOrderData.delivery_state,
                    payment_method: paymentMethod
                };

                const response = await fetch('/api/orders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderPayload)
                });

                const result = await response.json();

                if (result.success) {
                    // Hide checkout modal
                    bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();

                    // Show success modal
                    document.getElementById('success-order-id').textContent = result.order_id;
                    document.getElementById('success-total-amount').textContent = formatNaira(result.total_amount);
                    document.getElementById('success-payment-method').textContent = paymentMethod;
                    document.getElementById('success-delivery-date').textContent = result.estimated_delivery;

                    const successModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
                    successModal.show();

                    // Refresh orders list
                    setTimeout(() => {
                        loadMyOrders();
                    }, 2000);
                } else {
                    showAlert(result.message || 'Order failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Order confirmation error:', error);
                showAlert('Unable to process order. Please try again.', 'error');
            }
        });
    }
});

// ... existing code ...
</script>

<!-- Include Checkout Modal -->
{% include 'checkout.html' %}

<!-- Custom Styles for Enhanced Order Tracking -->
<style>
    .order-card {
        transition: all 0.2s ease;
        border: 1px solid #e3e6f0;
    }

    .order-card:hover {
        border-color: #5a5c69;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transform: translateY(-1px);
    }

    .raqibtech-branding {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        color: white;
        margin-bottom: 20px;
    }

    .brand-title {
        margin-bottom: 8px;
    }

    .brand-logo {
        font-size: 1.5rem;
        margin-right: 8px;
    }

    .brand-text {
        font-weight: bold;
        font-size: 1.8rem;
    }

    .brand-domain {
        color: #ffd700;
        font-weight: normal;
    }

    .brand-subtitle {
        margin-bottom: 12px;
        opacity: 0.9;
    }

    .brand-stats .badge {
        margin-right: 8px;
        margin-bottom: 4px;
    }

    .account-dashboard {
        background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e3e6f0;
    }

    .dashboard-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .dashboard-action-btn {
        background: white;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 12px;
        text-align: left;
        transition: all 0.2s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .dashboard-action-btn:hover {
        border-color: #5a5c69;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        background-color: #f8f9fc;
    }

    .action-icon {
        font-size: 1.5rem;
    }

    .action-text strong {
        display: block;
        color: #5a5c69;
        font-size: 0.9rem;
    }

    .action-text small {
        color: #858796;
        font-size: 0.75rem;
    }

    .auth-prompt-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #2196f3;
        border-radius: 12px;
    }

    .order-status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }

    .order-tracking-section {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .products-section {
        background-color: #f8f9fc;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e3e6f0;
    }

    .products-list .badge {
        font-size: 0.75rem;
        font-weight: normal;
    }

    .order-tracking-section {
        border-left: 4px solid #667eea;
    }

    .order-card .btn-group-vertical .btn {
        border-radius: 4px;
        margin-bottom: 2px;
    }

    .order-card .btn-group .btn {
        flex: 1;
    }

    .order-status-badge {
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .modal-body .table th {
        border-top: none;
        font-weight: 600;
        color: #5a5c69;
        font-size: 0.85rem;
    }

    .modal-body .table td {
        vertical-align: middle;
    }

    .btn:disabled {
        opacity: 0.6;
    }

    .alert {
        border: none;
        border-radius: 8px;
    }

    /* Enhanced Order Tracking Timeline Styles */
    .tracking-timeline {
        padding: 20px 0;
    }

    .timeline-item {
        display: flex;
        margin-bottom: 20px;
        position: relative;
    }

    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 20px;
        top: 40px;
        width: 2px;
        height: calc(100% + 10px);
        background-color: #e3e6f0;
        z-index: 1;
    }

    .timeline-item.completed:not(:last-child)::after {
        background-color: #1cc88a;
    }

    .timeline-marker {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e3e6f0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        position: relative;
        z-index: 2;
        flex-shrink: 0;
    }

    .timeline-item.completed .timeline-marker {
        background-color: #1cc88a;
        color: white;
    }

    .timeline-item.current .timeline-marker {
        background-color: #4e73df;
        color: white;
        animation: pulse 2s infinite;
    }

    .timeline-icon {
        font-size: 16px;
    }

    .timeline-content {
        flex: 1;
        padding-top: 5px;
    }

    .timeline-title {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 600;
        color: #5a5c69;
    }

    .timeline-item.completed .timeline-title {
        color: #1cc88a;
    }

    .timeline-item.current .timeline-title {
        color: #4e73df;
    }

    .timeline-description {
        margin: 0;
        color: #858796;
        font-size: 14px;
        line-height: 1.4;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(78, 115, 223, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(78, 115, 223, 0);
        }
    }

    /* Enhanced order modal styles */
    .modal-lg {
        max-width: 900px;
    }

    .order-details-card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border-radius: 12px;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }

    .delivery-info-card {
        background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
        border: 1px solid #e3e6f0;
        border-radius: 12px;
    }
</style>

<!-- Order Tracking Modal -->
<div class="modal fade" id="orderTrackingModal" tabindex="-1" aria-labelledby="orderTrackingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderTrackingModalLabel">
                    <i class="bi bi-box-seam me-2"></i>Order Tracking Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Order tracking content will be dynamically loaded here -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading order details...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading comprehensive order information...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Integrated Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="checkoutModalLabel">
                    <i class="fas fa-shopping-cart me-2"></i>Order Confirmation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Order Summary Section -->
                <div class="row">
                    <div class="col-md-8">
                        <!-- Product Details -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-box me-2"></i>Product Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="product-image me-3">
                                        <div class="bg-light rounded p-3" style="width: 80px; height: 80px;">
                                            <i class="fas fa-mobile-alt fa-2x text-muted"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1" id="checkout-product-name">Product Name</h6>
                                        <p class="text-muted mb-1" id="checkout-product-category">Category</p>
                                        <div class="d-flex justify-content-between">
                                            <span>Quantity: <span id="checkout-quantity">1</span></span>
                                            <span class="fw-bold" id="checkout-unit-price">‚Ç¶0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Information -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Customer Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <strong>Name:</strong> <span id="checkout-customer-name">Customer Name</span>
                                    </div>
                                    <div class="col-sm-6">
                                        <strong>Email:</strong> <span id="checkout-customer-email">email@example.com</span>
                                    </div>
                                    <div class="col-sm-6 mt-2">
                                        <strong>State:</strong> <span id="checkout-customer-state">Lagos</span>
                                    </div>
                                    <div class="col-sm-6 mt-2">
                                        <strong>Account Tier:</strong>
                                        <span class="badge" id="checkout-customer-tier">Bronze</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Information -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-truck me-2"></i>Delivery Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <strong>Delivery State:</strong> <span id="checkout-delivery-state">Lagos</span>
                                    </div>
                                    <div class="col-sm-6">
                                        <strong>Estimated Delivery:</strong> <span id="checkout-delivery-days">3 days</span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <strong>Payment Method:</strong>
                                    <select class="form-select" id="checkout-payment-method">
                                        <option value="Pay on Delivery">Pay on Delivery</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Card">Card Payment</option>
                                        <option value="RaqibTechPay">RaqibTechPay</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Total Section -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Order Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="checkout-subtotal">‚Ç¶0.00</span>
                                </div>

                                <div class="d-flex justify-content-between mb-2 text-success" id="checkout-discount-row" style="display: none !important;">
                                    <span>Discount (<span id="checkout-discount-rate">0</span>%):</span>
                                    <span>-‚Ç¶<span id="checkout-discount-amount">0.00</span></span>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span>Delivery Fee:</span>
                                    <span id="checkout-delivery-fee">‚Ç¶0.00</span>
                                </div>

                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Total:</span>
                                    <span class="text-success" id="checkout-total">‚Ç¶0.00</span>
                                </div>

                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        Secure checkout powered by RaqibTech
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Nigerian Payment Methods Info -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-credit-card me-2"></i>Payment Options
                                </h6>
                                <div class="payment-methods">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-truck text-primary me-2"></i>
                                        <small>Pay on Delivery (Most Popular)</small>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-university text-success me-2"></i>
                                        <small>Bank Transfer</small>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-credit-card text-info me-2"></i>
                                        <small>Card Payment</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-mobile-alt text-warning me-2"></i>
                                        <small>RaqibTechPay</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirm-order-btn">
                    <i class="fas fa-check me-2"></i>Confirm Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order Success Modal -->
<div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-labelledby="orderSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="orderSuccessModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Order Confirmed!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 class="text-success mb-3">Order Successfully Placed!</h4>
                <p class="mb-3">Your order <strong id="success-order-id">#RQB20250101</strong> has been confirmed.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    You'll receive SMS and email confirmation shortly.
                </div>
                <div class="order-details">
                    <p><strong>Total Amount:</strong> <span id="success-total-amount">‚Ç¶0.00</span></p>
                    <p><strong>Payment Method:</strong> <span id="success-payment-method">Pay on Delivery</span></p>
                    <p><strong>Estimated Delivery:</strong> <span id="success-delivery-date">January 15, 2025</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>Great!
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

