{% extends "base.html" %}

{% block title %}raqibtech.com Customer Support - How can we help you?{% endblock %}

{% block content %}

<!-- Enhanced Floating Modal Chat System with Microsoft-style Design -->
<style>
/* ===== FLOATING CHAT MODAL SYSTEM ===== */
/* Floating Chat Button */
.floating-chat-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #2c3e50 0%, #18bc9c 100%);
    border-radius: 50%;
    box-shadow: 0 8px 32px rgba(44, 62, 80, 0.3);
    border: none;
    cursor: pointer;
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: scale(1);
    pointer-events: auto;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    outline: none;
}

.floating-chat-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 40px rgba(44, 62, 80, 0.4);
    background: linear-gradient(135deg, #18bc9c 0%, #2c3e50 100%);
}

.floating-chat-btn:active {
    transform: scale(0.95);
}

.floating-chat-btn.active {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    transform: rotate(45deg) scale(1.1);
}

/* Chat Modal Overlay */
.chat-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 9999;
    display: none;
    opacity: 0;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
}

.chat-modal-overlay.active {
    display: flex;
    opacity: 1;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
}

/* Main Chat Modal Container */
.chat-modal {
    width: 400px;
    height: 600px;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: scale(0.9) translateY(50px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    pointer-events: auto;
}

.chat-modal-overlay.active .chat-modal {
    transform: scale(1) translateY(0);
}

/* Modal Header */
.chat-modal-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.chat-modal-title {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.chat-modal-title .brand-logo {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.chat-modal-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.chat-modal-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.chat-modal-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
}

/* Conversation Sidebar */
.conversation-sidebar {
    position: absolute;
    left: -300px;
    top: 0;
    width: 300px;
    height: 100%;
    background: #f8f9fa;
    border-right: 1px solid #e9ecef;
    z-index: 10;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.conversation-sidebar.active {
    transform: translateX(300px);
}

.conversation-sidebar-header {
    padding: 16px;
    background: #ffffff;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.conversation-sidebar-title {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

/* Sidebar overlay effect when open */
.chat-modal.sidebar-open::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    z-index: 5;
    pointer-events: none;
}

.conversation-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

/* Chat Messages Area */
.chat-modal-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Message Bubbles - Microsoft Fluent Style */
.message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.customer {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.message.ai .message-avatar {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
}

.message.customer .message-avatar {
    background: linear-gradient(135deg, #18bc9c, #16a085);
    color: white;
}

.message-content {
    max-width: 280px;
    flex: 1;
}

.message-bubble {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 12px 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    position: relative;
}

.message.customer .message-bubble {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    border-color: #2c3e50;
}

.message-meta {
    margin-top: 4px;
    font-size: 11px;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.message.customer .message-meta {
    flex-direction: row-reverse;
}

.response-time {
    font-size: 10px;
    color: #18bc9c;
    background: rgba(24, 188, 156, 0.1);
    padding: 2px 6px;
    border-radius: 8px;
    white-space: nowrap;
}

/* Welcome Message - Enhanced */
.message.welcome .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    color: white;
    border: none;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
}

.message.welcome .message-bubble::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
    animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0.5; transform: rotate(0deg) scale(1); }
    50% { opacity: 1; transform: rotate(180deg) scale(1.05); }
}

.welcome-content {
    position: relative;
    z-index: 1;
}

.welcome-content h6 {
    font-size: 16px;
    font-weight: 700;
    color: #2C3E50;
    margin-bottom: 12px;
}

.welcome-content p {
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 12px;
    color: #2C3E50;
    font-weight: 500;
}

.welcome-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
}

.welcome-quick-action-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #2C3E50;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.welcome-quick-action-btn:hover {
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
    text-decoration: none;
    transform: translateY(-2px);
    border-color: #ffd700;
}

/* Smart Quick Actions */
.smart-quick-actions-container {
    margin: 12px 0;
}

.smart-quick-actions {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.quick-actions-header {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    text-align: center;
}

.quick-actions-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
}

.smart-quick-action-btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 2px 6px rgba(0,123,255,0.2);
}

.smart-quick-action-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

/* Chat Input Area */
.chat-modal-input {
    padding: 16px;
    background: #ffffff;
    border-top: 1px solid #e9ecef;
}

.chat-input-container {
    display: flex;
    gap: 8px;
    align-items: center;
}

.chat-input-container input {
    flex: 1;
    border: 1px solid #e9ecef;
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 14px;
    outline: none;
    transition: all 0.2s ease;
}

.chat-input-container input:focus {
    border-color: #18bc9c;
    box-shadow: 0 0 0 3px rgba(24, 188, 156, 0.1);
}

.chat-send-btn {
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(24, 188, 156, 0.2);
}

.chat-send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(24, 188, 156, 0.3);
}

.chat-send-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Typing Indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #6c757d;
    animation: typingPulse 1.4s ease-in-out infinite both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes typingPulse {
    0%, 80%, 100% {
        opacity: 0.4;
        transform: scale(0.8);
    }
    40% {
        opacity: 1;
        transform: scale(1);
    }
}

/* Conversation List Items */
.conversation-item {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.conversation-item:hover {
    background: #f8f9fa;
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.conversation-item.active {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
}

.conversation-info h6 {
    font-size: 13px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0 0 4px 0;
}

.conversation-info small {
    font-size: 11px;
    color: #6c757d;
}

.conversation-actions {
    display: flex;
    align-items: center;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.conversation-item:hover .conversation-actions {
    opacity: 1;
}

.conversation-actions .btn-sm {
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 4px;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .chat-modal {
        width: 100%;
        height: 100%;
        border-radius: 0;
        transform: translateY(100%);
    }

    .chat-modal-overlay.active .chat-modal {
        transform: translateY(0);
    }

    .conversation-sidebar {
        width: 280px;
        left: -280px;
    }

    .conversation-sidebar.active {
        transform: translateX(280px);
    }

    .floating-chat-btn {
        bottom: 16px;
        right: 16px;
        width: 56px;
        height: 56px;
        font-size: 20px;
    }
}

/* Loading States */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #18bc9c;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Hide original chat tab content */
.original-chat-content {
    display: none;
}
</style>

<!-- Session and User Info Header -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="session-info">
                {% if session.get('user_authenticated') %}
                    <span class="badge bg-success">
                        <i class="bi bi-person-check-fill me-1"></i>
                        Logged in as {{ session.get('user_email', 'User') }}
                    </span>
                {% else %}
                    <span class="badge bg-secondary">
                        <i class="bi bi-person me-1"></i>
                        Guest Session
                    </span>
                {% endif %}
            </div>
            <div class="session-actions">
                {% if session.get('user_authenticated') %}
                    <a href="/logout" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </a>
                {% else %}
                    <a href="/login" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Login
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Simplified Dashboard without Chat Tab -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <!-- Support Navigation Tabs (without chat) -->
            <ul class="nav nav-tabs nav-fill" id="supportTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                        <i class="bi bi-box-seam me-2"></i>
                        📦 Track My Orders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab">
                        <i class="bi bi-person-gear me-2"></i>
                        👤 My Account
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                        <i class="bi bi-telephone-fill me-2"></i>
                        📞 Contact Support
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="supportTabContent">
                <!-- Track My Orders Tab -->
                <div class="tab-pane fade show active" id="orders" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-box-seam text-primary me-2"></i>
                                Track Your Orders
                            </h4>
                            <p class="text-muted">
                                {% if session.get('user_authenticated') %}
                                    Your recent orders will appear here. You can also ask our AI assistant for help.
                                {% else %}
                                    <a href="/login" class="text-decoration-none">Login</a> to see your order history, or ask our AI assistant for help.
                                {% endif %}
                            </p>
                        </div>

                        <!-- Order Tracking Form -->
                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Quick Order Lookup</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Order ID</label>
                                            <input type="text" class="form-control" id="orderIdInput"
                                                   placeholder="Enter your order ID (e.g., 12345)">
                                        </div>
                                        <button class="btn btn-primary w-100" onclick="trackOrderViaChat()">
                                            <i class="bi bi-search me-1"></i>Track My Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-info-circle text-info me-1"></i>
                                            Order Status Guide
                                        </h6>
                                        <ul class="list-unstyled small">
                                            <li class="mb-1">
                                                <span class="badge bg-warning me-2">Pending</span>
                                                Order received, being prepared
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-info me-2">Processing</span>
                                                Order being processed for delivery
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-success me-2">Delivered</span>
                                                Order delivered successfully
                                            </li>
                                            <li class="mb-1">
                                                <span class="badge bg-secondary me-2">Returned</span>
                                                Order was returned
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Account Tab -->
                <div class="tab-pane fade" id="account" role="tabpanel">
                    <div class="p-4">
                        <!-- raqibtech.com Branding Header -->
                        {% if session.get('user_authenticated') %}
                        <div class="mb-4 text-center">
                            <div class="raqibtech-branding">
                                <h2 class="brand-title mb-2">
                                    <span class="brand-logo">🚀</span>
                                    <span class="brand-text">raqibtech</span>
                                    <span class="brand-domain">.com</span>
                                </h2>
                                <p class="brand-subtitle">Your Trusted Nigerian E-commerce Partner</p>
                                <div class="brand-stats">
                                    <span class="badge bg-success me-2">🇳🇬 36 States + FCT</span>
                                    <span class="badge bg-primary me-2">📦 1M+ Deliveries</span>
                                    <span class="badge bg-warning">⭐ 4.8/5 Rating</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-person-gear text-warning me-2"></i>
                                My Account & Profile
                            </h4>
                            {% if session.get('user_authenticated') %}
                                <p class="text-muted">
                                    Welcome back! Manage your account information and explore personalized features.
                                </p>
                            {% else %}
                                <p class="text-muted">
                                    <a href="/login" class="text-decoration-none">Login</a> to access your account settings and order history.
                                </p>
                            {% endif %}
                        </div>

                        {% if session.get('user_authenticated') %}
                        <!-- Enhanced Quick Actions Dashboard for Logged-in Users -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="account-dashboard">
                                    <h5 class="mb-3">
                                        <i class="bi bi-speedometer2 text-primary me-2"></i>
                                        Personal Dashboard
                                    </h5>
                                    <div class="dashboard-actions">
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Show my recent orders')">
                                            <div class="action-icon">📦</div>
                                            <div class="action-text">
                                                <strong>Recent Orders</strong>
                                                <small>Track & manage</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('What are my account benefits?')">
                                            <div class="action-icon">⭐</div>
                                            <div class="action-text">
                                                <strong>Account Benefits</strong>
                                                <small>Tier & rewards</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Recommend products for me')">
                                            <div class="action-icon">🛍️</div>
                                            <div class="action-text">
                                                <strong>For You</strong>
                                                <small>Personalized picks</small>
                                            </div>
                                        </button>
                                        <button class="dashboard-action-btn" onclick="sendQuickMessage('Help with payments')">
                                            <div class="action-icon">💳</div>
                                            <div class="action-text">
                                                <strong>Payments</strong>
                                                <small>Methods & billing</small>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Account Actions -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Account Services</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="sendQuickMessage('Update my profile information')">
                                                <i class="bi bi-person-fill-gear me-2"></i>Update Profile Information
                                            </button>
                                            <button class="btn btn-outline-success" onclick="sendQuickMessage('Change my delivery address')">
                                                <i class="bi bi-geo-alt-fill me-2"></i>Update Delivery Address
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="sendQuickMessage('Check my account tier and benefits')">
                                                <i class="bi bi-star-fill me-2"></i>View Account Tier & Benefits
                                            </button>
                                            <button class="btn btn-outline-info" onclick="sendQuickMessage('Update my payment methods')">
                                                <i class="bi bi-credit-card-fill me-2"></i>Manage Payment Methods
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Benefits -->
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">Account Tiers & Benefits</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="tier-info">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-secondary">Bronze</span>
                                                <small>Standard benefits</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-primary">Silver</span>
                                                <small>5% discount + priority support</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="badge bg-warning">Gold</span>
                                                <small>10% discount + free delivery</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-info">Platinum</span>
                                                <small>15% discount + premium perks</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Support Tab -->
                <div class="tab-pane fade" id="contact" role="tabpanel">
                    <div class="p-4">
                        <div class="mb-4">
                            <h4 class="mb-3">
                                <i class="bi bi-telephone-fill text-danger me-2"></i>
                                Contact raqibtech.com Support
                            </h4>
                            <p class="text-muted">
                                Multiple ways to reach our support team across Nigeria.
                            </p>
                        </div>

                        <div class="row">
                            <!-- Contact Methods -->
                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-telephone-fill text-success display-4 mb-3"></i>
                                        <h6>Phone Support</h6>
                                        <p class="text-muted small">Speak with our support team</p>
                                        <strong class="text-success">+234 (702) 5965-922 (72242)</strong>
                                        <p class="small mt-2">Daily 8AM - 8PM (WAT)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-envelope-fill text-primary display-4 mb-3"></i>
                                        <h6>Email Support</h6>
                                        <p class="text-muted small">Send us your questions</p>
                                        <strong class="text-primary">support@raqibtech.com</strong>
                                        <p class="small mt-2">Response within 24 hours</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="card h-100 text-center">
                                    <div class="card-body">
                                        <i class="bi bi-chat-heart-fill text-danger display-4 mb-3"></i>
                                        <h6>Live AI Chat</h6>
                                        <p class="text-muted small">Instant help available</p>
                                        <strong class="text-danger">Available 24/7</strong>
                                        <p class="small mt-2">
                                            <button class="btn btn-sm btn-outline-danger" onclick="openChatModal()">
                                                Start Chat Now
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nigerian Coverage -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="bi bi-geo-alt-fill me-2"></i>
                                            🇳🇬 Nationwide Coverage in Nigeria
                                        </h6>
                                        <p class="mb-0">
                                            We deliver to all 36 Nigerian states + FCT with dedicated support for your region.
                                            Payment options include Pay on Delivery, Bank Transfer, Card, and RaqibTechPay.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Chat Button -->
<button class="floating-chat-btn" id="floatingChatBtn">
    <i class="bi bi-chat-heart-fill"></i>
</button>

<!-- 🔧 DEBUG: Temporary test button to verify modal functionality -->
<div style="position: fixed; top: 10px; right: 10px; z-index: 10000;">
    <button class="btn btn-warning btn-sm" onclick="debugTestModal()" id="debugTestBtn">
        🔧 Test Modal
    </button>
</div>

<!-- Chat Modal -->
<div class="chat-modal-overlay" id="chatModalOverlay" onclick="closeChatModal(event)">
    <div class="chat-modal" onclick="handleModalClick(event)">
        <!-- Modal Header -->
        <div class="chat-modal-header">
            <h6 class="chat-modal-title">
                <div class="brand-logo">🚀</div>
                <span>raqibtech.com Assistant</span>
            </h6>
            <div class="chat-modal-actions">
                <button class="chat-modal-btn" onclick="toggleConversationSidebar()" title="Chat History">
                    <i class="bi bi-clock-history"></i>
                </button>
                <button class="chat-modal-btn" onclick="createNewChat()" title="New Chat">
                    <i class="bi bi-plus-circle"></i>
                </button>
                <button class="chat-modal-btn" onclick="closeChatModal()" title="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- Conversation Sidebar -->
        <div class="conversation-sidebar" id="conversationSidebar">
            <div class="conversation-sidebar-header">
                <h6 class="conversation-sidebar-title">Chat History</h6>
                <button class="chat-modal-btn" onclick="toggleConversationSidebar()" title="Close History">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="conversation-list" id="chatHistoryList">
                {% for conv in conversations %}
                <div class="conversation-item" data-conversation-id="{{ conv.conversation_id }}"
                     onclick="switchToConversation('{{ conv.conversation_id }}')">
                    <div class="conversation-info">
                        <h6>{{ conv.conversation_title }}</h6>
                        <small>{{ conv.message_count }} messages</small>
                    </div>
                    <div class="conversation-actions">
                        <small class="text-muted">{{ conv.updated_at.strftime('%m/%d') }}</small>
                        <button class="btn btn-outline-danger btn-sm" onclick="customerPortal.deleteConversation('{{ conv.conversation_id }}', event)"
                                title="Delete conversation">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}

                {% if not conversations %}
                <div class="text-center text-muted p-3">
                    <i class="bi bi-chat-dots display-6 mb-2"></i>
                    <p class="mb-0 small">No chat history yet</p>
                    <small>Start a conversation!</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Messages Area -->
        <div class="chat-modal-messages" id="chatMessages">
            <div id="loadingIndicator" class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted small">Loading conversation...</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-modal-input">
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="Ask me anything..."
                       onkeypress="handleChatKeyPress(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced raqibtech.com Branding Styles for Account Dashboard -->
<style>
.raqibtech-branding {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.brand-title {
    font-size: 28px;
    font-weight: 800;
    margin: 0;
}

.brand-logo {
    font-size: 32px;
    margin-right: 8px;
}

.brand-text {
    color: #ffd700;
    letter-spacing: 1px;
}

.brand-domain {
    color: #ffffff;
    font-weight: 600;
}

.brand-subtitle {
    font-size: 16px;
    margin-bottom: 16px;
    opacity: 0.9;
    font-weight: 500;
}

.brand-stats .badge {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
}

/* Account Dashboard Styles */
.account-dashboard {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid #dee2e6;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.dashboard-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.dashboard-action-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.dashboard-action-btn:hover {
    border-color: #18bc9c;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(24, 188, 156, 0.2);
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
}

.action-icon {
    font-size: 24px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #18bc9c, #16a085);
    border-radius: 12px;
    flex-shrink: 0;
}

.action-text strong {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.action-text small {
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

/* Responsive dashboard */
@media (max-width: 768px) {
    .dashboard-actions {
        grid-template-columns: 1fr;
    }

    .dashboard-action-btn {
        padding: 16px;
    }

    .action-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
}
</style>

<!-- Hidden data for JavaScript -->
<script>
window.currentConversationId = {% if current_conversation_id %}'{{ current_conversation_id }}'{% else %}null{% endif %};
window.userAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
</script>

<!-- Enhanced Customer Support JavaScript with Floating Modal Chat -->
<script>
// 🔧 DEBUG: Check for JavaScript errors and conflicts
console.log('🔍 Modal Debug: Starting initialization...');

// Check for required dependencies
if (typeof bootstrap === 'undefined') {
    console.error('❌ Bootstrap JavaScript not loaded! Modal will not work.');
}

// Enhanced Customer-focused support system with floating modal interface
class CustomerSupportPortal {
    constructor() {
        console.log('🛍️ Initializing raqibtech.com Floating Modal Chat System...');

        // Debug: Check if elements exist
        this.debugElementExistence();

        this.currentConversationId = window.currentConversationId;
        this.userAuthenticated = window.userAuthenticated;
        this.isTyping = false;
        this.activeMessageRequest = null;
        this.conversationLocked = false;
        this.modalOpen = false;
        this.sidebarOpen = false;

        // Add delay to ensure DOM is fully ready
        setTimeout(() => {
            this.initializeFloatingChat();
            this.setupKeyboardShortcuts();
            console.log('✅ Modal initialization complete');
        }, 100);
    }

    debugElementExistence() {
        const requiredElements = [
            'chatModalOverlay',
            'floatingChatBtn',
            'conversationSidebar',
            'chatMessages',
            'chatInput'
        ];

        console.log('🔍 Checking required elements...');
        requiredElements.forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`❌ Missing element: ${id}`);
            } else {
                console.log(`✅ Found element: ${id}`);
            }
        });
    }

    initializeFloatingChat() {
        // Initialize modal state with error checking
        this.chatModal = document.getElementById('chatModalOverlay');
        this.chatBtn = document.getElementById('floatingChatBtn');
        this.conversationSidebar = document.getElementById('conversationSidebar');

        if (!this.chatModal) {
            console.error('❌ Chat modal overlay not found!');
            return;
        }

        if (!this.chatBtn) {
            console.error('❌ Floating chat button not found!');
            return;
        }

        console.log('✅ Modal elements found and initialized');

        // Ensure proper z-index (fix from WeWeb community issue)
        this.chatModal.style.zIndex = '9999';
        this.chatBtn.style.zIndex = '9998';

        // Load conversation when modal is opened
        this.setupModalEventListeners();

        // 🔧 FIX: Multiple event listeners for better compatibility
        // Remove any existing listeners first
        this.chatBtn.replaceWith(this.chatBtn.cloneNode(true));
        this.chatBtn = document.getElementById('floatingChatBtn');

        // Method 1: Click event listener
        this.chatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('🖱️ Floating button clicked via addEventListener');
            this.toggleChatModal();
        });

        // Method 2: Mouse down/up for better mobile support
        this.chatBtn.addEventListener('mousedown', (e) => {
            console.log('🖱️ Mouse down detected on floating button');
        });

        // Method 3: Touch events for mobile
        this.chatBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            console.log('📱 Touch start detected on floating button');
            this.toggleChatModal();
        }, { passive: false });

        // Method 4: Pointer events (modern approach)
        this.chatBtn.addEventListener('pointerdown', (e) => {
            console.log('👆 Pointer down detected on floating button');
        });

        console.log('✅ Multiple event listeners attached to floating button');
    }

    setupKeyboardShortcuts() {
        // ESC to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.modalOpen) {
                console.log('⌨️ ESC key pressed, closing modal');
                this.closeChatModal();
            }
        });
        console.log('✅ Keyboard shortcuts configured');
    }

    setupModalEventListeners() {
        if (!this.chatModal) return;

        // Auto-focus input when modal opens
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class' && this.chatModal.classList.contains('active')) {
                    setTimeout(() => {
                        const chatInput = document.getElementById('chatInput');
                        if (chatInput) {
                            chatInput.focus();
                            console.log('✅ Chat input focused');
                        }
                    }, 400); // Wait for animation
                }
            });
        });
        observer.observe(this.chatModal, { attributes: true });
        console.log('✅ Modal event listeners configured');
    }

    toggleChatModal() {
        console.log(`🔄 Toggle modal - Current state: ${this.modalOpen ? 'open' : 'closed'}`);
        if (this.modalOpen) {
            this.closeChatModal();
        } else {
            this.openChatModal();
        }
    }

    openChatModal() {
        console.log('📂 Opening chat modal...');

        if (!this.chatModal || !this.chatBtn) {
            console.error('❌ Cannot open modal - elements missing');
            return;
        }

        this.modalOpen = true;
        this.chatModal.classList.add('active');
        this.chatBtn.classList.add('active');
        this.chatBtn.innerHTML = '<i class="bi bi-x-lg"></i>';

        // Load current conversation if not already loaded
        if (!this.conversationLoaded) {
            this.loadCurrentConversation();
            this.conversationLoaded = true;
        }

        // Disable body scroll (fix from Frozen Modal guide)
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';

        console.log('✅ Modal opened successfully');
    }

    closeChatModal(event) {
        // Don't close if clicking inside modal
        if (event && event.target.closest('.chat-modal')) {
            console.log('🖱️ Click inside modal, not closing');
            return;
        }

        console.log('📁 Closing chat modal...');

        if (!this.chatModal || !this.chatBtn) {
            console.error('❌ Cannot close modal - elements missing');
            return;
        }

        this.modalOpen = false;
        this.chatModal.classList.remove('active');
        this.chatBtn.classList.remove('active');
        this.chatBtn.innerHTML = '<i class="bi bi-chat-heart-fill"></i>';

        // Close sidebar if open and reset modal state
        if (this.sidebarOpen) {
            this.sidebarOpen = false;
            this.conversationSidebar.classList.remove('active');
            const chatModal = document.querySelector('.chat-modal');
            if (chatModal) {
                chatModal.classList.remove('sidebar-open');
            }
        }

        // Re-enable body scroll (fix from WeWeb community)
        document.body.style.overflow = 'auto';
        document.documentElement.style.overflow = 'auto';

        // Force layout recalculation (fix from WeWeb community)
        document.body.offsetHeight;

        console.log('✅ Modal closed successfully');
    }

    toggleConversationSidebar() {
        if (!this.conversationSidebar) {
            console.error('❌ Conversation sidebar not found');
            return;
        }

        this.sidebarOpen = !this.sidebarOpen;
        this.conversationSidebar.classList.toggle('active', this.sidebarOpen);

        // Add overlay effect to main modal when sidebar is open
        const chatModal = document.querySelector('.chat-modal');
        if (chatModal) {
            chatModal.classList.toggle('sidebar-open', this.sidebarOpen);
        }

        console.log(`🔄 Sidebar ${this.sidebarOpen ? 'opened' : 'closed'}`);

        // Refresh conversation list when opening
        if (this.sidebarOpen) {
            this.refreshConversationList();
        }

        // Focus the close button when sidebar opens for better accessibility
        if (this.sidebarOpen) {
            setTimeout(() => {
                const closeBtn = this.conversationSidebar.querySelector('.chat-modal-btn');
                if (closeBtn) {
                    closeBtn.focus();
                }
            }, 300);
        }
    }

    async loadCurrentConversation() {
        if (!this.currentConversationId) {
            console.log('💬 No current conversation, showing welcome message');
            this.displayWelcomeMessage();
            return;
        }

        console.log(`🔄 Loading conversation: ${this.currentConversationId}`);

        try {
            const response = await fetch(`/api/conversations/${this.currentConversationId}/messages`);
            const data = await response.json();

            if (this.currentConversationId !== window.currentConversationId) {
                console.warn('⚠️ Conversation changed during loading, aborting');
                return;
            }

            if (data.success && data.messages.length > 0) {
                this.displayConversationHistory(data.messages);
            } else {
                this.showWelcomeMessage();
            }
        } catch (error) {
            console.error('❌ Error loading conversation:', error);
            this.showWelcomeMessage();
        }
    }

    displayConversationHistory(messages) {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (!chatMessages) {
            console.error('❌ Chat messages container not found');
            return;
        }

        chatMessages.innerHTML = '';

        messages.forEach(message => {
            const senderType = message.sender_type === 'user' ? 'customer' : 'ai';
            this.addMessageToChatDisplay(message.content, senderType, false, message.metadata || {});
        });

        this.smoothScrollToBottom();
        console.log(`✅ Loaded ${messages.length} messages for conversation ${this.currentConversationId}`);
    }

    showWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');

        if (loadingIndicator) {
            loadingIndicator.remove();
        }

        if (!chatMessages) {
            console.error('❌ Chat messages container not found');
            return;
        }

        const welcomeMessage = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeMessage;
        this.smoothScrollToBottom();

        console.log('✅ Welcome message displayed in modal');
    }

    createWelcomeMessage() {
        return `
            <div class="message ai welcome">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="welcome-content">
                            ${this.userAuthenticated ?
                                `<h6 class="mb-2">👋 Welcome back! 🌟</h6>
                                <p class="mb-3">🎉 Great to see you again! I'm excited to help you with your orders and account today! 😊✨</p>
                                <p class="mb-3">💙 As your personal support assistant, I can help with:</p>
                                <ul class="list-unstyled mb-3">
                                    <li class="mb-1">🔍 <strong>Track your orders</strong> - Real-time delivery updates</li>
                                    <li class="mb-1">💳 <strong>Payment assistance</strong> - Billing and payment issues</li>
                                    <li class="mb-1">🚚 <strong>Delivery management</strong> - Address changes and scheduling</li>
                                    <li class="mb-1">👤 <strong>Account settings</strong> - Profile and preferences</li>
                                    <li class="mb-1">🛍️ <strong>Shopping help</strong> - Product recommendations</li>
                                    <li class="mb-1">🏪 <strong>Browse our amazing product catalog</strong> - Electronics, Fashion, Beauty, Computing, Automotive, Books</li>
                                </ul>
                                <div class="welcome-quick-actions">
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Track my recent orders')">📦 My Orders</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Show my account summary')">👤 Account Info</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Browse your product catalog')">🏪 Browse Catalog</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Show me electronics products')">📱 Electronics</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Check prices for popular products')">💰 Check Prices</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Contact customer support')">📞 Support</button>
                                </div>
                                <p class="mt-3 mb-0">💬 <strong>Ask me anything!</strong> I'm here to help with your personal account and orders. 🌟💝</p>` :
                                `<h6 class="mb-2">👋 Welcome to raqibtech.com! 🌟</h6>
                                <p class="mb-3">😊 I'm your AI customer support guide! I'm here to show you what our platform can do.</p>
                                <p class="mb-3">🔒 <strong>For Guest Users:</strong> I can provide general information about our services, but for personalized support with your orders and account, you'll need to sign up or log in!</p>
                                <p class="mb-3">🌟 <strong>What raqibtech.com offers:</strong></p>
                                <ul class="list-unstyled mb-3">
                                    <li class="mb-1">🛍️ <strong>E-commerce Platform</strong> - Shop from thousands of products</li>
                                    <li class="mb-1">🇳🇬 <strong>Nigeria-wide Delivery</strong> - We deliver to all 36 states + FCT</li>
                                    <li class="mb-1">💳 <strong>Flexible Payments</strong> - Pay on Delivery, Card, Bank Transfer</li>
                                    <li class="mb-1">👤 <strong>Account Tiers</strong> - Bronze, Silver, Gold, Platinum with benefits</li>
                                    <li class="mb-1">📞 <strong>24/7 Support</strong> - AI and human support always available</li>
                                    <li class="mb-1">🏪 <strong>Amazing Product Catalog</strong> - Electronics, Fashion, Beauty, Computing, Automotive, Books</li>
                                </ul>
                                <div class="welcome-quick-actions">
                                    <a href="/login" class="welcome-quick-action-btn">🔐 Login</a>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('How do I create an account?')">📝 Sign Up</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('What services do you offer?')">💡 Learn More</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Contact customer support')">📞 Contact Support</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Browse your product catalog')">🏪 Browse Catalog</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Show me electronics products')">📱 Electronics</button>
                                    <button class="welcome-quick-action-btn" onclick="customerPortal.sendCustomerMessage('Check prices for popular products')">💰 Check Prices</button>
                                </div>
                                <p class="mt-3 mb-0">💬 <strong>Ask me anything!</strong> I can guide you about our services and help you get started! 🌟</p>`
                            }
                        </div>
                    </div>
                    <div class="message-meta">
                        <span>${new Date().toLocaleTimeString()}</span>
                        <span class="response-time">${this.userAuthenticated ?
                            "Your personal support assistant - always here for you!" :
                            "Sign up for personalized support - it's free!"
                        }</span>
                    </div>
                </div>
            </div>
        `;
    }

    async sendCustomerMessage(message = null) {
        if (this.isTyping || this.conversationLocked) {
            console.warn('⚠️ Message blocked: System is busy');
            return;
        }

        const chatInput = document.getElementById('chatInput');
        if (!chatInput) {
            console.error('❌ Chat input not found');
            return;
        }

        const userMessage = message || chatInput.value.trim();
        if (!userMessage) {
            console.warn('⚠️ Empty message, not sending');
            return;
        }

        console.log(`📤 Sending message: ${userMessage.substring(0, 50)}...`);

        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
            this.removeTypingIndicator();
        }

        if (!message) chatInput.value = '';

        const requestConversationId = this.currentConversationId;
        this.addMessageToChatDisplay(userMessage, 'customer');
        this.isTyping = true;
        this.showTypingIndicator();

        try {
            const controller = new AbortController();
            this.activeMessageRequest = controller;

            const response = await fetch('/api/enhanced-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: userMessage
                }),
                signal: controller.signal
            });

            if (requestConversationId !== this.currentConversationId) {
                console.warn('⚠️ Conversation changed during request, ignoring response');
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (requestConversationId !== this.currentConversationId) {
                console.warn('⚠️ Conversation changed before response processing, ignoring');
                return;
            }

            this.isTyping = false;
            this.activeMessageRequest = null;
            this.removeTypingIndicator();

            if (data.success) {
                console.log('✅ Message sent successfully');
                this.addCustomerResponseToChat(data);
                this.refreshConversationList();
            } else {
                this.addMessageToChatDisplay(data.message || 'Sorry, I encountered an issue. Please try again.', 'ai', true);
            }

        } catch (error) {
            if (error.name !== 'AbortError') {
                this.isTyping = false;
                this.activeMessageRequest = null;
                this.removeTypingIndicator();
                console.error('❌ Customer chat error:', error);

                if (requestConversationId === this.currentConversationId) {
                    this.addMessageToChatDisplay('I apologize, but I\'m experiencing technical difficulties. Please try again or contact our phone support at +234 (702) 5965-922.', 'ai', true);
                }
            }
        }
    }

    addMessageToChatDisplay(message, sender, isError = false, metadata = {}) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) {
            console.error('❌ Chat messages container not found');
            return;
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender === 'customer' ? 'customer' : 'ai'}`;

        if (isError) {
            messageDiv.classList.add('error');
        }

        const timestamp = new Date().toLocaleTimeString();
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = sender === 'customer' ? 'U' : 'AI';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';

        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';
        messageBubble.innerHTML = message;

        const messageMeta = document.createElement('div');
        messageMeta.className = 'message-meta';

        if (sender === 'customer') {
            messageMeta.innerHTML = `<span>${timestamp}</span>`;
        } else {
            const responseTime = metadata.execution_time || '';
            messageMeta.innerHTML = `
                <span>${timestamp}</span>
                ${responseTime ? `<span class="response-time">⚡ ${responseTime}</span>` : ''}
            `;
        }

        messageContent.appendChild(messageBubble);
        messageContent.appendChild(messageMeta);
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        chatMessages.appendChild(messageDiv);
        this.smoothScrollToBottom();
    }

    addCustomerResponseToChat(data) {
        this.addMessageToChatDisplay(data.response, 'ai', false, data);
        this.addSmartQuickActions(data);
    }

    addSmartQuickActions(data) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const quickActionDiv = document.createElement('div');
        quickActionDiv.className = 'smart-quick-actions-container';

        const quickActions = this.generateSmartQuickActions(data);

        quickActionDiv.innerHTML = `
            <div class="smart-quick-actions">
                <div class="quick-actions-header">
                    <span>💡 Quick Actions</span>
                </div>
                <div class="quick-actions-buttons">
                    ${quickActions.map(action => `
                        <button class="smart-quick-action-btn" onclick="${action.onclick}">
                            ${action.icon} ${action.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;

        chatMessages.appendChild(quickActionDiv);
        this.smoothScrollToBottom();
    }

    generateSmartQuickActions(data) {
        const actions = [];
        const queryType = data.query_type || 'general';

        if (this.userAuthenticated) {
            switch (queryType) {
                case 'order_analytics':
                    actions.push(
                        { icon: '📦', text: 'Track Another Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: '📋', text: 'View Order History', onclick: `customerPortal.sendCustomerMessage('Show my order history')` },
                        { icon: '🚚', text: 'Update Delivery Address', onclick: `customerPortal.sendCustomerMessage('Update my delivery address')` },
                        { icon: '💳', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` }
                    );
                    break;
                case 'customer_analysis':
                    actions.push(
                        { icon: '👤', text: 'Update Profile', onclick: `customerPortal.sendCustomerMessage('Update my profile')` },
                        { icon: '🔒', text: 'Account Security', onclick: `customerPortal.sendCustomerMessage('Account security settings')` },
                        { icon: '⭐', text: 'Upgrade Account', onclick: `customerPortal.sendCustomerMessage('How to upgrade my account tier')` },
                        { icon: '💼', text: 'Account Benefits', onclick: `customerPortal.sendCustomerMessage('What are my account benefits')` }
                    );
                    break;
                case 'product_performance':
                    actions.push(
                        { icon: '🏪', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: '📱', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: '👗', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: '💄', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` }
                    );
                    break;
                case 'revenue_insights':
                    actions.push(
                        { icon: '💳', text: 'Payment Methods', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept')` },
                        { icon: '🔄', text: 'Refund Request', onclick: `customerPortal.sendCustomerMessage('How to request a refund')` },
                        { icon: '📊', text: 'Spending History', onclick: `customerPortal.sendCustomerMessage('Show my spending history')` },
                        { icon: '💰', text: 'Payment Issues', onclick: `customerPortal.sendCustomerMessage('Help with payment issues')` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: '🛍️', text: 'Browse Products', onclick: `customerPortal.sendCustomerMessage('What products do you recommend')` },
                        { icon: '📦', text: 'Track Order', onclick: `customerPortal.sendCustomerMessage('Track my order')` },
                        { icon: '💳', text: 'Payment Help', onclick: `customerPortal.sendCustomerMessage('Help with payment')` },
                        { icon: '📞', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('Contact customer support')` }
                    );
            }
        } else {
            switch (queryType) {
                case 'product_performance':
                    actions.push(
                        { icon: '🏪', text: 'Browse More Products', onclick: `customerPortal.sendCustomerMessage('Browse your product catalog')` },
                        { icon: '📱', text: 'Electronics', onclick: `customerPortal.sendCustomerMessage('Show me electronics products')` },
                        { icon: '👗', text: 'Fashion', onclick: `customerPortal.sendCustomerMessage('Show me fashion items')` },
                        { icon: '💄', text: 'Beauty', onclick: `customerPortal.sendCustomerMessage('Show me beauty products')` },
                        { icon: '🔐', text: 'Login for Personal Shop', onclick: `window.location.href='/login'` }
                    );
                    break;
                default:
                    actions.push(
                        { icon: '🔐', text: 'Login', onclick: `window.location.href='/login'` },
                        { icon: '📝', text: 'Create Account', onclick: `customerPortal.sendCustomerMessage('How do I create an account?')` },
                        { icon: '🛍️', text: 'Explore Products', onclick: `customerPortal.sendCustomerMessage('What products do you offer?')` },
                        { icon: '📍', text: 'Delivery Areas', onclick: `customerPortal.sendCustomerMessage('What areas do you deliver to?')` },
                        { icon: '💳', text: 'Payment Options', onclick: `customerPortal.sendCustomerMessage('What payment methods do you accept?')` },
                        { icon: '📞', text: 'Contact Support', onclick: `customerPortal.sendCustomerMessage('How to contact customer support')` }
                    );
            }
        }

        return actions;
    }

    showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        this.removeTypingIndicator();

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="message-avatar">AI</div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span style="color: #6c757d; font-size: 12px;">raqibtech.com Assistant is typing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        `;

        chatMessages.appendChild(typingDiv);
        this.smoothScrollToBottom();
    }

    removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    smoothScrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }
    }

    async refreshConversationList() {
        try {
            const response = await fetch('/api/conversations');
            const data = await response.json();

            if (data.success) {
                this.updateConversationList(data.conversations);
            }
        } catch (error) {
            console.error('❌ Error refreshing conversation list:', error);
        }
    }

    updateConversationList(conversations) {
        const listContainer = document.getElementById('chatHistoryList');
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (conversations.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center text-muted p-3">
                    <i class="bi bi-chat-dots display-6 mb-2"></i>
                    <p class="mb-0 small">No chat history yet</p>
                    <small>Start a conversation!</small>
                </div>
            `;
            return;
        }

        conversations.forEach(conv => {
            const convElement = document.createElement('div');
            convElement.className = 'conversation-item';
            convElement.setAttribute('data-conversation-id', conv.conversation_id);

            convElement.innerHTML = `
                <div class="conversation-info" onclick="customerPortal.switchToConversation('${conv.conversation_id}')" style="flex: 1; cursor: pointer;">
                    <h6>${conv.title}</h6>
                    <small>${conv.message_count} messages</small>
                </div>
                <div class="conversation-actions">
                    <small class="text-muted">${new Date(conv.updated_at).toLocaleDateString()}</small>
                    <button class="btn btn-outline-danger btn-sm" onclick="customerPortal.deleteConversation('${conv.conversation_id}', event)"
                            title="Delete conversation">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;

            listContainer.appendChild(convElement);
        });
    }

    async deleteConversation(conversationId, event) {
        event.stopPropagation();

        if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/conversations/${conversationId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                console.log(`✅ Deleted conversation ${conversationId}`);

                if (conversationId === this.currentConversationId) {
                    this.currentConversationId = null;
                    window.currentConversationId = null;
                    this.displayWelcomeMessage();
                }

                this.refreshConversationList();
            } else {
                alert('Failed to delete conversation. Please try again.');
            }
        } catch (error) {
            console.error('❌ Error deleting conversation:', error);
            alert('Error deleting conversation. Please try again.');
        }
    }

    async switchToConversation(conversationId) {
        if (this.conversationLocked || conversationId === this.currentConversationId) {
            return;
        }

        this.conversationLocked = true;

        try {
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.isTyping = false;
            this.removeTypingIndicator();

            console.log(`🔄 Switching from conversation ${this.currentConversationId} to ${conversationId}`);

            this.currentConversationId = conversationId;
            window.currentConversationId = conversationId;

            const response = await fetch(`/api/conversations/${conversationId}/switch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                await this.loadConversationMessages(conversationId);

                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }

                console.log(`✅ Successfully switched to conversation ${conversationId}`);
            }
        } catch (error) {
            console.error('❌ Error switching conversation:', error);
        } finally {
            setTimeout(() => {
                this.conversationLocked = false;
            }, 500);
        }
    }

    async loadConversationMessages(conversationId) {
        try {
            this.isTyping = false;
            if (this.activeMessageRequest) {
                this.activeMessageRequest.abort();
                this.activeMessageRequest = null;
            }
            this.removeTypingIndicator();

            const response = await fetch(`/api/conversations/${conversationId}/messages`);
            const data = await response.json();

            if (conversationId !== this.currentConversationId) {
                console.warn('⚠️ Conversation changed during message loading');
                return;
            }

            if (data.success && data.messages) {
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                }

                data.messages.forEach(msg => {
                    const senderType = msg.sender_type === 'user' ? 'customer' : 'ai';
                    const metadata = msg.metadata || {};
                    this.addMessageToChatDisplay(msg.content, senderType, false, metadata);
                });

                console.log(`✅ Loaded ${data.messages.length} messages for conversation ${conversationId}`);
            }
        } catch (error) {
            console.error('❌ Error loading conversation messages:', error);
        }
    }

    displayWelcomeMessage() {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        this.isTyping = false;
        if (this.activeMessageRequest) {
            this.activeMessageRequest.abort();
            this.activeMessageRequest = null;
        }
        this.removeTypingIndicator();

        chatMessages.innerHTML = '';
        const welcomeHtml = this.createWelcomeMessage();
        chatMessages.innerHTML = welcomeHtml;
        this.smoothScrollToBottom();

        console.log('✅ Welcome message displayed in modal');
    }
}

// Global functions for compatibility and modal control
function toggleChatModal() {
    console.log('🖱️ Global toggleChatModal called');
    if (window.customerPortal) {
        window.customerPortal.toggleChatModal();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function openChatModal() {
    console.log('🖱️ Global openChatModal called');
    if (window.customerPortal) {
        window.customerPortal.openChatModal();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function closeChatModal(event) {
    console.log('🖱️ Global closeChatModal called');
    if (window.customerPortal) {
        window.customerPortal.closeChatModal(event);
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function toggleConversationSidebar() {
    console.log('🖱️ Global toggleConversationSidebar called');
    if (window.customerPortal) {
        window.customerPortal.toggleConversationSidebar();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function sendChatMessage() {
    console.log('🖱️ Global sendChatMessage called');
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function sendQuickMessage(message) {
    console.log(`🖱️ Global sendQuickMessage called: ${message}`);
    if (window.customerPortal) {
        // Open modal if not already open
        if (!window.customerPortal.modalOpen) {
            window.customerPortal.openChatModal();
        }
        // Wait for modal to open before sending message
        setTimeout(() => {
            window.customerPortal.sendCustomerMessage(message);
        }, 400);
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function trackOrderViaChat() {
    const orderIdInput = document.getElementById('orderIdInput');
    const orderId = orderIdInput?.value.trim();

    if (orderId) {
        sendQuickMessage(`Track my order ${orderId}`);
    } else {
        sendQuickMessage('Help me track my order');
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendChatMessage();
    }
}

async function createNewChat() {
    console.log('🆕 Creating new chat...');
    try {
        const response = await fetch('/api/conversations/new', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            console.log(`✅ New chat created: ${data.conversation_id}`);
            if (window.customerPortal) {
                await window.customerPortal.switchToConversation(data.conversation_id);
                await window.customerPortal.refreshConversationList();
            }
        }
    } catch (error) {
        console.error('❌ Error creating new chat:', error);
    }
}

async function switchToConversation(conversationId) {
    console.log(`🔄 Global switchToConversation called: ${conversationId}`);
    if (window.customerPortal) {
        await window.customerPortal.switchToConversation(conversationId);
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

// Initialize floating modal chat portal when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM loaded, initializing raqibtech.com Floating Modal Chat System');

    // Add small delay to ensure all elements are ready
    setTimeout(() => {
        try {
            window.customerPortal = new CustomerSupportPortal();

            const isAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
            const currentConversationId = '{{ current_conversation_id if current_conversation_id else '' }}';

            console.log(`🔍 Auth: ${isAuthenticated}, ConvID: ${currentConversationId}`);
            console.log('✅ Floating modal chat system ready!');

            // 🔧 DEBUG: Add click test for floating button
            const floatingBtn = document.getElementById('floatingChatBtn');
            if (floatingBtn) {
                console.log('✅ Floating button found and ready');

                // Test button interactivity
                floatingBtn.addEventListener('mouseenter', () => {
                    console.log('🖱️ Mouse entered floating button');
                });

                floatingBtn.addEventListener('mouseleave', () => {
                    console.log('🖱️ Mouse left floating button');
                });
            } else {
                console.error('❌ Floating button not found!');
            }

        } catch (error) {
            console.error('❌ Error initializing chat system:', error);
        }
    }, 200);
});

// 🔧 DEBUG: Window error handler
window.addEventListener('error', function(e) {
    console.error('❌ JavaScript Error:', e.error);
});

// 🔧 DEBUG: Check if modal is clickable
document.addEventListener('click', function(e) {
    if (e.target.id === 'floatingChatBtn' || e.target.closest('#floatingChatBtn')) {
        console.log('🖱️ Direct click detected on floating button');
    }
});

// 🔧 DEBUG: Test modal function
function debugTestModal() {
    console.log('🔧 DEBUG: Test modal function called');

    const modal = document.getElementById('chatModalOverlay');
    const button = document.getElementById('floatingChatBtn');

    if (!modal) {
        alert('❌ Modal element not found!');
        return;
    }

    if (!button) {
        alert('❌ Floating button not found!');
        return;
    }

    // Test 1: Check if elements exist
    console.log('✅ Modal and button elements found');

    // Test 2: Check button properties
    const buttonRect = button.getBoundingClientRect();
    const buttonStyles = window.getComputedStyle(button);
    console.log('🔍 Button position:', buttonRect);
    console.log('🔍 Button z-index:', buttonStyles.zIndex);
    console.log('🔍 Button pointer-events:', buttonStyles.pointerEvents);
    console.log('🔍 Button display:', buttonStyles.display);

    // Test 3: Check for overlapping elements
    const elementUnderButton = document.elementFromPoint(buttonRect.left + buttonRect.width/2, buttonRect.top + buttonRect.height/2);
    console.log('🔍 Element under button center:', elementUnderButton);

    if (elementUnderButton !== button) {
        console.warn('⚠️ Button might be blocked by:', elementUnderButton);
    }

    // Test 4: Try clicking floating button programmatically
    console.log('🔧 Testing floating button click...');
    try {
        button.click();
        console.log('✅ Floating button click successful');
    } catch (error) {
        console.error('❌ Floating button click failed:', error);
    }

    // Test 5: Try opening modal directly as backup
    modal.classList.add('active');
    button.classList.add('active');
    button.innerHTML = '<i class="bi bi-x-lg"></i>';

    // Test 6: Disable body scroll
    document.body.style.overflow = 'hidden';

    console.log('✅ Modal should be open now');
    alert('🔧 Debug Test Complete! Check console for detailed info.');
}

console.log('🔧 Modal debugging and event handlers loaded');
console.log('✅ Modal system loaded and ready');

// Global functions for compatibility and modal control
function handleModalClick(event) {
    event.stopPropagation();

    // Don't close sidebar if clicking on buttons, inputs, or interactive elements
    if (event.target.closest('button, input, a, .chat-modal-btn, .conversation-item')) {
        return;
    }

    // Don't close sidebar if clicking inside the sidebar itself
    if (event.target.closest('.conversation-sidebar')) {
        return;
    }

    // Close sidebar if clicking on empty areas of the modal
    if (window.customerPortal && window.customerPortal.sidebarOpen) {
        window.customerPortal.toggleConversationSidebar();
    }
}

function toggleChatModal() {
    console.log('🖱️ Global toggleChatModal called');
    if (window.customerPortal) {
        window.customerPortal.toggleChatModal();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function openChatModal() {
    console.log('🖱️ Global openChatModal called');
    if (window.customerPortal) {
        window.customerPortal.openChatModal();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function closeChatModal(event) {
    console.log('🖱️ Global closeChatModal called');
    if (window.customerPortal) {
        window.customerPortal.closeChatModal(event);
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function toggleConversationSidebar() {
    console.log('🖱️ Global toggleConversationSidebar called');
    if (window.customerPortal) {
        window.customerPortal.toggleConversationSidebar();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function sendChatMessage() {
    console.log('🖱️ Global sendChatMessage called');
    if (window.customerPortal) {
        window.customerPortal.sendCustomerMessage();
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function sendQuickMessage(message) {
    console.log(`🖱️ Global sendQuickMessage called: ${message}`);
    if (window.customerPortal) {
        // Open modal if not already open
        if (!window.customerPortal.modalOpen) {
            window.customerPortal.openChatModal();
        }
        // Wait for modal to open before sending message
        setTimeout(() => {
            window.customerPortal.sendCustomerMessage(message);
        }, 400);
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

function trackOrderViaChat() {
    const orderIdInput = document.getElementById('orderIdInput');
    const orderId = orderIdInput?.value.trim();

    if (orderId) {
        sendQuickMessage(`Track my order ${orderId}`);
    } else {
        sendQuickMessage('Help me track my order');
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendChatMessage();
    }
}

async function createNewChat() {
    console.log('🆕 Creating new chat...');
    try {
        const response = await fetch('/api/conversations/new', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            console.log(`✅ New chat created: ${data.conversation_id}`);
            if (window.customerPortal) {
                await window.customerPortal.switchToConversation(data.conversation_id);
                await window.customerPortal.refreshConversationList();
            }
        }
    } catch (error) {
        console.error('❌ Error creating new chat:', error);
    }
}

async function switchToConversation(conversationId) {
    console.log(`🔄 Global switchToConversation called: ${conversationId}`);
    if (window.customerPortal) {
        await window.customerPortal.switchToConversation(conversationId);
    } else {
        console.error('❌ CustomerPortal not initialized');
    }
}

// Initialize floating modal chat portal when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM loaded, initializing raqibtech.com Floating Modal Chat System');

    // Add small delay to ensure all elements are ready
    setTimeout(() => {
        try {
            window.customerPortal = new CustomerSupportPortal();

            const isAuthenticated = {{ 'true' if session.get('user_authenticated') else 'false' }};
            const currentConversationId = '{{ current_conversation_id if current_conversation_id else '' }}';

            console.log(`🔍 Auth: ${isAuthenticated}, ConvID: ${currentConversationId}`);
            console.log('✅ Floating modal chat system ready!');

            // 🔧 DEBUG: Add click test for floating button
            const floatingBtn = document.getElementById('floatingChatBtn');
            if (floatingBtn) {
                console.log('✅ Floating button found and ready');

                // Test button interactivity
                floatingBtn.addEventListener('mouseenter', () => {
                    console.log('🖱️ Mouse entered floating button');
                });

                floatingBtn.addEventListener('mouseleave', () => {
                    console.log('🖱️ Mouse left floating button');
                });
            } else {
                console.error('❌ Floating button not found!');
            }

        } catch (error) {
            console.error('❌ Error initializing chat system:', error);
        }
    }, 200);
});

// 🔧 DEBUG: Window error handler
window.addEventListener('error', function(e) {
    console.error('❌ JavaScript Error:', e.error);
});

// 🔧 DEBUG: Check if modal is clickable
document.addEventListener('click', function(e) {
    if (e.target.id === 'floatingChatBtn' || e.target.closest('#floatingChatBtn')) {
        console.log('🖱️ Direct click detected on floating button');
    }
});

// 🔧 DEBUG: Test modal function
function debugTestModal() {
    console.log('🔧 DEBUG: Test modal function called');

    const modal = document.getElementById('chatModalOverlay');
    const button = document.getElementById('floatingChatBtn');

    if (!modal) {
        alert('❌ Modal element not found!');
        return;
    }

    if (!button) {
        alert('❌ Floating button not found!');
        return;
    }

    // Test 1: Check if elements exist
    console.log('✅ Modal and button elements found');

    // Test 2: Check button properties
    const buttonRect = button.getBoundingClientRect();
    const buttonStyles = window.getComputedStyle(button);
    console.log('🔍 Button position:', buttonRect);
    console.log('🔍 Button z-index:', buttonStyles.zIndex);
    console.log('🔍 Button pointer-events:', buttonStyles.pointerEvents);
    console.log('🔍 Button display:', buttonStyles.display);

    // Test 3: Check for overlapping elements
    const elementUnderButton = document.elementFromPoint(buttonRect.left + buttonRect.width/2, buttonRect.top + buttonRect.height/2);
    console.log('🔍 Element under button center:', elementUnderButton);

    if (elementUnderButton !== button) {
        console.warn('⚠️ Button might be blocked by:', elementUnderButton);
    }

    // Test 4: Try clicking floating button programmatically
    console.log('🔧 Testing floating button click...');
    try {
        button.click();
        console.log('✅ Floating button click successful');
    } catch (error) {
        console.error('❌ Floating button click failed:', error);
    }

    // Test 5: Try opening modal directly as backup
    modal.classList.add('active');
    button.classList.add('active');
    button.innerHTML = '<i class="bi bi-x-lg"></i>';

    // Test 6: Disable body scroll
    document.body.style.overflow = 'hidden';

    console.log('✅ Modal should be open now');
    alert('🔧 Debug Test Complete! Check console for detailed info.');
}

console.log('🔧 Modal debugging and event handlers loaded');
console.log('✅ Modal system loaded and ready');
</script>
{% endblock %}
